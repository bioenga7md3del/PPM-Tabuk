<!-- partials/header.html -->
<header class="px-3 md:px-6 mt-3">
  <div class="topbar px-3 md:px-4 py-2 flex items-center justify-between rounded-xl">

    <!-- âœ… Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„Ø±ÙˆØ§Ø¨Ø· + Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… -->
    <nav id="mainNav" class="flex items-center gap-2 md:gap-3 text-white text-[15px] md:text-[16px] font-medium">
      <!-- Dashboard -->
      <a href="/PPM-Tabuk/modules/dashboard/index.html" data-to="dashboard"
         class="inline-flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/15">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/>
        </svg>
        <span>Dashboard</span>
      </a>

      <!-- Assets -->
      <a href="/PPM-Tabuk/modules/assets/index.html" data-to="assets"
         class="inline-flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/15">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 7l9-4 9 4-9 4-9-4z"/><path d="M21 7v8l-9 4-9-4V7"/>
        </svg>
        <span>Assets</span>
      </a>

      <!-- Preventive -->
      <a href="/PPM-Tabuk/modules/preventive/index.html" data-to="preventive"
         class="inline-flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/15">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2l7 4v5c0 5-3 9-7 11-4-2-7-6-7-11V6l7-4z"/><path d="M9 12l2 2 4-4"/>
        </svg>
        <span>Preventive</span>
      </a>

      <!-- Corrective (click dropdown) -->
      <div class="dd relative" data-dd="corrective">
        <button type="button" class="dd-btn inline-flex items-center gap-2 px-2 py-1 rounded-md">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14.7 6.3a4 4 0 1 0-5.4 5.4L3 18v3h3l6.3-6.3a4 4 0 0 0 5.4-5.4z"/>
          </svg>
          <span>Corrective</span>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div class="dd-panel card absolute mt-1 hidden z-20" role="menu" aria-hidden="true">
          <a class="dd-item px-3 py-2 hover:bg-slate-100 rounded" href="/PPM-Tabuk/modules/corrective/index.html?tab=ticket" data-to="corrective">
            <span>ğŸ“</span><span> Ticket</span>
          </a>
          <a class="dd-item px-3 py-2 hover:bg-slate-100 rounded" href="/PPM-Tabuk/modules/spares/index.html" data-to="spares">
            <span>âš™ï¸</span><span> SparePart</span>
          </a>
          <a class="dd-item px-3 py-2 hover:bg-slate-100 rounded" href="/PPM-Tabuk/modules/corrective/index.html?tab=wo" data-to="corrective">
            <span>ğŸ“„</span><span> WorkOrder</span>
          </a>
        </div>
      </div>

      <!-- Sites (hover dropdown; click navigates) -->
      <div class="dd relative" data-dd="sites">
        <a href="/PPM-Tabuk/modules/sites/index.html" class="inline-flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/15" data-to="sites">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 21s-6-5.3-6-10a6 6 0 1 1 12 0c0 4.7-6 10-6 10z"/><circle cx="12" cy="11" r="3"/>
          </svg>
          <span>Sites</span>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </a>
        <div class="dd-panel card absolute mt-1 hidden z-20" role="menu" aria-hidden="true">
          <a class="dd-item px-3 py-2 hover:bg-slate-100 rounded" href="/PPM-Tabuk/modules/sites/departments.html" data-to="sites">
            <span>ğŸ·ï¸</span><span> Department</span>
          </a>
          <a class="dd-item px-3 py-2 hover:bg-slate-100 rounded" href="/PPM-Tabuk/modules/sites/buildings.html" data-to="sites">
            <span>ğŸ¢</span><span> Building</span>
          </a>
          <a class="dd-item px-3 py-2 hover:bg-slate-100 rounded" href="/PPM-Tabuk/modules/sites/rooms.html" data-to="sites">
            <span>ğŸ </span><span> Rooms</span>
          </a>
        </div>
      </div>

      <!-- Users -->
      <a href="/PPM-Tabuk/modules/users/index.html" data-to="users"
         class="inline-flex items-center gap-2 px-2 py-1 rounded-md hover:bg-white/15">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <span>Users</span>
      </a>
    </nav>

    <!-- âœ… Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø«ÙŠÙ… + Logout -->
    <div class="flex items-center gap-2 md:gap-3 flex-row-reverse">
      <button id="btnLogout" class="px-3 py-1 rounded-lg bg-red-600 hover:bg-red-700 text-white">Logout</button>
      <button id="themeBtn" onclick="toggleTheme()" title="Toggle Theme"
        class="w-9 h-9 flex items-center justify-center rounded-lg bg-white/20 hover:bg-white/30 text-white shadow transition">ğŸŒ“</button>
      <a id="userName" class="font-semibold text-white hover:underline cursor-pointer"
         href="/PPM-Tabuk/modules/users/index.html#settings" title="User settings"></a>
      <span class="text-white/60">|</span>
    </div>

  </div>
</header>

<!-- ===== Script (module) Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© ===== -->
<script type="module">
  // âœ… Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Firebase app Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø¨Ø¯ÙˆÙ† initialize Ø¬Ø¯ÙŠØ¯)
  import { auth, db } from "/PPM-Tabuk/js/firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (hover Ù„Ù„Ù€SitesØŒ click Ù„Ù„Ù€Corrective)
  const initDropdowns = ()=>{
    document.querySelectorAll('.dd').forEach(dd=>{
      const panel = dd.querySelector('.dd-panel');
      const btn   = dd.querySelector('.dd-btn');
      if(!panel) return;

      if(dd.dataset.dd === 'sites'){
        dd.addEventListener('mouseenter', ()=> panel.classList.remove('hidden'));
        dd.addEventListener('mouseleave', ()=> panel.classList.add('hidden'));
      } else {
        // Corrective: click toggle
        btn?.addEventListener('click', ()=>{
          panel.classList.toggle('hidden');
        });
        document.addEventListener('click', (e)=>{
          if(!dd.contains(e.target)) panel.classList.add('hidden');
        });
      }
    });
  };

  // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù†Ø´Ø· (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·)
  const markActive = ()=>{
    const path = location.pathname.toLowerCase();
    const mark = (sel) => { const a = document.querySelector(sel); if (a) a.classList.add("active"); };

    if (path.includes("/dashboard/")) {
      mark('#mainNav a[data-to="dashboard"]');
    } else if (path.includes("/assets/")) {
      mark('#mainNav a[data-to="assets"]');
    } else if (path.includes("/preventive/")) {
      mark('#mainNav a[data-to="preventive"]');
    } else if (path.includes("/corrective/")) {
      mark('#mainNav .dd[data-dd="corrective"] .dd-btn');
    } else if (path.includes("/sites/")) {
      mark('#mainNav .dd[data-dd="sites"] > a[data-to="sites"]');
    } else if (path.includes("/users/")) {
      mark('#mainNav a[data-to="users"]');
    }
  };

  // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
  const wireLogout = ()=>{
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", async () => {
        try { await signOut(auth); } finally { location.replace("/PPM-Tabuk/login.html"); }
      });
    }
  };

  // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (nameEn -> name -> displayName -> email)
  const setUserName = (txt)=>{
    const el = document.getElementById("userName");
    if (el) el.textContent = txt || "";
  };

  // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  onAuthStateChanged(auth, async (user) => {
    if (!user) { location.replace("/PPM-Tabuk/login.html"); return; }
    try {
      const snap = await getDoc(doc(db, "users", user.uid));
      const name =
        (snap.exists() && (snap.data().nameEn || snap.data().name || snap.data().displayName)) ||
        user.displayName || user.email;
      setUserName(name);
    } catch (_) {
      setUserName(user.displayName || user.email || "");
    }
  });

  // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€Header
  initDropdowns();
  markActive();
  wireLogout();
</script>
