<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>
  <link rel="icon" href="/PPM-Tabuk/assets/favicon.ico"/>

  <style>
    #mainNav a.active{
      position:relative;font-weight:900;letter-spacing:.3px;
      background:linear-gradient(90deg,#60a5fa,#3b82f6,#60a5fa);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      animation:shimmer 3s linear infinite;
    }
    @keyframes shimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06)}
    .muted{color:#64748b}
    .inp{border:1px solid #e5e7eb;border-radius:12px;padding:.7rem .9rem;width:100%}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:12px;padding:.7rem 1rem;font-weight:700}
    .btn-primary{background:#2563eb;color:white}
    .btn-danger{background:#ef4444;color:white}
    .btn-soft{background:#f1f5f9}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .6rem;border-radius:999px;font-size:.75rem}
    .badge-green{background:rgba(16,185,129,.12);color:#047857}
    .kbd{border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:8px;padding:.05rem .45rem;background:#f8fafc}
    .table-kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.8rem;padding:.15rem .35rem;border:1px solid #e5e7eb;border-radius:6px;background:#f8fafc}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.45);z-index:60}
    .modal.show{display:flex}
    .modal .panel{width:min(720px,94vw)}
    .x{cursor:pointer}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div data-include="../../partials/header.html"></div>

  <section class="mx-auto max-w-7xl px-4 pt-6 pb-2">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-extrabold tracking-tight">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
        <p class="mt-1 text-sm text-slate-500">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù€ <b>Username + Password</b>. Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙ‚Ø·.</p>
      </div>
      <nav class="text-sm text-slate-500">
        <a href="/PPM-Tabuk/index.html" class="hover:underline">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <span class="mx-2">/</span>
        <span class="font-semibold text-slate-700">Users</span>
      </nav>
    </div>

    <div class="mt-4 flex flex-wrap gap-3">
      <button id="btnOpenAddUser" class="btn btn-primary">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
      <button id="btnOpenAddOwner" class="btn btn-danger" title="Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©">ğŸ‘‘ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="pageMsg" class="mt-3 text-sm"></div>
  </section>

  <main class="mx-auto max-w-7xl px-4 py-4 space-y-4">
    <!-- ÙÙ„Ø§ØªØ± -->
    <div class="card p-4">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="f_role" class="inp">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option>Admin</option><option>Supervisor</option><option>Staff</option>
            <option>Technician</option><option>DepartmentHead</option>
            <option>MaintenanceDeptSupervisor</option><option>WarehouseGuard</option>
            <option>SystemMonitor</option><option>SystemOwner</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="f_status" class="inp">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="active">Active</option>
            <option value="disabled">Disabled</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">SiteScope</label>
          <select id="f_siteSel" class="inp">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">DeptScope</label>
          <select id="f_deptSel" class="inp">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Ø¨Ø­Ø« (Ø§Ø³Ù…/ÙŠÙˆØ²Ø±Ù†ÙŠÙ…/Ø¥ÙŠÙ…ÙŠÙ„)</label>
          <input id="f_search" class="inp" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>
      </div>
      <div class="flex justify-end mt-3">
        <button id="btnRefresh" class="btn btn-soft">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card p-0 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50">
            <tr class="text-slate-600">
              <th class="px-4 py-3 text-start">Username</th>
              <th class="px-4 py-3 text-start">Name</th>
              <th class="px-4 py-3 text-start">Role</th>
              <th class="px-4 py-3 text-start">Email</th>
              <th class="px-4 py-3 text-start">Status</th>
              <th class="px-4 py-3 text-start">Created</th>
              <th class="px-4 py-3 text-start">Ø£ÙƒØ´Ù†Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between px-4 py-3 border-t">
        <div class="text-xs text-slate-500">ÙŠØ¹Ø±Ø¶ 20 ÙÙŠ Ø§Ù„ØµÙØ­Ø©</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn btn-soft">âŸµ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <span id="pageInfo" class="text-sm"></span>
          <button id="nextPage" class="btn btn-soft">Ø§Ù„ØªØ§Ù„ÙŠ âŸ¶</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Ù…ÙˆØ¯Ø§Ù„: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="modalUser" class="modal">
    <div class="panel card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <button class="x text-slate-500" data-close="modalUser">âœ•</button>
      </div>
      <form id="formUser" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
        <div>
          <label class="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="text-red-600">*</span></label>
          <input id="u_username" class="inp" placeholder="Ù…Ø«Ø§Ù„: m.ali" required>
          <p class="text-xs muted mt-1">Ù¤â€“Ù¢Ù¤ Ø­Ø±Ù/Ø±Ù‚Ù…/Ø´Ø±Ø·Ø©/Ø´Ø±Ø·Ø© Ø³ÙÙ„ÙŠØ© (EN).</p>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¯ÙˆØ± <span class="text-red-600">*</span></label>
          <select id="u_role" class="inp" required>
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
            <option>Admin</option><option>Supervisor</option><option>Staff</option>
            <option>Technician</option><option>DepartmentHead</option>
            <option>MaintenanceDeptSupervisor</option><option>WarehouseGuard</option>
            <option>SystemMonitor</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="text-red-600">*</span></label>
          <input id="u_password" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <div>
          <label class="block text-sm mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="text-red-600">*</span></label>
          <input id="u_password2" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm mb-1">SiteScope (Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±)</label>
          <select id="u_siteSel" class="inp" multiple size="5"></select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">DeptScope (Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±)</label>
          <select id="u_deptSel" class="inp" multiple size="5"></select>
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label>
          <input id="u_nameAr" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
        </div>
        <div>
          <label class="block text-sm mb-1">Name (English)</label>
          <input id="u_nameEn" class="inp" placeholder="Full Name (EN)">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="u_email" type="email" class="inp" placeholder="example@domain.com">
        </div>

        <div class="md:col-span-2 mt-2 flex gap-3">
          <button class="btn btn-primary" type="submit">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
          <button class="btn btn-soft" type="button" data-close="modalUser">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div class="md:col-span-2"><div id="u_msg" class="text-sm"></div></div>
      </form>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„: ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª -->
  <div id="modalEdit" class="modal">
    <div class="panel card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <button class="x text-slate-500" data-close="modalEdit">âœ•</button>
      </div>
      <form id="formEdit" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
        <input type="hidden" id="e_uid">
        <div>
          <label class="block text-sm mb-1">Username</label>
          <input id="e_username" class="inp" disabled>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="e_role" class="inp">
            <option>Admin</option><option>Supervisor</option><option>Staff</option>
            <option>Technician</option><option>DepartmentHead</option>
            <option>MaintenanceDeptSupervisor</option><option>WarehouseGuard</option>
            <option>SystemMonitor</option><option>SystemOwner</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm mb-1">SiteScope</label>
          <select id="e_siteSel" class="inp" multiple size="5"></select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">DeptScope</label>
          <select id="e_deptSel" class="inp" multiple size="5"></select>
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label>
          <input id="e_nameAr" class="inp">
        </div>
        <div>
          <label class="block text-sm mb-1">Name (English)</label>
          <input id="e_nameEn" class="inp">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="e_email" type="email" class="inp">
        </div>

        <div class="md:col-span-2 mt-2 flex gap-3">
          <button class="btn btn-primary" type="submit">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
          <button class="btn btn-soft" type="button" data-close="modalEdit">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div class="md:col-span-2"><div id="e_msg" class="text-sm"></div></div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "../../js/firebase.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      collection, getDocs, getDoc, setDoc, updateDoc, doc, serverTimestamp,
      query, where, limit, orderBy, startAfter
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const $ = id=>document.getElementById(id);
    const rxUser=/^[a-z0-9_-]{4,24}$/;
    const normalize = u=>(u||"").trim().toLowerCase();
    const synthEmail = u=>`${normalize(u)}@ppm.local`;
    const show=id=>$(id).classList.add("show");
    const hide=id=>$(id).classList.remove("show");

    document.querySelectorAll("[data-close]").forEach(b=>b.addEventListener("click", ()=>hide(b.dataset.close)));
    $("btnOpenAddUser").addEventListener("click", ()=>show("modalUser"));
    $("btnOpenAddOwner").addEventListener("click", ()=>show("modalOwner"));

    const pageMsg = $("pageMsg");

    // ====== ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… ======
    const siteSelects = ["u_siteSel","e_siteSel","f_siteSel"];
    const deptSelects = ["u_deptSel","e_deptSel","f_deptSel"];

    function labelOf(obj){
      // ÙŠØ­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ø³Ù… Ù…Ù† Ø­Ù‚ÙˆÙ„ Ù…Ø®ØªÙ„ÙØ©
      const candidates = [
        "name","label","title","site","siteName","site_name","site_code","code",
        "department","dept","deptName","departmentName","department_name"
      ];
      for (const k of candidates){
        if (obj && obj[k]) return String(obj[k]);
      }
      return "";
    }

    function uniqueSorted(arr){
      return [...new Set(arr.map(s=> String(s||"").trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ar'));
    }

    async function fetchSitesList(){
      let list = [];
      // 1) Ù…Ù† collection('sites')
      try{
        const s = await getDocs(collection(db,"sites"));
        s.forEach(d=> list.push(labelOf({ ...d.data(), id:d.id })));
      }catch(_){}
      // 2) fallback: Ù…Ù† assets
      if (list.length===0){
        try{
          const s = await getDocs(collection(db,"assets"));
          s.forEach(d=>{
            const data=d.data();
            const guess = data?.site || data?.siteName || data?.site_name || data?.site_code || data?.siteCode || data?.site_id;
            if (guess) list.push(String(guess));
          });
        }catch(_){}
      }
      return uniqueSorted(list);
    }

    async function fetchDeptsList(){
      let list = [];
      // 1) Ù…Ù† collection('departments')
      try{
        const s = await getDocs(collection(db,"departments"));
        s.forEach(d=> list.push(labelOf({ ...d.data(), id:d.id })));
      }catch(_){}
      // 2) fallback: Ù…Ù† assets
      if (list.length===0){
        try{
          const s = await getDocs(collection(db,"assets"));
          s.forEach(d=>{
            const data=d.data();
            const guess = data?.department || data?.dept || data?.deptName || data?.departmentName || data?.department_code;
            if (guess) list.push(String(guess));
          });
        }catch(_){}
      }
      return uniqueSorted(list);
    }

    function populateSelect(elId, items, {multiple=false, includeAll=false}={}){
      const el = $(elId);
      if(!el) return;
      el.innerHTML = "";
      if (includeAll) {
        const opt = document.createElement("option");
        opt.value = ""; opt.textContent = "Ø§Ù„ÙƒÙ„";
        el.appendChild(opt);
      }
      items.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v; opt.textContent = v;
        el.appendChild(opt);
      });
      if (multiple) el.setAttribute("multiple","multiple");
    }

    function getMultiValues(elId){
      const el = $(elId);
      return Array.from(el.selectedOptions).map(o=>o.value).filter(Boolean);
    }

    function setMultiValues(elId, values){
      const el = $(elId);
      const set = new Set((values||[]).map(v=>String(v)));
      Array.from(el.options).forEach(o=> o.selected = set.has(o.value));
    }

    async function loadLookups(){
      const [sites,depts] = await Promise.all([fetchSitesList(), fetchDeptsList()]);
      // Ù…Ù„Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„: multiple) â€” (ÙÙ„ØªØ±: single)
      populateSelect("u_siteSel", sites, {multiple:true});
      populateSelect("u_deptSel", depts, {multiple:true});
      populateSelect("e_siteSel", sites, {multiple:true});
      populateSelect("e_deptSel", depts, {multiple:true});
      populateSelect("f_siteSel", sites, {includeAll:true});
      populateSelect("f_deptSel", depts, {includeAll:true});
    }
    loadLookups().catch(e=>{ console.error(e); pageMsg.innerHTML='<span class="text-red-600">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Sites/Depts)</span>'; });

    // Ø§Ø®ØªÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    (async()=>{
      try{
        const snap = await getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1)));
        if (snap.size>0) $("btnOpenAddOwner").style.display="none";
      }catch(e){ pageMsg.innerHTML='<span class="text-red-600">ØªØ¹Ø°Ø± ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø§Ù„Ùƒ.</span>'; }
    })();

    async function isUsernameFree(username){
      const id=normalize(username);
      const d=await getDoc(doc(db,"usernames",id));
      return !d.exists();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…
    $("formUser").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg=$("u_msg"); msg.textContent="";
      const username=normalize($("u_username").value);
      const role=$("u_role").value;
      const email=$("u_email").value||null;
      const pwd=$("u_password").value;
      const pwd2=$("u_password2").value;
      const nameAr=$("u_nameAr").value||"";
      const nameEn=$("u_nameEn").value||"";
      const siteScope=getMultiValues("u_siteSel");
      const deptScope=getMultiValues("u_deptSel");

      if(!rxUser.test(username)){ msg.textContent="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­."; return; }
      if(!role){ msg.textContent="Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±."; return; }
      if(pwd!==pwd2){ msg.textContent="ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†."; return; }
      if(!(await isUsernameFree(username))){ msg.textContent="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¬ÙˆØ²."; return; }

      try{
        const cred=await createUserWithEmailAndPassword(auth, synthEmail(username), pwd);
        const uid=cred.user.uid;
        await setDoc(doc(db,"usernames",username), { uid, userId:uid, createdAt:serverTimestamp() });
        await setDoc(doc(db,"users",uid), {
          username, normalizedUsername:username, email,
          role, siteScope, deptScope, isActive:true,
          account:{ linked:true, status:"active", provider:"firebase", uid,
            lastLoginAt:null, forcePwdChange:true, lastPwdChangeAt:serverTimestamp(), passwordSetByAdmin:true },
          nameAr, nameEn, avatarUrl:null, locale:"ar", theme:"light",
          createdAt:serverTimestamp(), updatedAt:serverTimestamp(), notes:""
        });
        msg.textContent="ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… âœ…";
        hide("modalUser"); await loadPage(true);
      }catch(err){ console.error(err); msg.textContent="ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: "+(err?.message||err); }
    });

    // ===== Ø¬Ø¯ÙˆÙ„ + ÙÙ„Ø§ØªØ± + Pagination =====
    const tbody=$("usersTbody");
    const fRole=$("f_role"), fStatus=$("f_status"), fSiteSel=$("f_siteSel"), fDeptSel=$("f_deptSel"), fSearch=$("f_search");
    const btnRef=$("btnRefresh"), btnPrev=$("prevPage"), btnNext=$("nextPage"), pageInfo=$("pageInfo");
    const PAGE_SIZE=20; let cursors=[], page=0;

    const safe=(v,d="")=> (v===undefined||v===null)?d:v;
    const displayName=d=> safe(d.nameAr)||safe(d.nameEn)||safe(d.name)||"â€”";
    const displayUsername=d=> safe(d.username) || (safe(d.email).split("@")[0]||"â€”");
    const displayRole=d=> safe(d.role,"â€”");
    const displayEmail=d=> safe(d.email,"â€”");
    const displayStatus=d=>{
      if (d.account?.status) return d.account.status;
      if (typeof d.isActive==="boolean") return d.isActive? "active":"disabled";
      if (typeof d.enabled==="boolean") return d.enabled? "active":"disabled";
      return "â€”";
    };
    const displayCreated=d=>{
      const v=d.createdAt;
      try{ if(v?.toDate) return v.toDate().toLocaleString(); if(typeof v==="string") return v; }catch(_){}
      return "â€”";
    };

    function rowActionsHTML(id, data){
      const active = (displayStatus(data)==="active");
      return `
        <div class="flex gap-2">
          <button class="btn btn-soft" data-act="edit" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn ${active?'btn-danger':'btn-primary'}" data-act="toggle" data-id="${id}">
            ${active?'ØªØ¹Ø·ÙŠÙ„':'ØªÙØ¹ÙŠÙ„'}
          </button>
          <button class="btn btn-soft" data-act="reset" data-id="${id}">Reset Password</button>
        </div>`;
    }

    async function loadPage(reset=false){
      let qRef=query(collection(db,"users"), orderBy("createdAt","desc"));
      if(reset){ page=0; cursors=[]; }
      if(page>0 && cursors[page-1]) qRef=query(qRef, startAfter(cursors[page-1]));
      qRef=query(qRef, limit(PAGE_SIZE));

      const snap=await getDocs(qRef);
      const last=snap.docs[snap.docs.length-1]||null;
      cursors[page]=last;

      const term=fSearch.value.trim().toLowerCase();
      const r=fRole.value.trim().toLowerCase();
      const s=fStatus.value.trim().toLowerCase();
      const siteVal=fSiteSel.value.trim().toLowerCase();
      const deptVal=fDeptSel.value.trim().toLowerCase();

      let rows=snap.docs.map(d=>({ id:d.id, ...d.data() }));

      if(r) rows=rows.filter(x=> safe(x.role,"").toLowerCase()===r);
      if(s) rows=rows.filter(x=> displayStatus(x).toLowerCase()===s);
      if(siteVal) rows=rows.filter(x=> (Array.isArray(x.siteScope)?x.siteScope:[]).some(v=> String(v).toLowerCase()===siteVal));
      if(deptVal) rows=rows.filter(x=> (Array.isArray(x.deptScope)?x.deptScope:[]).some(v=> String(v).toLowerCase()===deptVal));
      if(term){
        rows=rows.filter(x=>{
          const hay=(displayName(x)+" "+displayUsername(x)+" "+displayEmail(x)).toLowerCase();
          return hay.includes(term);
        });
      }

      tbody.innerHTML = rows.map(r=>`
        <tr class="border-t align-top">
          <td class="px-4 py-3"><span class="table-kbd">${displayUsername(r)}</span></td>
          <td class="px-4 py-3">${displayName(r)}</td>
          <td class="px-4 py-3">${displayRole(r)}</td>
          <td class="px-4 py-3">${displayEmail(r)}</td>
          <td class="px-4 py-3">${displayStatus(r)}</td>
          <td class="px-4 py-3">${displayCreated(r)}</td>
          <td class="px-4 py-2">${rowActionsHTML(r.id, r)}</td>
        </tr>
      `).join("");

      pageInfo.textContent=`ØµÙØ­Ø© ${page+1}`;
      btnPrev.disabled=(page===0);
      btnNext.disabled=(rows.length<PAGE_SIZE || !last);
    }

    btnPrev.addEventListener("click", async()=>{ if(page>0){ page--; await loadPage(false); }});
    btnNext.addEventListener("click", async()=>{ page++; await loadPage(false); });
    btnRef.addEventListener("click", ()=> loadPage(true));
    let tt; fSearch.addEventListener("input", ()=>{ clearTimeout(tt); tt=setTimeout(()=>loadPage(true),300); });
    [fRole,fStatus,fSiteSel,fDeptSel].forEach(el=> el.addEventListener("change", ()=>loadPage(true)));
    loadPage(true).catch(e=>{ console.error(e); pageMsg.innerHTML='<span class="text-red-600">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</span>'; });

    // ===== Ø£ÙƒØ´Ù†Ø§Øª Ø§Ù„ØµÙ =====
    function openEditModal(row){
      $("e_uid").value=row.id;
      $("e_username").value=row.username||"";
      $("e_role").value=row.role||"";
      $("e_nameAr").value=row.nameAr||"";
      $("e_nameEn").value=row.nameEn||"";
      $("e_email").value=row.email||"";
      // Ø§Ø¶Ø¨Ø· Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù€ multi-select
      setMultiValues("e_siteSel", Array.isArray(row.siteScope)?row.siteScope:[]);
      setMultiValues("e_deptSel", Array.isArray(row.deptScope)?row.deptScope:[]);
      show("modalEdit");
    }

    function setMultiValues(elId, values){
      const el=$(elId);
      const set=new Set((values||[]).map(v=>String(v)));
      Array.from(el.options).forEach(o=> o.selected = set.has(o.value));
    }
    function getMultiValues(elId){
      const el=$(elId);
      return Array.from(el.selectedOptions).map(o=>o.value).filter(Boolean);
    }

    $("formEdit").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg=$("e_msg"); msg.textContent="";
      const uid=$("e_uid").value;
      const payload={
        role:$("e_role").value,
        nameAr:$("e_nameAr").value||"",
        nameEn:$("e_nameEn").value||"",
        email:$("e_email").value||null,
        siteScope:getMultiValues("e_siteSel"),
        deptScope:getMultiValues("e_deptSel"),
        updatedAt:serverTimestamp()
      };
      try{
        await updateDoc(doc(db,"users",uid), payload);
        msg.textContent="ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…";
        hide("modalEdit"); await loadPage(true);
      }catch(err){ console.error(err); msg.textContent="ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: "+(err?.message||err); }
    });

    async function toggleUser(uid, currentData){
      const active = (currentData.account?.status||"active")==="active";
      const newStatus = active ? "disabled" : "active";
      try{
        await updateDoc(doc(db,"users",uid), {
          isActive: !active,
          "account.status": newStatus,
          updatedAt: serverTimestamp()
        });
        await loadPage(false);
      }catch(err){ console.error(err); alert("ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«: "+(err?.message||err)); }
    }

    function generateTempPwd(len=10){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@$%*";
      let out=""; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    async function resetPassword(uid){
      const temp = generateTempPwd();
      try{
        await updateDoc(doc(db,"users",uid), {
          "account.forcePwdChange": true,
          notes: `TempPwd(${new Date().toISOString()}): ${temp}`,
          updatedAt: serverTimestamp()
        });
        alert("Temporary password (Ø³Ù„Ù‘Ù…Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§):\n\n"+temp+"\n\n*Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙØ¹Ù„ÙŠÙ‹Ø§ ÙÙŠ Auth Ù†Ø­ØªØ§Ø¬ Cloud Function*");
      }catch(err){ console.error(err); alert("ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«: "+(err?.message||err)); }
    }

    tbody.addEventListener("click", async (e)=>{
      const btn=e.target.closest("button[data-act]"); if(!btn) return;
      const id=btn.dataset.id, act=btn.dataset.act;
      const d=await getDoc(doc(db,"users",id)); if(!d.exists()){ alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }
      const data=d.data();
      if(act==="edit"){ openEditModal({id, ...data}); }
      if(act==="toggle"){ await toggleUser(id, data); }
      if(act==="reset"){ await resetPassword(id); }
    });
  </script>
</body>
</html>
