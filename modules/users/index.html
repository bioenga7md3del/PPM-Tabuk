<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • إدارة المستخدمين</title>

  <!-- Tailwind + Theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>

  <style>
    #mainNav a.active{
      position:relative;font-weight:900;letter-spacing:.3px;
      background:linear-gradient(90deg,#60a5fa,#3b82f6,#60a5fa);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      animation:shimmer 3s linear infinite;
    }
    @keyframes shimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06)}
    .muted{color:#64748b}
    .inp{border:1px solid #e5e7eb;border-radius:12px;padding:.7rem .9rem;width:100%}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:12px;padding:.7rem 1rem;font-weight:700}
    .btn-primary{background:#2563eb;color:white}
    .btn-danger{background:#ef4444;color:white}
    .btn-soft{background:#f1f5f9}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .6rem;border-radius:999px;font-size:.75rem}
    .badge-green{background:rgba(16,185,129,.12);color:#047857}
    .kbd{border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:8px;padding:.05rem .45rem;background:#f8fafc}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.45);z-index:60}
    .modal.show{display:flex}
    .modal .panel{width:min(680px,92vw)}
    .x{cursor:pointer}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- الهيدر الجاهز -->
  <div data-include="../../partials/header.html"></div>

  <!-- العنوان والشريط العلوي -->
  <section class="mx-auto max-w-7xl px-4 pt-6 pb-2">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-extrabold tracking-tight">إدارة المستخدمين</h1>
        <p class="mt-1 text-sm text-slate-500">أضف مستخدمين بنظام <b>Username + Password</b>، والإيميل للإشعارات فقط.</p>
      </div>
      <nav class="text-sm text-slate-500">
        <a href="/PPM-Tabuk/index.html" class="hover:underline">الرئيسية</a>
        <span class="mx-2">/</span>
        <span class="font-semibold text-slate-700">Users</span>
      </nav>
    </div>

    <!-- الأزرار الرئيسية -->
    <div class="mt-4 flex flex-wrap gap-3">
      <button id="btnOpenAddUser" class="btn btn-primary">
        ➕ إضافة مستخدم
      </button>

      <button id="btnOpenAddOwner" class="btn btn-danger" title="مرّة واحدة فقط عند التهيئة">
        👑 إضافة مالك النظام (System Owner)
      </button>
    </div>

    <!-- رسالة عامة -->
    <div id="pageMsg" class="mt-3 text-sm"></div>
  </section>

  <!-- مكان الجدول والفلاتر (نركّبه لاحقًا) -->
  <main class="mx-auto max-w-7xl px-4 py-4 space-y-4">
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <h2 class="font-bold">المستخدمون</h2>
        <div class="text-sm text-slate-500">الفلترة والصفحات سيتم تفعيلها لاحقًا.</div>
      </div>
      <div class="mt-3 p-6 border border-dashed border-slate-200 rounded-xl text-center text-slate-500">
        جاهز لإضافة جدول المستخدمين + الفلاتر + ترقيم الصفحات (20/صفحة). قلّي: <span class="kbd">كمّل الجدول</span>
      </div>
    </div>
  </main>

  <!-- مودال: إضافة مستخدم -->
  <div id="modalUser" class="modal">
    <div class="panel card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">إضافة مستخدم</h3>
        <button class="x text-slate-500" data-close="modalUser">✕</button>
      </div>
      <p class="text-xs muted mb-4">سيتم إنشاء حساب دخول بـ <b>username</b> + <b>password</b> (الإيميل إشعارات فقط).</p>

      <form id="formUser" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">اسم المستخدم <span class="text-red-600">*</span></label>
          <input id="u_username" class="inp" placeholder="مثال: m.ali" required>
          <p class="text-xs muted mt-1">٤–٢٤ حرف/رقم/شرطة/شرطة سفلية (EN).</p>
        </div>
        <div>
          <label class="block text-sm mb-1">الدور <span class="text-red-600">*</span></label>
          <select id="u_role" class="inp" required>
            <option value="" disabled selected>اختر الدور</option>
            <option>Admin</option>
            <option>Supervisor</option>
            <option>Staff</option>
            <option>Technician</option>
            <option>DepartmentHead</option>
            <option>MaintenanceDeptSupervisor</option>
            <option>WarehouseGuard</option>
            <option>SystemMonitor</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">كلمة المرور <span class="text-red-600">*</span></label>
          <input id="u_password" type="password" class="inp" placeholder="••••••••" required>
        </div>
        <div>
          <label class="block text-sm mb-1">تأكيد كلمة المرور <span class="text-red-600">*</span></label>
          <input id="u_password2" type="password" class="inp" placeholder="••••••••" required>
        </div>
        <div>
          <label class="block text-sm mb-1">الاسم (عربي)</label>
          <input id="u_nameAr" class="inp" placeholder="الاسم بالعربية">
        </div>
        <div>
          <label class="block text-sm mb-1">Name (English)</label>
          <input id="u_nameEn" class="inp" placeholder="Full Name (EN)">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">البريد الإلكتروني (اختياري للإشعارات)</label>
          <input id="u_email" type="email" class="inp" placeholder="example@domain.com">
        </div>
        <div class="md:col-span-2 flex items-center gap-3">
          <span class="badge badge-green">تفعيل الدخول تلقائي</span>
          <span class="badge">إجبار تغيير كلمة المرور عند أول دخول</span>
        </div>
        <div class="md:col-span-2 mt-2 flex gap-3">
          <button class="btn btn-primary" type="submit">حفظ المستخدم</button>
          <button class="btn btn-soft" type="button" data-close="modalUser">إلغاء</button>
        </div>
        <div class="md:col-span-2"><div id="u_msg" class="text-sm"></div></div>
      </form>
    </div>
  </div>

  <!-- مودال: إضافة System Owner -->
  <div id="modalOwner" class="modal">
    <div class="panel card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">إضافة مالك النظام (System Owner)</h3>
        <button class="x text-slate-500" data-close="modalOwner">✕</button>
      </div>
      <p class="text-xs muted mb-4">زر مخصص للتهيئة فقط — يُنشئ أول مالك للنظام باسم مستخدم وكلمة سر.</p>

      <form id="formOwner" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">اسم المستخدم <span class="text-red-600">*</span></label>
          <input id="o_username" class="inp" placeholder="مثال: owner" required>
        </div>
        <div>
          <label class="block text-sm mb-1">البريد الإلكتروني (اختياري)</label>
          <input id="o_email" type="email" class="inp" placeholder="example@domain.com">
        </div>
        <div>
          <label class="block text-sm mb-1">كلمة المرور <span class="text-red-600">*</span></label>
          <input id="o_password" type="password" class="inp" placeholder="••••••••" required>
        </div>
        <div>
          <label class="block text-sm mb-1">تأكيد كلمة المرور <span class="text-red-600">*</span></label>
          <input id="o_password2" type="password" class="inp" placeholder="••••••••" required>
        </div>
        <div>
          <label class="block text-sm mb-1">الاسم (عربي)</label>
          <input id="o_nameAr" class="inp" placeholder="الاسم بالعربية">
        </div>
        <div>
          <label class="block text-sm mb-1">Name (English)</label>
          <input id="o_nameEn" class="inp" placeholder="Full Name (EN)">
        </div>
        <div class="md:col-span-2 mt-2 flex gap-3">
          <span class="badge badge-green">الدور: SystemOwner</span>
          <span class="badge">النطاق: كافة المواقع</span>
        </div>
        <div class="md:col-span-2 mt-2 flex gap-3">
          <button class="btn btn-danger" type="submit">إنشاء System Owner</button>
          <button class="btn btn-soft" type="button" data-close="modalOwner">إلغاء</button>
        </div>
        <div class="md:col-span-2"><div id="o_msg" class="text-sm"></div></div>
      </form>
    </div>
  </div>

  <!-- منطق الصفحة -->
  <script type="module">
    // Firebase الموحد من مشروعك
    import { auth, db } from "../../js/firebase.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
    import {
      collection, getDocs, getDoc, setDoc, deleteDoc, doc, serverTimestamp, query, limit
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const pageMsg = $("pageMsg");

    const rxUser = /^[a-z0-9_-]{4,24}$/; // username policy
    const normalize = (u) => (u || "").trim().toLowerCase();
    const authEmail = (u) => `${normalize(u)}@ppm.local`;

    const show = (id) => $(id).classList.add("show");
    const hide = (id) => $(id).classList.remove("show");
    document.querySelectorAll("[data-close]").forEach(btn=>{
      btn.addEventListener("click", ()=> hide(btn.dataset.close));
    });

    // ===== UI Buttons =====
    $("btnOpenAddUser").addEventListener("click", ()=> show("modalUser"));
    $("btnOpenAddOwner").addEventListener("click", ()=> show("modalOwner"));

    // إخفاء زر إضافة المالك إذا كان موجودًا بالفعل
    async function toggleOwnerButton(){
      const snap = await getDocs(query(collection(db, "users"), limit(1)));
      // فحص أدق: هل يوجد SystemOwner تحديدًا؟
      let hasOwner = false;
      const all = await getDocs(collection(db,"users"));
      all.forEach(d => { if ((d.data().role || "") === "SystemOwner") hasOwner = true; });
      if(hasOwner) $("btnOpenAddOwner").style.display = "none";
    }
    toggleOwnerButton().catch(console.error);

    // ===== Firestore Utils =====
    async function isUsernameFree(username){
      const id = normalize(username);
      const d = await getDoc(doc(db,"usernames", id));
      return !d.exists();
    }

    async function reserveUsername(username, payload){
      const id = normalize(username);
      await setDoc(doc(db,"usernames", id), payload, { merge: false });
    }

    async function createUserDocument(uid, payload){
      await setDoc(doc(db,"users", uid), payload, { merge: false });
    }

    // ===== Forms: Add User =====
    $("formUser").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = $("u_msg");
      msg.textContent = "";

      const username = normalize($("u_username").value);
      const role = $("u_role").value;
      const email = $("u_email").value || null;
      const pwd = $("u_password").value;
      const pwd2 = $("u_password2").value;
      const nameAr = $("u_nameAr").value || "";
      const nameEn = $("u_nameEn").value || "";

      if(!rxUser.test(username)){ msg.textContent = "اسم المستخدم غير صالح."; return; }
      if(!role){ msg.textContent = "اختر الدور."; return; }
      if(pwd !== pwd2){ msg.textContent = "كلمتا المرور غير متطابقتين."; return; }

      // تأكد من تفرد اليوزرنيم
      if(!(await isUsernameFree(username))){ msg.textContent = "اسم المستخدم محجوز مسبقًا."; return; }

      try{
        // أنشئ حساب الدخول ببريد صناعي
        const cred = await createUserWithEmailAndPassword(auth, authEmail(username), pwd);
        const uid = cred.user.uid;

        // احجز اسم المستخدم
        await reserveUsername(username, { uid, userId: uid, createdAt: serverTimestamp() });

        // وثيقة اليوزر
        const payload = {
          username, normalizedUsername: username, email,
          role, siteScope: [], deptScope: [],
          isActive: true,
          account: {
            linked: true, status: "active", provider: "firebase",
            uid, lastLoginAt: null, forcePwdChange: true,
            lastPwdChangeAt: serverTimestamp(), passwordSetByAdmin: true
          },
          nameAr, nameEn, avatarUrl: null, locale: "ar", theme: "light",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp(), notes: ""
        };

        await createUserDocument(uid, payload);
        msg.textContent = "تم حفظ المستخدم بنجاح ✅";
        setTimeout(()=> hide("modalUser"), 600);
      }catch(err){
        console.error(err);
        msg.textContent = "تعذّر إنشاء المستخدم: " + (err?.message || err);
      }
    });

    // ===== Forms: Add System Owner =====
    $("formOwner").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = $("o_msg");
      msg.textContent = "";

      const username = normalize($("o_username").value);
      const email = $("o_email").value || null;
      const pwd = $("o_password").value;
      const pwd2 = $("o_password2").value;
      const nameAr = $("o_nameAr").value || "";
      const nameEn = $("o_nameEn").value || "";

      if(!rxUser.test(username)){ msg.textContent = "اسم المستخدم غير صالح."; return; }
      if(pwd !== pwd2){ msg.textContent = "كلمتا المرور غير متطابقتين."; return; }

      // تأكد ما فيش مالك أصلاً
      const all = await getDocs(collection(db,"users"));
      let hasOwner = false;
      all.forEach(d => { if ((d.data().role || "") === "SystemOwner") hasOwner = true; });
      if(hasOwner){ msg.textContent = "يوجد بالفعل مالك للنظام. هذا الزر للتـهيئة فقط."; return; }

      // تأكد من تفرد اليوزرنيم
      if(!(await isUsernameFree(username))){ msg.textContent = "اسم المستخدم محجوز مسبقًا."; return; }

      try{
        const cred = await createUserWithEmailAndPassword(auth, authEmail(username), pwd);
        const uid = cred.user.uid;

        await reserveUsername(username, { uid, userId: uid, createdAt: serverTimestamp() });

        const payload = {
          username, normalizedUsername: username, email,
          role: "SystemOwner", siteScope: ["*"], deptScope: ["*"],
          isActive: true,
          account: {
            linked: true, status: "active", provider: "firebase",
            uid, lastLoginAt: null, forcePwdChange: true,
            lastPwdChangeAt: serverTimestamp(), passwordSetByAdmin: true
          },
          nameAr, nameEn, avatarUrl: null, locale: "ar", theme: "light",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
          notes: "Bootstrap SystemOwner"
        };

        await createUserDocument(uid, payload);
        msg.textContent = "تم إنشاء مالك النظام بنجاح ✅";
        // أخفِ الزر بعد الإنشاء
        $("btnOpenAddOwner").style.display = "none";
        setTimeout(()=> hide("modalOwner"), 600);
      }catch(err){
        console.error(err);
        msg.textContent = "تعذّر إنشاء مالك النظام: " + (err?.message || err);
      }
    });
  </script>
</body>
</html>
