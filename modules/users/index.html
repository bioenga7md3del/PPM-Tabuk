<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • Bootstrap System Owner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#f8fafc;color:#0f172a}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 28px rgba(2,6,23,.06)}
    .inp{border:1px solid #e2e8f0;border-radius:10px;padding:.7rem .9rem;width:100%}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:10px;padding:.7rem 1rem;font-weight:700}
    .btn-primary{background:#2563eb;color:#fff}
    .muted{color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.4rem;border-radius:999px;padding:.25rem .7rem;font-size:.8rem}
    .ok{background:rgba(16,185,129,.12);color:#047857}
    .err{background:rgba(239,68,68,.12);color:#b91c1c}
    .kbd{border:1px solid #e2e8f0;border-bottom-width:2px;border-radius:8px;padding:.05rem .45rem;background:#f1f5f9}
  </style>
</head>
<body>
  <main class="mx-auto max-w-xl p-6">
    <h1 class="text-xl font-extrabold mb-2">تهيئة سريعة – System Owner</h1>
    <p class="muted text-sm mb-4">هنختبر الاتصال بـ Firebase وننشئ أول مالك نظام بيوزرنيم وباسورد.</p>

    <!-- حالة الاتصال -->
    <div class="card p-4 mb-4">
      <div id="conn" class="badge err">⏳ جاري فحص الاتصال...</div>
      <div id="connInfo" class="text-xs mt-2 muted"></div>
    </div>

    <!-- نموذج System Owner -->
    <div class="card p-5">
      <h2 class="font-bold mb-3">إنشاء System Owner</h2>
      <form id="formOwner" class="grid grid-cols-1 gap-3">
        <div>
          <label class="block text-sm mb-1">اسم المستخدم (EN) <span class="text-red-600">*</span></label>
          <input id="username" class="inp" placeholder="مثال: owner" required>
          <p class="text-xs muted mt-1">٤–٢٤ حرف/رقم/شرطة/شرطة سفلية. الدخول بيوزرنيم فقط.</p>
        </div>
        <div>
          <label class="block text-sm mb-1">كلمة المرور <span class="text-red-600">*</span></label>
          <input id="password" type="password" class="inp" placeholder="••••••••" required>
        </div>
        <div>
          <label class="block text-sm mb-1">تأكيد كلمة المرور <span class="text-red-600">*</span></label>
          <input id="password2" type="password" class="inp" placeholder="••••••••" required>
        </div>
        <div>
          <label class="block text-sm mb-1">البريد (اختياري للإشعارات)</label>
          <input id="email" type="email" class="inp" placeholder="example@domain.com">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">الاسم (عربي)</label>
            <input id="nameAr" class="inp" placeholder="الاسم بالعربية">
          </div>
          <div>
            <label class="block text-sm mb-1">Name (English)</label>
            <input id="nameEn" class="inp" placeholder="Full Name (EN)">
          </div>
        </div>

        <button class="btn btn-primary mt-1" type="submit">إنشاء System Owner</button>
        <div id="msg" class="text-sm mt-2"></div>
      </form>
    </div>
  </main>

  <script type="module">
    // ===== محاولة الاستيراد من ملف مشروعك + Fallback تلقائي =====
    let auth, db, source = "project-module";
    try {
      const mod = await import("../../js/firebase.js");
      auth = mod?.auth; db = mod?.db;
      console.log("Loaded from ../../js/firebase.js →", {auth, db});
      if (!auth || !db) throw new Error("auth/db undefined from project module");
    } catch (e) {
      console.warn("Fallback to inline Firebase config due to:", e);
      source = "inline-config";
      const { initializeApp, getApp, getApps } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
      const { getAuth } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js");
      const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
        authDomain: "pmqrtabuk.firebaseapp.com",
        projectId: "pmqrtabuk",
        storageBucket: "pmqrtabuk.firebasestorage.app",
        messagingSenderId: "305570616285",
        appId: "1:305570616285:web:4f6839fd08b8b5aa131c34"
      };
      const app = (getApps().length ? getApp() : initializeApp(firebaseConfig));
      auth = getAuth(app);
      db   = getFirestore(app);
    }

    // ===== UI helpers =====
    const $ = (id)=>document.getElementById(id);
    const rxUser = /^[a-z0-9_-]{4,24}$/;
    const normalize = (u)=> (u||"").trim().toLowerCase();
    const synthEmail = (u)=> `${normalize(u)}@ppm.local`;

    // ===== فحص الاتصال مع إشعار واضح =====
    import { collection, getDocs, query, limit, doc, getDoc, setDoc, serverTimestamp, where } 
      from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { createUserWithEmailAndPassword } 
      from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    async function checkFirebaseConnection(){
      const badge = $("conn");
      const info  = $("connInfo");
      try{
        await getDocs(query(collection(db,"users"), limit(1)));
        badge.classList.remove("err"); badge.classList.add("ok");
        badge.textContent = "✅ متصل بـ Firebase";
        info.textContent  = `source: ${source} • projectId: ${auth.app?.options?.projectId || "?"}`;
        console.log("Firebase connected ✓", { source, projectId: auth.app?.options?.projectId });
      }catch(e){
        badge.classList.remove("ok"); badge.classList.add("err");
        badge.textContent = "❌ غير متصل بـ Firebase";
        info.textContent  = "تحقق من authorized domains + Firestore Rules + network.";
        console.error("Firebase connection error:", e);
      }
    }
    checkFirebaseConnection();

    // ===== أدوات usernames/users =====
    async function isUsernameFree(username){
      const id = normalize(username);
      const ref = doc(db,"usernames", id);
      const snap = await getDoc(ref);
      return !snap.exists();
    }
    async function reserveUsername(username, payload){
      const id = normalize(username);
      await setDoc(doc(db,"usernames", id), payload, { merge:false });
    }
    async function createUserDoc(uid, payload){
      await setDoc(doc(db,"users", uid), payload, { merge:false });
    }

    // ===== إنشاء System Owner =====
    $("formOwner").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = $("msg");
      msg.textContent = "";

      const username = normalize($("username").value);
      const email    = $("email").value || null;
      const pwd      = $("password").value;
      const pwd2     = $("password2").value;
      const nameAr   = $("nameAr").value || "";
      const nameEn   = $("nameEn").value || "";

      if(!rxUser.test(username)){ msg.textContent = "❗ اسم المستخدم غير صالح."; return; }
      if(pwd !== pwd2){ msg.textContent = "❗ كلمتا المرور غير متطابقتين."; return; }

      // تأكد عدم وجود مالك
      try{
        const hasOwner = await getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1)));
        if (hasOwner.size > 0){ msg.textContent = "⚠️ يوجد بالفعل System Owner."; return; }
      }catch(_){ /* لو القواعد تمنع القراءة، هنعتمد على محاولة الإنشاء */ }

      if(!(await isUsernameFree(username))){ msg.textContent = "⚠️ اسم المستخدم محجوز."; return; }

      msg.textContent = "جارٍ الإنشاء...";
      try{
        const cred = await createUserWithEmailAndPassword(auth, synthEmail(username), pwd);
        const uid  = cred.user.uid;

        await reserveUsername(username, { uid, userId: uid, createdAt: serverTimestamp() });

        const payload = {
          username, normalizedUsername: username, email,
          role: "SystemOwner", siteScope: ["*"], deptScope: ["*"],
          isActive: true,
          account: {
            linked: true, status: "active", provider: "firebase", uid,
            lastLoginAt: null, forcePwdChange: true,
            lastPwdChangeAt: serverTimestamp(), passwordSetByAdmin: true
          },
          nameAr, nameEn, avatarUrl: null, locale: "ar", theme: "light",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
          notes: "Bootstrap SystemOwner"
        };
        await createUserDoc(uid, payload);

        msg.innerHTML = "✅ تم إنشاء <b>System Owner</b> — ادخل باسم المستخدم <span class='kbd'>"+username+"</span>";
      }catch(err){
        console.error(err);
        msg.textContent = "❌ تعذر الإنشاء: " + (err?.message || err);
      }
    });
  </script>
</body>
</html>
