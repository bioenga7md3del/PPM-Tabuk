<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>

  <!-- Tailwind + Theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>
  <link rel="icon" href="/PPM-Tabuk/assets/favicon.ico"/>

  <style>
    #mainNav a.active{
      position:relative;font-weight:900;letter-spacing:.3px;
      background:linear-gradient(90deg,#60a5fa,#3b82f6,#60a5fa);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      animation:shimmer 3s linear infinite;
    }
    @keyframes shimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06)}
    .muted{color:#64748b}
    .inp{border:1px solid #e5e7eb;border-radius:12px;padding:.7rem .9rem;width:100%}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:12px;padding:.7rem 1rem;font-weight:700}
    .btn-primary{background:#2563eb;color:white}
    .btn-danger{background:#ef4444;color:white}
    .btn-soft{background:#f1f5f9}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .6rem;border-radius:999px;font-size:.75rem}
    .badge-green{background:rgba(16,185,129,.12);color:#047857}
    .kbd{border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:8px;padding:.05rem .45rem;background:#f8fafc}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.45);z-index:60}
    .modal.show{display:flex}
    .modal .panel{width:min(680px,92vw)}
    .x{cursor:pointer}
    .table-kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.8rem; padding:.15rem .35rem; border:1px solid #e5e7eb; border-radius:6px; background:#f8fafc}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¬Ø§Ù‡Ø² -->
  <div data-include="../../partials/header.html"></div>

  <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± -->
  <section class="mx-auto max-w-7xl px-4 pt-6 pb-2">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-extrabold tracking-tight">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
        <p class="mt-1 text-sm text-slate-500">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù€ <b>Username + Password</b> â€” Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙ‚Ø·.</p>
      </div>
      <nav class="text-sm text-slate-500">
        <a href="/PPM-Tabuk/index.html" class="hover:underline">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <span class="mx-2">/</span>
        <span class="font-semibold text-slate-700">Users</span>
      </nav>
    </div>

    <div class="mt-4 flex flex-wrap gap-3">
      <button id="btnOpenAddUser" class="btn btn-primary">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
      <button id="btnOpenAddOwner" class="btn btn-danger" title="Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©">ğŸ‘‘ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù… (System Owner)</button>
    </div>

    <div id="pageMsg" class="mt-3 text-sm"></div>
  </section>

  <!-- ÙÙ„Ø§ØªØ± + Ø¬Ø¯ÙˆÙ„ + ØªØ±Ù‚ÙŠÙ… ØµÙØ­Ø§Øª -->
  <main class="mx-auto max-w-7xl px-4 py-4 space-y-4">
    <!-- ÙÙ„Ø§ØªØ± -->
    <div class="card p-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="f_role" class="inp">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option>Admin</option>
            <option>Supervisor</option>
            <option>Staff</option>
            <option>Technician</option>
            <option>DepartmentHead</option>
            <option>MaintenanceDeptSupervisor</option>
            <option>WarehouseGuard</option>
            <option>SystemMonitor</option>
            <option>SystemOwner</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Ø¨Ø­Ø« (Ø§Ø³Ù… / ÙŠÙˆØ²Ø±Ù†ÙŠÙ… / Ø¥ÙŠÙ…ÙŠÙ„)</label>
          <input id="f_search" class="inp" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>
        <div class="flex items-end">
          <button id="btnRefresh" class="btn btn-soft w-full">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card p-0 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50">
            <tr class="text-slate-600">
              <th class="px-4 py-3 text-start">Username</th>
              <th class="px-4 py-3 text-start">Name</th>
              <th class="px-4 py-3 text-start">Role</th>
              <th class="px-4 py-3 text-start">Email</th>
              <th class="px-4 py-3 text-start">Status</th>
              <th class="px-4 py-3 text-start">Created</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
      <!-- Pagination -->
      <div class="flex items-center justify-between px-4 py-3 border-t">
        <div class="text-xs text-slate-500">ÙŠØ¹Ø±Ø¶ 20 ÙÙŠ Ø§Ù„ØµÙØ­Ø©</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn btn-soft">âŸµ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <span id="pageInfo" class="text-sm"></span>
          <button id="nextPage" class="btn btn-soft">Ø§Ù„ØªØ§Ù„ÙŠ âŸ¶</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Ù…ÙˆØ¯Ø§Ù„: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="modalUser" class="modal">
    <div class="panel card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <button class="x text-slate-500" data-close="modalUser">âœ•</button>
      </div>
      <p class="text-xs muted mb-4">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙ‚Ø·).</p>

      <form id="formUser" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="text-red-600">*</span></label>
          <input id="u_username" class="inp" placeholder="Ù…Ø«Ø§Ù„: m.ali" required>
          <p class="text-xs muted mt-1">Ù¤â€“Ù¢Ù¤ Ø­Ø±Ù/Ø±Ù‚Ù…/Ø´Ø±Ø·Ø©/Ø´Ø±Ø·Ø© Ø³ÙÙ„ÙŠØ© (EN).</p>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¯ÙˆØ± <span class="text-red-600">*</span></label>
          <select id="u_role" class="inp" required>
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
            <option>Admin</option>
            <option>Supervisor</option>
            <option>Staff</option>
            <option>Technician</option>
            <option>DepartmentHead</option>
            <option>MaintenanceDeptSupervisor</option>
            <option>WarehouseGuard</option>
            <option>SystemMonitor</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="text-red-600">*</span></label>
          <input id="u_password" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <div>
          <label class="block text-sm mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="text-red-600">*</span></label>
          <input id="u_password2" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label>
          <input id="u_nameAr" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
        </div>
        <div>
          <label class="block text-sm mb-1">Name (English)</label>
          <input id="u_nameEn" class="inp" placeholder="Full Name (EN)">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="u_email" type="email" class="inp" placeholder="example@domain.com">
        </div>
        <div class="md:col-span-2 mt-2 flex gap-3">
          <span class="badge badge-green">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
          <span class="badge">Ø¥Ø¬Ø¨Ø§Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„</span>
        </div>
        <div class="md:col-span-2 mt-2 flex gap-3">
          <button class="btn btn-primary" type="submit">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
          <button class="btn btn-soft" type="button" data-close="modalUser">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div class="md:col-span-2"><div id="u_msg" class="text-sm"></div></div>
      </form>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„: Ø¥Ø¶Ø§ÙØ© System Owner -->
  <div id="modalOwner" class="modal">
    <div class="panel card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù… (System Owner)</h3>
        <button class="x text-slate-500" data-close="modalOwner">âœ•</button>
      </div>
      <p class="text-xs muted mb-4">ÙŠÙØ³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©.</p>

      <form id="formOwner" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="text-red-600">*</span></label>
          <input id="o_username" class="inp" placeholder="Ù…Ø«Ø§Ù„: owner" required>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="o_email" type="email" class="inp" placeholder="example@domain.com">
        </div>
        <div>
          <label class="block text-sm mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="text-red-600">*</span></label>
          <input id="o_password" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <div>
          <label class="block text-sm mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span class="text-red-600">*</span></label>
          <input id="o_password2" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label>
          <input id="o_nameAr" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
        </div>
        <div>
          <label class="block text-sm mb-1">Name (English)</label>
          <input id="o_nameEn" class="inp" placeholder="Full Name (EN)">
        </div>
        <div class="md:col-span-2 mt-2 flex gap-3">
          <span class="badge badge-green">Ø§Ù„Ø¯ÙˆØ±: SystemOwner</span>
          <span class="badge">Ø§Ù„Ù†Ø·Ø§Ù‚: ÙƒØ§ÙØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</span>
        </div>
        <div class="md:col-span-2 mt-2 flex gap-3">
          <button class="btn btn-danger" type="submit">Ø¥Ù†Ø´Ø§Ø¡ System Owner</button>
          <button class="btn btn-soft" type="button" data-close="modalOwner">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div class="md:col-span-2"><div id="o_msg" class="text-sm"></div></div>
      </form>
    </div>
  </div>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© -->
  <script type="module">
    // Firebase Ù…Ù† Ù…Ø´Ø±ÙˆØ¹Ùƒ
    import { auth, db } from "../../js/firebase.js";
    import { createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      collection, getDocs, getDoc, setDoc, deleteDoc, doc, serverTimestamp,
      query, where, limit, orderBy, startAfter
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const rxUser = /^[a-z0-9_-]{4,24}$/;
    const normalize = (u)=> (u||"").trim().toLowerCase();
    const synthEmail = (u)=> `${normalize(u)}@ppm.local`;
    const show = (id)=>$(id).classList.add("show");
    const hide = (id)=>$(id).classList.remove("show");
    document.querySelectorAll("[data-close]").forEach(b=>b.addEventListener("click", ()=> hide(b.dataset.close)));
    $("btnOpenAddUser").addEventListener("click", ()=> show("modalUser"));
    $("btnOpenAddOwner").addEventListener("click", ()=> show("modalOwner"));

    const pageMsg = $("pageMsg");

    // ===== Ø²Ø± SystemOwner ÙŠØ®ØªÙÙŠ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ =====
    async function toggleOwnerButton(){
      try{
        const snap = await getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1)));
        if (snap.size > 0) $("btnOpenAddOwner").style.display = "none";
      }catch(err){
        console.error(err);
        pageMsg.innerHTML = '<span class="text-red-600">ØªØ¹Ø°Ø± ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø§Ù„Ùƒ. Ø±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Firestore.</span>';
      }
    }
    toggleOwnerButton();

    // ===== util: usernames & users =====
    async function isUsernameFree(username){
      const id = normalize(username);
      const d = await getDoc(doc(db,"usernames", id));
      return !d.exists();
    }
    async function reserveUsername(username, payload){
      await setDoc(doc(db,"usernames", normalize(username)), payload, { merge:false });
    }
    async function createUserDoc(uid, payload){
      await setDoc(doc(db,"users", uid), payload, { merge:false });
    }

    // ===== Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ =====
    $("formUser").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = $("u_msg"); msg.textContent = "";

      const username = normalize($("u_username").value);
      const role     = $("u_role").value;
      const email    = $("u_email").value || null;
      const pwd      = $("u_password").value;
      const pwd2     = $("u_password2").value;
      const nameAr   = $("u_nameAr").value || "";
      const nameEn   = $("u_nameEn").value || "";

      if(!rxUser.test(username)) { msg.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­."; return; }
      if(!role) { msg.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±."; return; }
      if(pwd !== pwd2) { msg.textContent = "ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†."; return; }
      if(!(await isUsernameFree(username))) { msg.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¬ÙˆØ²."; return; }

      try{
        const cred = await createUserWithEmailAndPassword(auth, synthEmail(username), pwd);
        const uid = cred.user.uid;

        await reserveUsername(username, { uid, userId: uid, createdAt: serverTimestamp() });

        const payload = {
          username, normalizedUsername: username, email,
          role, siteScope: [], deptScope: [],
          isActive: true,
          account: {
            linked: true, status: "active", provider: "firebase",
            uid, lastLoginAt: null, forcePwdChange: true,
            lastPwdChangeAt: serverTimestamp(), passwordSetByAdmin: true
          },
          nameAr, nameEn, avatarUrl: null, locale: "ar", theme: "light",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp(), notes: ""
        };
        await createUserDoc(uid, payload);

        msg.textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…";
        setTimeout(()=> hide("modalUser"), 600);
        await loadPage(true);
      }catch(err){
        console.error(err);
        msg.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + (err?.message || err);
      }
    });

    // ===== Ø¥Ù†Ø´Ø§Ø¡ System Owner =====
    $("formOwner").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = $("o_msg"); msg.textContent = "";

      const username = normalize($("o_username").value);
      const email    = $("o_email").value || null;
      const pwd      = $("o_password").value;
      const pwd2     = $("o_password2").value;
      const nameAr   = $("o_nameAr").value || "";
      const nameEn   = $("o_nameEn").value || "";

      if(!rxUser.test(username)) { msg.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­."; return; }
      if(pwd !== pwd2) { msg.textContent = "ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†."; return; }

      try{
        const snap = await getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1)));
        if (snap.size > 0) { msg.textContent = "ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ø§Ù„Ùƒ Ù„Ù„Ù†Ø¸Ø§Ù…."; return; }
      }catch(err){
        console.error(err);
        msg.textContent = "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ (Rules).";
        return;
      }

      if(!(await isUsernameFree(username))) { msg.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¬ÙˆØ²."; return; }

      try{
        const cred = await createUserWithEmailAndPassword(auth, synthEmail(username), pwd);
        const uid = cred.user.uid;

        await reserveUsername(username, { uid, userId: uid, createdAt: serverTimestamp() });

        const payload = {
          username, normalizedUsername: username, email,
          role: "SystemOwner", siteScope: ["*"], deptScope: ["*"],
          isActive: true,
          account: {
            linked: true, status: "active", provider: "firebase",
            uid, lastLoginAt: null, forcePwdChange: true,
            lastPwdChangeAt: serverTimestamp(), passwordSetByAdmin: true
          },
          nameAr, nameEn, avatarUrl: null, locale: "ar", theme: "light",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
          notes: "Bootstrap SystemOwner"
        };
        await createUserDoc(uid, payload);

        msg.textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…";
        $("btnOpenAddOwner").style.display = "none";
        setTimeout(()=> hide("modalOwner"), 600);
        await loadPage(true);
      }catch(err){
        console.error(err);
        msg.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…: " + (err?.message || err);
      }
    });

    // ====== Ø¬Ø¯ÙˆÙ„ + ÙÙ„Ø§ØªØ± + Pagination (20/ØµÙØ­Ø©) ======
    const tbody   = $("usersTbody");
    const fRole   = $("f_role");
    const fSearch = $("f_search");
    const btnRef  = $("btnRefresh");
    const btnPrev = $("prevPage");
    const btnNext = $("nextPage");
    const pageInfo= $("pageInfo");
    const PAGE_SIZE = 20;

    let cursors = []; // Ø¢Ø®ÙØ± Ù…Ø³ØªÙ†Ø¯ Ù„ÙƒÙ„ ØµÙØ­Ø©
    let page = 0;

    function safe(v, def=""){ return (v===undefined || v===null) ? def : v; }
    function displayName(d){
      return safe(d.nameAr) || safe(d.nameEn) || safe(d.name) || "â€”";
    }
    function displayUsername(d){
      return safe(d.username) || (safe(d.email).split("@")[0] || "â€”");
    }
    function displayRole(d){ return safe(d.role,"â€”"); }
    function displayEmail(d){ return safe(d.email,"â€”"); }
    function displayStatus(d){
      if (d.account?.status) return d.account.status;
      if (typeof d.enabled === "boolean") return d.enabled ? "active" : "disabled";
      return "â€”";
    }
    function displayCreated(d){
      const v = d.createdAt;
      try{
        if (v?.toDate) return v.toDate().toLocaleString();
        if (typeof v === "string") return v;
      }catch(_){}
      return "â€”";
    }

    async function loadPage(reset=false){
      let qRef = query(collection(db,"users"), orderBy("createdAt","desc"));
      if (reset) { page = 0; cursors = []; }
      if (page > 0 && cursors[page-1]) qRef = query(qRef, startAfter(cursors[page-1]));
      qRef = query(qRef, limit(PAGE_SIZE));

      const snap = await getDocs(qRef);
      const last = snap.docs[snap.docs.length-1] || null;
      cursors[page] = last;

      const term = fSearch.value.trim().toLowerCase();
      const roleVal = fRole.value.trim().toLowerCase();

      let rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if (roleVal) rows = rows.filter(r => safe(r.role,"").toLowerCase() === roleVal);
      if (term) {
        rows = rows.filter(r=>{
          const hay = (displayName(r)+" "+displayUsername(r)+" "+displayEmail(r)).toLowerCase();
          return hay.includes(term);
        });
      }

      tbody.innerHTML = rows.map(r => `
        <tr class="border-t">
          <td class="px-4 py-3"><span class="table-kbd">${displayUsername(r)}</span></td>
          <td class="px-4 py-3">${displayName(r)}</td>
          <td class="px-4 py-3">${displayRole(r)}</td>
          <td class="px-4 py-3">${displayEmail(r)}</td>
          <td class="px-4 py-3">${displayStatus(r)}</td>
          <td class="px-4 py-3">${displayCreated(r)}</td>
        </tr>
      `).join("");

      pageInfo.textContent = `ØµÙØ­Ø© ${page+1}`;
      btnPrev.disabled = (page === 0);
      btnNext.disabled = (rows.length < PAGE_SIZE || !last);
    }

    btnPrev.addEventListener("click", async ()=>{ if(page>0){ page--; await loadPage(false); }});
    btnNext.addEventListener("click", async ()=>{ page++; await loadPage(false); });
    btnRef .addEventListener("click", ()=> loadPage(true));
    let t; fSearch.addEventListener("input", ()=>{ clearTimeout(t); t=setTimeout(()=> loadPage(true), 300); });
    fRole  .addEventListener("change", ()=> loadPage(true));

    // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
    loadPage(true).catch(err=>{
      console.error(err);
      pageMsg.innerHTML = '<span class="text-red-600">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†. Ø±Ø§Ø¬Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ùˆ Ø§Ù„ÙÙ‡Ø§Ø±Ø³.</span>';
    });
  </script>
</body>
</html>
