<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK ‚Ä¢ Add Equipment</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css"/>
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>

  <style>
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:1rem}
    .field{padding:.6rem .8rem;border:1px solid #cbd5e1;border-radius:.8rem}
    .btn{padding:.55rem .9rem;border-radius:.8rem;border:1px solid #cbd5e1;font-weight:600}
    .btn-brand{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn-brand:hover{background:#1d4ed8}
    .btn-ghost{background:transparent}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .hint{font-size:.8rem;color:#64748b}
    .grid-form{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:.75rem}
    @media (min-width:768px){.grid-form{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .chip{display:inline-flex;align-items:center;gap:.4rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:.25rem .6rem;font-size:.8rem}
    #aiModal.hidden{display:none}
  </style>
</head>
<body>

<!-- Header include -->
<header data-include="/PPM-Tabuk/partials/header.html?v=2"></header>

<main class="w-full max-w-6xl mx-auto p-4 space-y-4">

  <section class="flex items-center justify-between">
    <h1 class="text-xl font-bold">Add Equipment</h1>
    <div class="flex gap-2">
      <a href="index.html" class="btn">‚Üê Back</a>
      <button id="btnSave" class="btn btn-brand">üíæ Save</button>
    </div>
  </section>

  <!-- General -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">General</h2>
    <div class="grid-form">

      <!-- 1) ECRI Name + AI Assist -->
      <div>
        <label class="block mb-1">ECRI Name</label>
        <div class="flex gap-2">
          <select id="ecriName" class="field flex-1"></select>
          <button id="btnEcriAI" type="button" class="btn">ü§ñ AI Assist</button>
        </div>
        <p class="hint">Loaded from <b>ecri_catalog</b> (name + code). Use AI Assist to find the proper ECRI by description.</p>
      </div>

      <!-- 2) ECRI Code -->
      <div>
        <label class="block mb-1">ECRI Code</label>
        <input id="ecriCode" class="field mono" readonly placeholder="auto from catalog">
      </div>

      <!-- 3) Manufacturer -->
      <div>
        <label class="block mb-1">Manufacturer</label>
        <div class="flex gap-2">
          <select id="manufacturer" class="field flex-1"></select>
          <button id="addMaker" type="button" class="btn">+ New</button>
        </div>
      </div>

      <!-- 4) Model -->
      <div>
        <label class="block mb-1">Model</label>
        <div class="flex gap-2">
          <select id="model" class="field flex-1"></select>
          <button id="addModel" type="button" class="btn">+ New</button>
        </div>
      </div>

      <!-- 5) Serial -->
      <div>
        <label class="block mb-1">Serial Number</label>
        <input id="serial" class="field" placeholder="unique with manufacturer+model">
      </div>

      <!-- 13) Class -->
      <div>
        <label class="block mb-1">Device Class</label>
        <select id="devClass" class="field">
          <option value="">Select‚Ä¶</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>

      <!-- 14) Risk -->
      <div>
        <label class="block mb-1">Risk Level</label>
        <select id="risk" class="field">
          <option value="">Select‚Ä¶</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Normal">Normal</option>
          <option value="Critical">Critical</option>
        </select>
      </div>

      <!-- 15) Price -->
      <div>
        <label class="block mb-1">Price (SAR)</label>
        <input id="price" type="number" step="0.01" class="field" placeholder="e.g. 12500">
      </div>

      <!-- 16) Supplier -->
      <div>
        <label class="block mb-1">Supplier</label>
        <div class="flex gap-2">
          <select id="supplier" class="field flex-1"></select>
          <button id="addSupplier" type="button" class="btn">+ New</button>
        </div>
      </div>

      <!-- 17) Contract No. -->
      <div id="contractWrap" class="hidden">
        <label class="block mb-1">Maintenance Contract No.</label>
        <input id="contractNo" class="field" placeholder="only for Class A or B">
      </div>

    </div>
  </section>

  <!-- Location -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">Location & Control</h2>
    <div class="grid-form">
      <!-- 6) Site -->
      <div>
        <label class="block mb-1">Site</label>
        <select id="site" class="field"></select>
        <div class="hint">Site Code: <span id="siteCode" class="mono">‚Äî</span></div>
      </div>

      <!-- 7) Department (+ search) -->
      <div>
        <label class="block mb-1">Department</label>
        <select id="department" class="field"></select>
        <input id="departmentSearch" class="field mt-2" placeholder="Search departments...">
        <div class="hint">Dept Code: <span id="deptCode" class="mono">‚Äî</span></div>
      </div>

      <!-- 8) Room (+ search) -->
      <div>
        <label class="block mb-1">Room</label>
        <select id="room" class="field"></select>
        <input id="roomSearch" class="field mt-2" placeholder="Search rooms...">
      </div>

      <!-- 9) Control (auto) -->
      <div>
        <label class="block mb-1">Control Number</label>
        <input id="control" class="field mono" readonly placeholder="SITE/DEPT/###">
        <div class="hint">Generated per site as <b>SiteCode/DeptCode/seq</b>.</div>
      </div>
    </div>
  </section>

  <!-- Warranty & PM -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">Warranty & Preventive Maintenance</h2>
    <div class="grid-form">
      <!-- 10) Warranty -->
      <div>
        <label class="block mb-1">Warranty</label>
        <select id="warranty" class="field">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>

      <!-- Commissioning -->
      <div id="commissionWrap" class="hidden">
        <label class="block mb-1">Commissioning Date</label>
        <input id="commissionDate" type="date" class="field">
      </div>

      <!-- 11) PM Period -->
      <div>
        <label class="block mb-1">PM Period</label>
        <select id="pmPeriod" class="field">
          <option value="">Select‚Ä¶</option>
          <option value="12">Yearly</option>
          <option value="6">Semiannual</option>
          <option value="3">Quarterly</option>
          <option value="1">Monthly</option>
          <option value="0">Daily</option>
        </select>
      </div>

      <!-- 12) Last / Next PM -->
      <div>
        <label class="block mb-1">Last PM Date</label>
        <input id="lastPm" type="date" class="field">
      </div>
      <div>
        <label class="block mb-1">Next PM Date</label>
        <input id="nextPm" type="date" class="field" readonly>
      </div>
    </div>
    <p class="hint">Next PM is auto-calculated from period + last PM.</p>
  </section>

  <!-- Files -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">Files</h2>
    <div class="grid-form">
      <!-- Images (multiple) -->
      <div>
        <label class="block mb-1">Device Images</label>
        <input id="imgFiles" type="file" accept="image/*" class="field" multiple>
        <div id="imgList" class="mt-2 space-y-2"></div>
      </div>

      <!-- Documents (multiple) -->
      <div>
        <label class="block mb-1">Documents</label>
        <input id="docFiles" type="file" multiple class="field" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.png,.jpg,.jpeg">
        <div id="docList" class="mt-2 space-y-2"></div>
      </div>
    </div>
  </section>

</main>

<!-- ============ AI Assist Modal ============ -->
<div id="aiModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white w-full max-w-2xl rounded-xl p-4 space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">AI Assist ‚Äî Pick ECRI</h3>
      <button id="aiClose" class="btn">‚úï</button>
    </div>

    <label class="block mb-1">Describe the device</label>
    <textarea id="aiDesc" class="field w-full" rows="4"
      placeholder="Example: 2-channel ECG patient monitor with NIBP and SpO2..."></textarea>

    <div class="flex gap-2 items-center">
      <button id="aiSuggest" class="btn btn-brand">Get suggestions</button>
      <span id="aiStatus" class="hint"></span>
    </div>

    <div id="aiResults" class="space-y-2"></div>
  </div>
</div>

<script type="module">
  /* ===== project firebase ===== */
  import { auth, db } from "/PPM-Tabuk/js/firebase.js";

  /* extra SDKs */
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
  import {
    doc, getDoc, setDoc, collection, getDocs, query, where, orderBy,
    runTransaction, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const st = getStorage();

  /* ===== elements ===== */
  const $ = s => document.querySelector(s);
  const ecriName = $('#ecriName'), ecriCode = $('#ecriCode');
  const manufacturer = $('#manufacturer'), model = $('#model');
  const addMaker = $('#addMaker'), addModel = $('#addModel');
  const serial = $('#serial'), devClass = $('#devClass'), risk = $('#risk');
  const price = $('#price'), supplier = $('#supplier'), addSupplier = $('#addSupplier');
  const contractWrap = $('#contractWrap'), contractNo = $('#contractNo');

  const siteSel = $('#site'), deptSel = $('#department'), roomSel = $('#room');
  const siteCodeEl = $('#siteCode'), deptCodeEl = $('#deptCode'), control = $('#control');
  const depSearch = $('#departmentSearch'), roomSearch = $('#roomSearch');

  const warranty = $('#warranty'), commissionWrap = $('#commissionWrap'), commissionDate = $('#commissionDate');
  const pmPeriod = $('#pmPeriod'), lastPm = $('#lastPm'), nextPm = $('#nextPm');

  const imgFiles = $('#imgFiles'), docFiles = $('#docFiles');
  const imgList  = $('#imgList'),  docList  = $('#docList');
  const btnSave  = $('#btnSave');

  /* ===== AI modal elems ===== */
  const aiModal   = $('#aiModal'), aiClose = $('#aiClose');
  const aiDesc    = $('#aiDesc'), aiSuggest = $('#aiSuggest');
  const aiResults = $('#aiResults'); const aiStatus = $('#aiStatus');
  const btnEcriAI = $('#btnEcriAI');

  /* ===== caches ===== */
  let ECRI_CACHE = []; // {name, code}
  let DEPT_CACHE = []; // {id,name,code,siteId}
  let ROOM_CACHE = []; // {id,name,departmentId}

  /* ===== init ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.replace("../../login.html"); return; }

    await Promise.all([
      loadEcriCatalog(),
      loadManufacturers(),
      loadSuppliers(),
      loadSites()
    ]);

    bindUI();
  });

  function bindUI(){
    // ECRI mapping
    ecriName.addEventListener('change', ()=>{
      ecriCode.value = ecriName.selectedOptions[0]?.dataset.code || '';
    });

    // Contract show/hide
    devClass.addEventListener('change', ()=>{
      const v = devClass.value;
      contractWrap.classList.toggle('hidden', !(v==='A'||v==='B'));
    });

    // Warranty commissioning
    warranty.addEventListener('change', ()=> commissionWrap.classList.toggle('hidden', warranty.value!=='yes'));

    // PM calc
    [pmPeriod, lastPm].forEach(el=> el.addEventListener('change', calcNextPM));

    // Location flows
    siteSel.addEventListener('change', async ()=>{
      await loadDepartmentsForSite(siteSel.value);
      await loadRoomsForDept(deptSel.value);
      updateCodesPreview();
      // reset control view (it will be re-created on save)
      control.value = '';
    });
    deptSel.addEventListener('change', async ()=>{
      await loadRoomsForDept(deptSel.value);
      updateCodesPreview();
      control.value = '';
    });

    // Searchable selects
    attachSearchableSelect(deptSel, depSearch);
    attachSearchableSelect(roomSel, roomSearch);

    // Add refs
    addMaker.addEventListener('click', ()=> promptAddToRef('manufacturers', manufacturer));
    addModel.addEventListener('click', ()=> promptAddModel());
    addSupplier.addEventListener('click', ()=> promptAddToRef('suppliers', supplier));

    // Control field hard lock
    lockControlField();

    // Files UI (titles per file)
    imgFiles.addEventListener('change', renderFileTitles.bind(null, 'img'));
    docFiles.addEventListener('change', renderFileTitles.bind(null, 'doc'));

    // Save
    btnSave.addEventListener('click', onSave);

    // AI modal
    btnEcriAI?.addEventListener('click', ()=>{
      aiDesc.value = ''; aiResults.innerHTML = ''; aiStatus.textContent = '';
      aiModal.classList.remove('hidden'); aiModal.classList.add('flex');
      aiDesc.focus();
    });
    aiClose?.addEventListener('click', ()=> aiModal.classList.add('hidden'));
    aiModal?.addEventListener('click', e=>{ if(e.target===aiModal) aiModal.classList.add('hidden'); });
    aiSuggest?.addEventListener('click', onAISuggest);
  }

  /* ===== helpers ===== */
  function escapeHtml(s){return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

  function attachSearchableSelect(selectEl, inputEl){
    if(!selectEl || !inputEl) return;
    inputEl.addEventListener('input', ()=>{
      const q = inputEl.value.toLowerCase().trim();
      [...selectEl.options].forEach((o, idx)=>{
        if(idx===0) return; // placeholder
        const txt = (o.textContent||'').toLowerCase();
        o.hidden = q && !txt.includes(q);
      });
    });
  }

  function lockControlField(){
    control.setAttribute('readonly','readonly');
    control.setAttribute('tabindex','-1');
    ['keydown','beforeinput','paste'].forEach(ev=> control.addEventListener(ev, e=> e.preventDefault()));
  }

  function calcNextPM(){
    const m = parseInt(pmPeriod.value||'-1',10);
    const lp = lastPm.value;
    if(!lp || isNaN(m)){ nextPm.value=''; return; }
    const d = new Date(lp);
    if(m===0) d.setDate(d.getDate()+1); else d.setMonth(d.getMonth()+m);
    nextPm.value = d.toISOString().slice(0,10);
  }

  /* ===== reference data ===== */
  async function loadEcriCatalog(){
    const qs = await getDocs(collection(db,'ecri_catalog'));
    ECRI_CACHE = qs.docs.map(d=> d.data());
    const items = ECRI_CACHE.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    ecriName.innerHTML = '<option value="">Select device‚Ä¶</option>' +
      items.map(x=> `<option value="${escapeHtml(x.name)}" data-code="${escapeHtml(x.code||'')}">${escapeHtml(x.name)}</option>`).join('');
  }

  async function loadManufacturers(){
    const qs = await getDocs(collection(db,'refdata','lists','manufacturers'));
    const items = qs.docs.map(d=> d.id).sort();
    manufacturer.innerHTML = '<option value="">Select‚Ä¶</option>' + items.map(n=>`<option>${escapeHtml(n)}</option>`).join('');
  }
  async function loadModelsForMaker(maker){
    model.innerHTML = '<option value="">Select‚Ä¶</option>';
    if(!maker) return;
    const qs = await getDocs(collection(db,'refdata','manufacturers', maker, 'models'));
    const items = qs.docs.map(d=> d.id).sort();
    model.innerHTML += items.map(m=>`<option>${escapeHtml(m)}</option>`).join('');
  }
  manufacturer.addEventListener('change', ()=> loadModelsForMaker(manufacturer.value));

  async function loadSuppliers(){
    const qs = await getDocs(collection(db,'refdata','lists','suppliers'));
    const items = qs.docs.map(d=> d.id).sort();
    supplier.innerHTML = '<option value="">Select‚Ä¶</option>' + items.map(n=>`<option>${escapeHtml(n)}</option>`).join('');
  }

  async function loadSites(){
    const qs = await getDocs(query(collection(db,'sites'), orderBy('name')));
    const items = qs.docs.map(d=> ({ id:d.id, ...d.data() }));
    siteSel.innerHTML = '<option value="">Select site‚Ä¶</option>' +
      items.map(s=>`<option value="${escapeHtml(s.id)}" data-code="${escapeHtml(s.code||'')}">${escapeHtml(s.name||s.id)}</option>`).join('');
  }

  async function loadDepartmentsForSite(siteId){
    deptSel.innerHTML = '<option value="">Select department‚Ä¶</option>';
    roomSel.innerHTML = '<option value="">Select room‚Ä¶</option>';
    if(!siteId){ DEPT_CACHE = []; return; }

    const qs = await getDocs(query(collection(db,'departments'), where('siteId','==', siteId)));
    DEPT_CACHE = qs.docs.map(d=> ({ id:d.id, ...d.data() }))
                        .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    DEPT_CACHE.forEach(x=>{
      const opt = document.createElement('option');
      opt.value = x.id;
      opt.textContent = x.name || x.id;
      opt.dataset.code = x.code || '';
      deptSel.appendChild(opt);
    });
  }

  async function loadRoomsForDept(deptId){
    roomSel.innerHTML = '<option value="">Select room‚Ä¶</option>';
    if(!deptId){ ROOM_CACHE = []; return; }

    const qs = await getDocs(query(collection(db,'rooms'), where('departmentId','==', deptId)));
    ROOM_CACHE = qs.docs.map(d=> ({ id:d.id, ...d.data() }))
                        .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    ROOM_CACHE.forEach(x=>{
      const opt = document.createElement('option');
      opt.value = x.id;
      opt.textContent = x.name || x.id;
      roomSel.appendChild(opt);
    });
  }

  function updateCodesPreview(){
    siteCodeEl.textContent = siteSel.selectedOptions[0]?.dataset.code || '‚Äî';
    deptCodeEl.textContent = deptSel.selectedOptions[0]?.dataset.code || '‚Äî';
  }

  /* ===== add to ref lists ===== */
  async function promptAddToRef(listName, targetSelect){
    const v = prompt(`Add new ${listName.slice(0,-1)}:`); // "manufacturer" or "supplier"
    const name = (v||'').trim(); if(!name) return;
    await setDoc(doc(db,'refdata','lists', listName, name), { createdAt: serverTimestamp() }, { merge:true });
    if(listName==='manufacturers') await loadManufacturers();
    if(listName==='suppliers') await loadSuppliers();
    targetSelect.value = name;
  }

  async function promptAddModel(){
    const maker = manufacturer.value?.trim();
    if(!maker){ alert('Select manufacturer first'); return; }

    const v = prompt('Add new model:');
    const m = (v||'').trim(); if(!m) return;

    try{
      await setDoc(doc(db,'refdata','manufacturers', maker, 'models', m),
                   { createdAt: serverTimestamp() }, { merge:true });
      await loadModelsForMaker(maker);
      model.value = m;
      alert('Model added.');
    }catch(e){
      console.error(e);
      alert('Cannot add model: ' + (e.message||e));
    }
  }

  /* ===== files UI ===== */
  function renderFileTitles(kind){
    if(kind==='img'){
      imgList.innerHTML = '';
      [...imgFiles.files].forEach((f, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        row.innerHTML = `
          <span class="chip">${escapeHtml(f.name)}</span>
          <input class="field flex-1" data-type="img" data-idx="${idx}" placeholder="Image title (optional)">
        `;
        imgList.appendChild(row);
      });
    }else{
      docList.innerHTML = '';
      [...docFiles.files].forEach((f, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        row.innerHTML = `
          <span class="chip">${escapeHtml(f.name)}</span>
          <input class="field flex-1" data-type="doc" data-idx="${idx}" placeholder="Document title (optional)">
        `;
        docList.appendChild(row);
      });
    }
  }

  async function uploadFiles(controlNo){
    const images = [];
    const docs   = [];

    if(imgFiles.files.length){
      for(const [idx, f] of [...imgFiles.files].entries()){
        const titleInput = imgList.querySelector(`input[data-type="img"][data-idx="${idx}"]`);
        const title = titleInput?.value?.trim() || '';
        const r = sref(st, `equipment/${controlNo}/images/${f.name}`);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        images.push({ title, name: f.name, url, type: f.type || 'image' });
      }
    }

    if(docFiles.files.length){
      for(const [idx, f] of [...docFiles.files].entries()){
        const titleInput = docList.querySelector(`input[data-type="doc"][data-idx="${idx}"]`);
        const title = titleInput?.value?.trim() || '';
        const r = sref(st, `equipment/${controlNo}/docs/${f.name}`);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        docs.push({ title, name: f.name, url, type: f.type || 'file' });
      }
    }

    return { images, docs };
  }

  /* ===== uniqueness + control generation ===== */
  async function reserveUnique(p){
    const key = `${p.ecriCode}|${p.manufacturer}|${p.model}|${p.serial}`.toUpperCase();
    const uref = doc(db,'uniques','equipment', key);
    await runTransaction(db, async (tx)=>{
      const s = await tx.get(uref);
      if(s.exists()) throw new Error('Duplicate serial for this device/manufacturer/model.');
      tx.set(uref, { at: serverTimestamp() });
    });
  }

  async function generateControl(siteId, siteCode, deptCode){
    if(!siteId || !siteCode || !deptCode) throw new Error('Missing site/department code.');
    const cRef = doc(db,'counters','site', siteId); // counters/site/{siteId}
    let seq = 1;
    await runTransaction(db, async (tx)=>{
      const s = await tx.get(cRef);
      const cur = s.exists()? (s.data().next||1) : 1;
      seq = cur;
      tx.set(cRef, { next: cur+1 }, { merge:true });
    });
    return `${siteCode}/${deptCode}/${String(seq).padStart(3,'0')}`;
  }

  /* ===== collect + validate + save ===== */
  function collectPayload(){
    const so = siteSel.selectedOptions[0], doo = deptSel.selectedOptions[0];
    return {
      ecriName: ecriName.value || '',
      ecriCode: ecriCode.value || '',
      manufacturer: manufacturer.value || '',
      model: model.value || '',
      serial: serial.value || '',
      devClass: devClass.value || '',
      risk: risk.value || '',
      price: price.value ? Number(price.value) : null,
      supplier: supplier.value || '',
      contractNo: (devClass.value==='A'||devClass.value==='B') ? (contractNo.value||'') : '',
      siteId: siteSel.value || '',
      siteCode: so?.dataset.code || '',
      siteName: so?.textContent || '',
      departmentId: deptSel.value || '',
      deptCode: doo?.dataset.code || '',
      departmentName: doo?.textContent || '',
      roomId: roomSel.value || '',
      warranty: warranty.value || 'no',
      commissioningDate: (warranty.value==='yes' ? (commissionDate.value||'') : ''),
      pmPeriodMonths: pmPeriod.value===''? null : Number(pmPeriod.value),
      lastPm: lastPm.value || '',
      nextPm: nextPm.value || ''
    };
  }

  function validate(p){
    if(!p.ecriName || !p.ecriCode) throw new Error('Select ECRI name/code.');
    if(!p.manufacturer) throw new Error('Select manufacturer.');
    if(!p.model) throw new Error('Select model.');
    if(!p.serial) throw new Error('Serial is required.');
    if(!p.siteId || !p.siteCode) throw new Error('Select site.');
    if(!p.departmentId || !p.deptCode) throw new Error('Select department.');
    if(!p.devClass) throw new Error('Select class.');
    if((p.devClass==='A'||p.devClass==='B') && !p.contractNo) throw new Error('Enter contract number.');
    if(p.warranty==='yes' && !p.commissioningDate) throw new Error('Enter commissioning date.');
    if(p.pmPeriodMonths!==null && !p.lastPm) throw new Error('Enter last PM date.');
  }

  async function onSave(){
    try{
      const p = collectPayload();
      validate(p);
      await reserveUnique(p); // uniqueness key

      const controlNo = await generateControl(p.siteId, p.siteCode, p.deptCode);
      control.value = controlNo;

      const { images, docs } = await uploadFiles(controlNo);

      await setDoc(doc(db,'Equipment', controlNo), {
        ...p,
        control: controlNo,
        images,
        documents: docs,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });

      alert('Saved successfully.');
      location.href = 'index.html';
    }catch(e){
      console.error(e);
      alert('Error: '+(e.message||e));
    }
  }

  /* ===== AI Assist logic (local now, ready for Cloud Function) ===== */
  function localSuggest(description, limit=5){
    const q = (description||'').toLowerCase().trim();
    if(!q) return [];
    const scored = ECRI_CACHE.map(x=>{
      const name = (x.name||'').toLowerCase();
      let score = 0;
      if(name.includes(q)) score += 3;
      const parts = q.split(/\s+/).filter(Boolean);
      let hits = 0; parts.forEach(p=>{ if(name.includes(p)) hits++; });
      score += hits;
      if(name.startsWith(q)) score += 2;
      return {item:x, score};
    }).filter(s=> s.score>0)
      .sort((a,b)=> b.score - a.score)
      .slice(0, limit)
      .map(s=> s.item);
    return scored;
  }

  async function getEcriSuggestions(description){
    // Local (now)
    return localSuggest(description, 5);

    // Cloud Function (later):
    /*
    const res = await fetch('https://<cloud-function-url>/assistEcri', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ description })
    });
    const data = await res.json(); // [{name, code, reason?}]
    return data;
    */
  }

  function selectEcriByName(name, code){
    const opt = [...ecriName.options].find(o => (o.value||'').toLowerCase() === String(name||'').toLowerCase());
    if(opt) ecriName.value = opt.value;
    else {
      const o = document.createElement('option');
      o.value = name; o.textContent = name; o.dataset.code = code||'';
      ecriName.appendChild(o);
      ecriName.value = name;
    }
    ecriCode.value = code || '';
  }

  async function onAISuggest(){
    aiStatus.textContent = 'Thinking‚Ä¶';
    aiResults.innerHTML = '';
    try{
      if(!ECRI_CACHE.length) await loadEcriCatalog();
      const items = await getEcriSuggestions(aiDesc.value);
      aiStatus.textContent = items.length ? '' : 'No suggestions. Try another description.';
      items.forEach(x=>{
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between border rounded-lg p-2';
        row.innerHTML = `
          <div>
            <div class="font-semibold">${escapeHtml(x.name||'Unknown')}</div>
            <div class="text-xs text-slate-500">ECRI Code: <span class="mono">${escapeHtml(x.code||'-')}</span></div>
          </div>
          <button class="btn btn-brand">Use</button>
        `;
        row.querySelector('button').addEventListener('click', ()=>{
          selectEcriByName(x.name, x.code);
          aiModal.classList.add('hidden');
        });
        aiResults.appendChild(row);
      });
    }catch(e){
      console.error(e);
      aiStatus.textContent = 'Error.';
    }
  }
</script>
</body>
</html>
