<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK ‚Ä¢ Add Equipment</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css"/>
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>

  <style>
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:1rem}
    .field{padding:.6rem .8rem;border:1px solid #cbd5e1;border-radius:.8rem}
    .btn{padding:.55rem .9rem;border-radius:.8rem;border:1px solid #cbd5e1;font-weight:600}
    .btn-brand{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn-brand:hover{background:#1d4ed8}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .hint{font-size:.8rem;color:#64748b}
    .grid-form{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:.75rem}
    @media (min-width:768px){.grid-form{grid-template-columns:repeat(3,minmax(0,1fr))}}
    #aiModal.hidden{display:none}
    .dropzone{border:2px dashed #cbd5e1;border-radius:.75rem;padding:1rem}
    .dropzone.drag{background:#f8fafc}
  </style>
</head>
<body>

<header data-include="/PPM-Tabuk/partials/header.html?v=2"></header>

<main class="w-full max-w-6xl mx-auto p-4 space-y-4">

  <section class="flex items-center justify-between">
    <h1 class="text-xl font-bold">Add Equipment</h1>
    <div class="flex gap-2">
      <a href="index.html" class="btn">‚Üê Back</a>
      <button id="btnSave" class="btn btn-brand">üíæ Save</button>
    </div>
  </section>

  <!-- General -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">General</h2>
    <div class="grid-form">

      <!-- ECRI -->
      <div>
        <label class="block mb-1">ECRI Name</label>
        <div class="flex gap-2">
          <select id="ecriName" class="field flex-1"></select>
          <button id="btnEcriAI" type="button" class="btn">ü§ñ AI Assist</button>
        </div>
        <p class="hint">Loaded from <b>ecri_catalog</b> (name/code/search).</p>
      </div>

      <div>
        <label class="block mb-1">ECRI Code</label>
        <!-- ŸÇÿßÿ®ŸÑ ŸÑŸÑŸÉÿ™ÿßÿ®ÿ©: ŸÑŸà ŸÉÿ™ÿ®ÿ™ ŸÉŸàÿØÿå ŸáŸäÿ¨Ÿäÿ® ÿßŸÑÿßÿ≥ŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä -->
        <input id="ecriCode" class="field mono" placeholder="type code or auto from name">
      </div>

      <!-- Manufacturer / Model -->
      <div>
        <label class="block mb-1">Manufacturer</label>
        <div class="flex gap-2">
          <select id="manufacturer" class="field flex-1"></select>
          <button id="addMaker" type="button" class="btn">+ New</button>
        </div>
      </div>

      <div>
        <label class="block mb-1">Model</label>
        <div class="flex gap-2">
          <select id="model" class="field flex-1"></select>
          <button id="addModel" type="button" class="btn">+ New</button>
        </div>
      </div>

      <div>
        <label class="block mb-1">Serial Number</label>
        <input id="serial" class="field" placeholder="unique with manufacturer+model">
      </div>

      <div>
        <label class="block mb-1">Device Class</label>
        <select id="devClass" class="field">
          <option value="">Select‚Ä¶</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>

      <div>
        <label class="block mb-1">Risk Level</label>
        <select id="risk" class="field">
          <option value="">Select‚Ä¶</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Normal">Normal</option>
          <option value="Critical">Critical</option>
        </select>
      </div>

      <div>
        <label class="block mb-1">Price (SAR)</label>
        <input id="price" type="number" step="0.01" class="field" placeholder="e.g. 12500">
      </div>

      <div>
        <label class="block mb-1">Supplier</label>
        <div class="flex gap-2">
          <select id="supplier" class="field flex-1"></select>
          <button id="addSupplier" type="button" class="btn">+ New</button>
        </div>
      </div>

      <div id="contractWrap" class="hidden">
        <label class="block mb-1">Maintenance Contract No.</label>
        <input id="contractNo" class="field" placeholder="only for Class A or B">
      </div>

    </div>
  </section>

  <!-- Location -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">Location & Control</h2>
    <div class="grid-form">
      <div>
        <label class="block mb-1">Site</label>
        <select id="site" class="field"></select>
        <div class="hint">Site Code: <span id="siteCode" class="mono">‚Äî</span></div>
      </div>

      <div>
        <label class="block mb-1">Department</label>
        <div id="deptBox" class="relative"></div>
        <div class="hint">Dept Code: <span id="deptCode" class="mono">‚Äî</span></div>
      </div>

      <div>
        <label class="block mb-1">Room</label>
        <div id="roomBox" class="relative"></div>
      </div>

      <div>
        <label class="block mb-1">Control Number</label>
        <input id="control" class="field mono" readonly placeholder="SITE/DEPT/###">
        <div class="hint">Generated per site as <b>SiteCode/DeptCode/seq</b>.</div>
      </div>
    </div>
  </section>

  <!-- Warranty & PM -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">Warranty & PM</h2>
    <div class="grid-form">
      <div>
        <label class="block mb-1">Warranty</label>
        <select id="warranty" class="field">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>

      <div id="commissionWrap" class="hidden">
        <label class="block mb-1">Commissioning Date</label>
        <input id="commissionDate" type="date" class="field">
      </div>

      <div>
        <label class="block mb-1">PM Period</label>
        <select id="pmPeriod" class="field">
          <option value="">Select‚Ä¶</option>
          <option value="12">Yearly</option>
          <option value="6">Semiannual</option>
          <option value="3">Quarterly</option>
          <option value="1">Monthly</option>
          <option value="0">Daily</option>
        </select>
      </div>

      <div>
        <label class="block mb-1">Last PM Date</label>
        <input id="lastPm" type="date" class="field">
      </div>
      <div>
        <label class="block mb-1">Next PM Date</label>
        <input id="nextPm" type="date" class="field" readonly>
      </div>
    </div>
    <p class="hint">Next PM is auto-calculated from period + last PM.</p>
  </section>

  <!-- Docs & Photos -->
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">Documentation</h2>
    <div id="docRepeater" class="space-y-3"></div>
    <button id="addDocRow" type="button" class="btn">‚ûï Add Document</button>

    <h2 class="font-semibold text-slate-800 mt-6">Photos</h2>
    <div id="imgRepeater" class="space-y-3"></div>
    <button id="addImgRow" type="button" class="btn">‚ûï Add Photo</button>
  </section>

</main>

<!-- AI Assist Modal -->
<div id="aiModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white w-full max-w-2xl rounded-xl p-4 space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">AI Assist ‚Äî Pick ECRI</h3>
      <button id="aiClose" class="btn">‚úï</button>
    </div>

    <label class="block mb-1">Describe the device</label>
    <textarea id="aiDesc" class="field w-full" rows="4"
      placeholder="Example: 2-channel ECG patient monitor with NIBP and SpO2..."></textarea>

    <div class="flex gap-2 items-center">
      <button id="aiSuggest" class="btn btn-brand">Get suggestions</button>
      <span id="aiStatus" class="hint"></span>
    </div>

    <div id="aiResults" class="space-y-2"></div>
  </div>
</div>

<script type="module">
  /* ===== firebase boot ===== */
  import { auth, db } from "/PPM-Tabuk/js/firebase.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
  import {
    doc, getDoc, setDoc, collection, getDocs, addDoc, query, where, orderBy,
    runTransaction, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  const st = getStorage();

  /* ===== elements ===== */
  const $ = s => document.querySelector(s);
  const ecriName = $('#ecriName'), ecriCode = $('#ecriCode');
  const manufacturer = $('#manufacturer'), model = $('#model');
  const addMaker = $('#addMaker'), addModel = $('#addModel');
  const serial = $('#serial'), devClass = $('#devClass'), risk = $('#risk');
  const price = $('#price'), supplier = $('#supplier'), addSupplier = $('#addSupplier');
  const contractWrap = $('#contractWrap'), contractNo = $('#contractNo');

  const siteSel = $('#site'); const siteCodeEl = $('#siteCode');
  const deptBox = document.getElementById('deptBox');
  const roomBox = document.getElementById('roomBox');
  const deptCodeEl = $('#deptCode'); const control = $('#control');

  const warranty = $('#warranty'), commissionWrap = $('#commissionWrap'), commissionDate = $('#commissionDate');
  const pmPeriod = $('#pmPeriod'), lastPm = $('#lastPm'), nextPm = $('#nextPm');

  const btnSave  = $('#btnSave');

  const docRepeater = document.getElementById('docRepeater');
  const addDocRow   = document.getElementById('addDocRow');
  const imgRepeater = document.getElementById('imgRepeater');
  const addImgRow   = document.getElementById('addImgRow');

  /* caches */
  let ECRI_CACHE = [];   // {id, code, name, search}
  let DEPT_CACHE = [];   // {id(code), name, siteName}
  let ROOM_CACHE = [];   // {id, name, departmentCode}
  let deptSelValue = ''; let roomSelValue = '';

  /* header hooks after include */
  document.addEventListener("partials:loaded", () => {
    document.getElementById("btnLogout")?.addEventListener("click", async () => {
      try { await signOut(auth); } finally { location.replace("../../login.html"); }
    });
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.replace("../../login.html"); return; }

    // user name in header
    try{
      const us = await getDoc(doc(db,'users', user.uid));
      const name = us.exists() ? (us.data().name || us.data().nameEn || user.email) : user.email;
      const el = document.getElementById('userName'); if(el) el.textContent = name;
    }catch{}

    await Promise.all([
      loadEcriCatalog(),
      loadManufacturers(),
      loadSuppliers(),
      loadSites()
    ]);

    bindUI();
  });

  function escapeHtml(s){return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

  /* ===== ECRI catalog ===== */
  async function loadEcriCatalog(){
    const qs = await getDocs(collection(db,'ecri_catalog'));
    ECRI_CACHE = qs.docs.map(d=> ({ id:d.id, ...d.data() }));
    const items = ECRI_CACHE.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    ecriName.innerHTML = '<option value="">Select device‚Ä¶</option>' +
      items.map(x=> `<option value="${escapeHtml(x.name)}" data-code="${escapeHtml(x.code||'')}">${escapeHtml(x.name)}</option>`).join('');
  }

  // ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖ ‚Üí ÿπÿ®ŸëŸä ÿßŸÑŸÉŸàÿØ
  ecriName.addEventListener('change', ()=>{
    ecriCode.value = ecriName.selectedOptions[0]?.dataset.code || '';
  });
  // ŸÉÿ™ÿ®ÿ™ ÿßŸÑŸÉŸàÿØ ‚Üí ÿßÿÆÿ™ÿßÿ± ÿßŸÑÿßÿ≥ŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä
  ecriCode.addEventListener('input', ()=>{
    const code = (ecriCode.value||'').trim();
    if(!code) return;
    const m = ECRI_CACHE.find(x=> String(x.code) === code);
    if(m){
      // set option (ÿ£Ÿà ÿ£ÿ∂ŸÅ ŸÑŸà ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ)
      let opt = [...ecriName.options].find(o=> (o.value||'').toLowerCase() === String(m.name||'').toLowerCase());
      if(!opt){
        opt = document.createElement('option');
        opt.value = m.name; opt.textContent = m.name; opt.dataset.code = m.code;
        ecriName.appendChild(opt);
      }
      ecriName.value = m.name;
    }
  });

  /* ===== refdata: manufacturers/models/suppliers ===== */
  async function loadManufacturers(){
    const qs = await getDocs(collection(db,'refdata','lists','manufacturers'));
    const items = qs.docs.map(d=> d.id).sort();
    manufacturer.innerHTML = '<option value="">Select‚Ä¶</option>' + items.map(n=>`<option>${escapeHtml(n)}</option>`).join('');
  }
  async function loadModelsForMaker(maker){
    model.innerHTML = '<option value="">Select‚Ä¶</option>';
    if(!maker) return;
    const qs = await getDocs(collection(db,'refdata','lists','manufacturers', maker, 'models'));
    const items = qs.docs.map(d=> d.id).sort();
    model.innerHTML += items.map(m=>`<option>${escapeHtml(m)}</option>`).join('');
  }
  manufacturer.addEventListener('change', ()=> loadModelsForMaker(manufacturer.value));

  async function loadSuppliers(){
    const qs = await getDocs(collection(db,'refdata','lists','suppliers'));
    const items = qs.docs.map(d=> d.id).sort();
    supplier.innerHTML = '<option value="">Select‚Ä¶</option>' + items.map(n=>`<option>${escapeHtml(n)}</option>`).join('');
  }

  async function promptAddToRef(kind, selectEl){
    const val = prompt(`Add new ${kind.slice(0,-1)} name:`)?.trim();
    if(!val) return;
    const ref = doc(db,'refdata','lists', kind, val);
    await setDoc(ref, { createdAt: serverTimestamp() }, { merge:true });
    // reload
    if(kind==='manufacturers') await loadManufacturers();
    if(kind==='suppliers') await loadSuppliers();
    // select it
    const opt = [...selectEl.options].find(o=>o.value===val);
    if(opt) selectEl.value = val;
  }
  async function promptAddModel(){
    const maker = manufacturer.value;
    if(!maker){ alert('Choose a manufacturer first.'); return; }
    const val = prompt('Add new model for '+maker+':')?.trim();
    if(!val) return;
    const ref = doc(db,'refdata','lists','manufacturers', maker, 'models', val);
    await setDoc(ref, { createdAt: serverTimestamp() }, { merge:true });
    await loadModelsForMaker(maker);
    const opt = [...model.options].find(o=>o.value===val); if(opt) model.value = val;
  }
  addMaker.addEventListener('click', ()=> promptAddToRef('manufacturers', manufacturer));
  addSupplier.addEventListener('click', ()=> promptAddToRef('suppliers', supplier));
  addModel.addEventListener('click', promptAddModel);

  /* ===== Sites / Departments / Rooms ===== */
  async function loadSites(){
    const qs = await getDocs(query(collection(db,'sites'), orderBy('name')));
    const items = qs.docs.map(d=> ({ id:d.id, ...d.data() }));
    siteSel.innerHTML = '<option value="">Select site‚Ä¶</option>' +
      items.map(s=>`<option value="${escapeHtml(s.id)}" data-code="${escapeHtml(s.code||'')}">${escapeHtml(s.name||s.id)}</option>`).join('');
  }

  // lightweight searchable select
  function createSearchSelect({container, placeholder='Type to search', data=[], getLabel, getValue, onChange}){
    container.innerHTML = `
      <div class="field flex items-center justify-between gap-2 cursor-text">
        <input class="flex-1 bg-transparent outline-none" placeholder="${placeholder}" />
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
      </div>
      <div class="absolute z-50 mt-1 w-full card p-1 max-h-64 overflow-auto hidden"></div>
    `;
    const input = container.querySelector('input');
    const panel = container.querySelector('.card');
    let cur = null;
    function render(list){
      panel.innerHTML = '';
      list.forEach(item=>{
        const a = document.createElement('button');
        a.type='button'; a.className='w-full text-left px-3 py-2 rounded hover:bg-slate-100';
        a.textContent = getLabel(item);
        a.addEventListener('click', ()=>{
          cur = getValue(item); input.value = getLabel(item);
          panel.classList.add('hidden'); onChange?.(cur,item);
        });
        panel.appendChild(a);
      });
      if(list.length===0) panel.innerHTML = '<div class="px-3 py-2 text-slate-500 text-sm">No results</div>';
    }
    function open(){ panel.classList.remove('hidden'); }
    function close(){ panel.classList.add('hidden'); }
    function filtered(){
      const q = input.value.trim().toLowerCase();
      if(!q) return data.slice(0,200);
      return data.filter(x=> getLabel(x).toLowerCase().includes(q));
    }
    input.addEventListener('focus', ()=>{ open(); render(filtered()); });
    input.addEventListener('input', ()=>{ open(); render(filtered()); });
    document.addEventListener('click', e=>{ if(!container.contains(e.target)) close(); });

    return {
      setData(newData){ data=newData||[]; render(filtered()); },
      setValue(v){ cur=v; const it=data.find(d=>getValue(d)===v); input.value=it?getLabel(it):''; },
      getValue(){ return cur; }
    };
  }

  let deptSS=null, roomSS=null;

  async function loadDepartmentsForSite(){
    if(!deptSS){
      deptSS = createSearchSelect({
        container: deptBox,
        placeholder: 'Type to search departments‚Ä¶',
        data: [],
        getLabel: d => d.name || d.id,
        getValue: d => d.id,
        onChange: (val, item)=>{
          deptSelValue = val; deptCodeEl.textContent = item?.code || val;
          loadRoomsForDept(val);
        }
      });
    }
    if(!roomSS){
      roomSS = createSearchSelect({
        container: roomBox,
        placeholder: 'Type to search rooms‚Ä¶',
        data: [],
        getLabel: r => r.name || r.id,
        getValue: r => r.id,
        onChange: (val)=>{ roomSelValue = val; }
      });
    }

    deptSS.setData([]); deptSS.setValue(null);
    roomSS.setData([]); roomSS.setValue(null);
    deptSelValue=''; roomSelValue=''; deptCodeEl.textContent='‚Äî';

    const siteName = siteSel.selectedOptions[0]?.textContent?.trim() || '';
    siteCodeEl.textContent = siteSel.selectedOptions[0]?.dataset.code || '‚Äî';
    if(!siteName) return;

    let qs = await getDocs(query(collection(db,'department'), where('siteName','==', siteName)));
    if(qs.empty){
      const siteCode = siteSel.selectedOptions[0]?.dataset.code || '';
      if(siteCode){
        qs = await getDocs(query(collection(db,'department'), where('siteCode','==', siteCode)));
      }
    }
    DEPT_CACHE = qs.docs.map(d=> ({
      id: d.id, name: d.data().name || d.id, code: d.id, siteName
    })).sort((a,b)=> (a.name||'').localeCompare(b.name||''));

    deptSS.setData(DEPT_CACHE);
  }

  async function loadRoomsForDept(deptCode){
    roomSS.setData([]); roomSS.setValue(null); roomSelValue='';
    if(!deptCode) return;
    const qs = await getDocs(query(collection(db,'room'), where('departmentCode','==', deptCode)));
    ROOM_CACHE = qs.docs.map(d=> ({ id:d.id, name:d.data().name||d.id, departmentCode:deptCode }))
      .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    roomSS.setData(ROOM_CACHE);
  }

  siteSel.addEventListener('change', async ()=>{
    await loadDepartmentsForSite();
    control.value='';
  });

  /* ===== Docs/Photos Repeaters ===== */
  const DOC_GROUPS = ['PM Report','Calibration Certificate','User Manual','Service Manual','Acceptance Report','Warranty Card','Other','ÿ£ŸÖÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°','ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ®ŸÜŸÉŸä','ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä'];

  function makeDropZone(){
    const el = document.createElement('div');
    el.className = 'dropzone';
    el.innerHTML = `
      <div class="text-sm">
        Drop files to attach, or
        <label class="text-blue-600 underline cursor-pointer">browse
          <input type="file" multiple class="hidden">
        </label>
      </div>
      <div class="mt-2 space-y-1 text-sm" data-list></div>
    `;
    const input = el.querySelector('input[type=file]');
    const list  = el.querySelector('[data-list]');
    function addFiles(files){
      [...files].forEach(f=>{
        const row = document.createElement('div');
        row.textContent = `${f.name} ‚Äî ${(f.size/1024).toFixed(1)} KB`;
        list.appendChild(row);
      });
    }
    el.addEventListener('dragover', e=>{ e.preventDefault(); el.classList.add('drag'); });
    el.addEventListener('dragleave', ()=> el.classList.remove('drag'));
    el.addEventListener('drop', e=>{
      e.preventDefault(); el.classList.remove('drag');
      addFiles(e.dataTransfer.files);
      const dt = new DataTransfer();
      [...input.files, ...e.dataTransfer.files].forEach(f=> dt.items.add(f));
      input.files = dt.files;
    });
    input.addEventListener('change', ()=> addFiles(input.files));
    return { root: el, input };
  }

  function createSearchBox(list){
    const wrap = document.createElement('div');
    wrap.innerHTML = `<div class="relative"></div>`;
    const ss = createSearchSelect({
      container: wrap.firstElementChild,
      placeholder: 'Type to search',
      data: list.map(x=>({label:x, val:x})),
      getLabel: x=>x.label, getValue:x=>x.val
    });
    return {wrap, ss, input: wrap.querySelector('input')};
  }

  function addDocRepeaterRow(){
    const row = document.createElement('div');
    row.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 items-start';
    const groupCol = document.createElement('div');
    groupCol.innerHTML = `<label class="block mb-1">Document Group</label>`;
    const sb = createSearchBox(DOC_GROUPS);
    groupCol.appendChild(sb.wrap); row.appendChild(groupCol);

    const dzCol = document.createElement('div');
    dzCol.innerHTML = `<label class="block mb-1">Documentation</label>`;
    const dz = makeDropZone(); dzCol.appendChild(dz.root); row.appendChild(dzCol);

    const delCol = document.createElement('div');
    delCol.className='flex items-start justify-end';
    delCol.innerHTML=`<button type="button" class="btn">üóëÔ∏è</button>`;
    delCol.firstElementChild.addEventListener('click', ()=> row.remove());
    row.appendChild(delCol);

    row.__dzInput = dz.input; row.__groupInput = sb.input;
    docRepeater.appendChild(row);
  }
  function addImgRepeaterRow(){
    const row = document.createElement('div');
    row.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 items-start';
    const titleCol = document.createElement('div');
    titleCol.innerHTML = `<label class="block mb-1">Title</label><input class="field" placeholder="Image title (optional)">`;
    const titleInput = titleCol.querySelector('input'); row.appendChild(titleCol);

    const dzCol = document.createElement('div');
    dzCol.innerHTML = `<label class="block mb-1">Image Files</label>`;
    const dz = makeDropZone(); dzCol.appendChild(dz.root); row.appendChild(dzCol);

    const delCol = document.createElement('div');
    delCol.className='flex items-start justify-end';
    delCol.innerHTML=`<button type="button" class="btn">üóëÔ∏è</button>`;
    delCol.firstElementChild.addEventListener('click', ()=> row.remove());
    row.appendChild(delCol);

    row.__dzInput = dz.input; row.__titleInput = titleInput;
    imgRepeater.appendChild(row);
  }
  addDocRow.addEventListener('click', addDocRepeaterRow);
  addImgRow.addEventListener('click', addImgRepeaterRow);
  addDocRepeaterRow(); addImgRepeaterRow();

  async function uploadFiles(controlNo){
    const images = []; const documents = [];
    for(const r of [...docRepeater.children]){
      const input = r.__dzInput; const group = r.__groupInput?.value?.trim() || 'Other';
      if(input?.files?.length){
        for(const f of input.files){
          const ref = sref(st, `equipment/${controlNo}/docs/${f.name}`);
          await uploadBytes(ref, f); const url = await getDownloadURL(ref);
          documents.push({ group, name:f.name, size:f.size, url, type:f.type||'file' });
        }
      }
    }
    for(const r of [...imgRepeater.children]){
      const input = r.__dzInput; const title = r.__titleInput?.value?.trim() || '';
      if(input?.files?.length){
        for(const f of input.files){
          const ref = sref(st, `equipment/${controlNo}/images/${f.name}`);
          await uploadBytes(ref, f); const url = await getDownloadURL(ref);
          images.push({ title, name:f.name, size:f.size, url, type:f.type||'image' });
        }
      }
    }
    return { images, documents };
  }

  /* ===== PM / Warranty ===== */
  function calcNextPM(){
    const m = parseInt(pmPeriod.value||'-1',10);
    const lp = lastPm.value; if(!lp || isNaN(m)){ nextPm.value=''; return; }
    const d = new Date(lp); if(m===0) d.setDate(d.getDate()+1); else d.setMonth(d.getMonth()+m);
    nextPm.value = d.toISOString().slice(0,10);
  }
  warranty.addEventListener('change', ()=> commissionWrap.classList.toggle('hidden', warranty.value!=='yes'));
  [pmPeriod, lastPm].forEach(el=> el.addEventListener('change', calcNextPM));
  devClass.addEventListener('change', ()=> contractWrap.classList.toggle('hidden', !(devClass.value==='A'||devClass.value==='B')));

  /* ===== uniqueness + control generation ===== */
  async function reserveUnique(p){
    const key = `${p.ecriCode}|${p.manufacturer}|${p.model}|${p.serial}`.toUpperCase();
    const uref = doc(db,'uniques','equipment', key);
    await runTransaction(db, async (tx)=>{
      const s = await tx.get(uref);
      if(s.exists()) throw new Error('Duplicate serial for this device/manufacturer/model.');
      tx.set(uref, { at: serverTimestamp() });
    });
  }

  async function getMaxSeqForSite(siteCode){
    let max = 0;
    const qs = await getDocs(query(collection(db,'Equipment'), where('siteCode','==', siteCode)));
    qs.forEach(d=>{
      const parts = String(d.data().control||'').split('/');
      const n = parseInt(parts[2]||'0', 10);
      if(!isNaN(n) && n>max) max=n;
    });
    return max;
  }

  async function generateControl(siteCode, deptCode){
    if(!siteCode || !deptCode) throw new Error('Missing site/department code.');
    const cRef = doc(db,'counters','site', siteCode);
    const snap = await getDoc(cRef);
    if(!snap.exists()){
      const max = await getMaxSeqForSite(siteCode);
      await setDoc(cRef, { next: max+1 }, { merge:true });
    }
    let seq = 1;
    await runTransaction(db, async (tx)=>{
      const s = await tx.get(cRef);
      const cur = s.exists()? (s.data().next||1) : 1;
      seq = cur;
      tx.set(cRef, { next: cur+1 }, { merge:true });
    });
    return `${siteCode}/${deptCode}/${String(seq).padStart(3,'0')}`;
  }

  /* ===== collect / validate / save ===== */
  function collectPayload(){
    const siteCode = siteSel.selectedOptions[0]?.dataset.code || '';
    const siteName = siteSel.selectedOptions[0]?.textContent || '';
    const dep = DEPT_CACHE.find(d=> d.id === deptSelValue) || null;

    return {
      ecriName: ecriName.value || '',
      ecriCode: ecriCode.value || '',
      manufacturer: manufacturer.value || '',
      model: model.value || '',
      serial: serial.value || '',
      devClass: devClass.value || '',
      risk: risk.value || '',
      price: price.value? Number(price.value): null,
      supplier: supplier.value || '',
      contractNo: (devClass.value==='A'||devClass.value==='B') ? (contractNo.value||'') : '',
      siteId: siteSel.value || '',
      siteCode, siteName,
      departmentId: deptSelValue || '',
      deptCode: dep?.code || deptSelValue || '',
      departmentName: dep?.name || '',
      roomId: roomSelValue || '',
      warranty: warranty.value || 'no',
      commissioningDate: (warranty.value==='yes' ? (commissionDate.value||'') : ''),
      pmPeriodMonths: pmPeriod.value===''? null : Number(pmPeriod.value),
      lastPm: lastPm.value || '',
      nextPm: nextPm.value || ''
    };
  }

  function validate(p){
    if(!p.ecriName && !p.ecriCode) throw new Error('Select ECRI or type its code.');
    if(p.ecriCode && !p.ecriName){
      const m = ECRI_CACHE.find(x=> String(x.code)===String(p.ecriCode));
      if(m) p.ecriName = m.name; // ÿ™ŸàŸÅŸäŸÇ ÿßŸÑÿßÿ≥ŸÖ ŸÖŸÜ ÿßŸÑŸÉŸàÿØ
    }
    if(!p.manufacturer) throw new Error('Select manufacturer.');
    if(!p.model) throw new Error('Select model.');
    if(!p.serial) throw new Error('Serial is required.');
    if(!p.siteId || !p.siteCode) throw new Error('Select site.');
    if(!p.departmentId || !p.deptCode) throw new Error('Select department.');
    if(!p.devClass) throw new Error('Select class.');
    if((p.devClass==='A'||p.devClass==='B') && !p.contractNo) throw new Error('Enter contract number.');
    if(p.pmPeriodMonths!==null && !p.lastPm) throw new Error('Enter last PM date.');
    return p;
  }

  async function onSave(){
    try{
      // deps / site
      await loadDepartmentsForSite(); // in case user forgot to reselect
      const p0 = collectPayload(); const p = validate(p0);
      await reserveUnique(p);

      const controlNo = await generateControl(p.siteCode, p.deptCode);
      control.value = controlNo;

      const { images, documents } = await uploadFiles(controlNo);

      await setDoc(doc(db,'Equipment', controlNo), {
        ...p,
        control: controlNo,
        images, documents,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });

      alert('Saved successfully.');
      location.href = 'index.html';
    }catch(e){
      console.error(e);
      alert('Error: ' + (e.message||e));
    }
  }
  btnSave.addEventListener('click', onSave);

  /* AI Assist (local on ECRI_CACHE.search/name) */
  const aiModal = document.getElementById('aiModal');
  const aiClose = document.getElementById('aiClose');
  const aiDesc  = document.getElementById('aiDesc');
  const aiSuggest = document.getElementById('aiSuggest');
  const aiStatus = document.getElementById('aiStatus');
  const aiResults= document.getElementById('aiResults');
  document.getElementById('btnEcriAI')?.addEventListener('click', ()=>{
    aiDesc.value=''; aiResults.innerHTML=''; aiStatus.textContent='';
    aiModal.classList.remove('hidden'); aiModal.classList.add('flex');
  });
  aiClose?.addEventListener('click', ()=> aiModal.classList.add('hidden'));
  aiModal?.addEventListener('click', e=>{ if(e.target===aiModal) aiModal.classList.add('hidden'); });

  function localSuggest(q, limit=6){
    const s = (q||'').toLowerCase().trim(); if(!s) return [];
    const scored = ECRI_CACHE.map(x=>{
      const hay = ((x.search||'')+' '+(x.name||'')+' '+(x.code||'')).toLowerCase();
      let score = 0; if(hay.includes(s)) score += 3;
      s.split(/\s+/).forEach(t=>{ if(hay.includes(t)) score += 1; });
      if(String(x.code)===s) score += 4;
      return { item:x, score };
    }).filter(z=> z.score>0).sort((a,b)=> b.score-a.score).slice(0,limit).map(z=> z.item);
    return scored;
  }

  aiSuggest?.addEventListener('click', ()=>{
    aiResults.innerHTML=''; aiStatus.textContent='Thinking‚Ä¶';
    const items = localSuggest(aiDesc.value, 8);
    aiStatus.textContent = items.length? '' : 'No suggestions.';
    items.forEach(x=>{
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between border rounded-lg p-2';
      row.innerHTML = `
        <div>
          <div class="font-semibold">${escapeHtml(x.name||'-')}</div>
          <div class="text-xs text-slate-500">ECRI Code: <span class="mono">${escapeHtml(x.code||'-')}</span></div>
        </div>
        <button class="btn btn-brand">Use</button>
      `;
      row.querySelector('button').addEventListener('click', ()=>{
        // apply
        let opt = [...ecriName.options].find(o=> (o.value||'').toLowerCase()===String(x.name||'').toLowerCase());
        if(!opt){ opt=document.createElement('option'); opt.value=x.name; opt.textContent=x.name; opt.dataset.code=x.code; ecriName.appendChild(opt); }
        ecriName.value = x.name; ecriCode.value = x.code || '';
        aiModal.classList.add('hidden');
      });
      aiResults.appendChild(row);
    });
  });

</script>
</body>
</html>
