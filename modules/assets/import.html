<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>استيراد الأجهزة (Equipment) إلى Firestore</title>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<style>
  :root{--bg:#0b1220;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--ok:#10b981;--err:#ef4444;--info:#3b82f6}
  html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
  input,select{background:#0b1220;color:#fff;border:1px solid #374151;border-radius:10px;padding:10px 12px}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ok{background:#10b981;color:#083344}
  .btn.sec{background:#3b82f6;color:#e0f2fe}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid #1f2937;padding:6px 8px}
  th{background:#0f172a}
  .prog{height:10px;background:#0f172a;border-radius:8px;overflow:hidden}
  .bar{height:100%;width:0;background:#10b981}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-inline-start:6px}
  .good{background:rgba(16,185,129,.2);color:#a7f3d0}
  .bad{background:rgba(239,68,68,.2);color:#fecaca}
  .note{background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.4);padding:10px;border-radius:10px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
</style>
<link rel="stylesheet" href="../css/theme-light.css">
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>استيراد الأجهزة إلى Firestore (مجموعة Equipment)</h1>

    <div class="note">
      استخدم هذا النموذج لتجهيز الملف بدون لخبطة في الأعمدة:
      <div class="row" style="margin-top:8px">
        <button class="btn sec" id="tplXlsx">تحميل نموذج (Excel)</button>
        <button class="btn sec" id="tplCsv">تحميل نموذج (CSV)</button>
      </div>
      الأعمدة الأساسية: <b>Control</b> (إجباري)، <b>SiteId</b>، <b>DeptCode</b>، 
      <b>ECRICode</b>، <b>ECRIName</b>، <b>Manufacturer</b>، <b>Model</b>، <b>Serial</b>،
      <b>Warranty</b>، <b>DevClass</b>، <b>LastPM</b>، <b>NextPM</b>، <b>PMPeriodMonths</b>…
      (يمكن ترك <b>NextPM</b> فارغ ليُحتسب تلقائيًا من <b>PMPeriodMonths + LastPM</b>).
    </div>

    <div class="row">
      <input type="file" id="file" accept=".xlsx,.xls,.csv"/>
      <label><input type="checkbox" id="dry" checked> تشغيل كتجربة (بدون كتابة)</label>
      <label>المجموعة: <input id="collection" value="Equipment" style="min-width:160px"></label>
      <button class="btn sec" id="parseBtn">قراءة الملف</button>
    </div>
    <div id="status" class="muted">لم يتم تحميل ملف بعد.</div>
  </div>

  <div class="card" id="mapCard" style="display:none">
    <h2>خريطة الأعمدة</h2>
    <div class="grid" id="mapping"></div>
    <div class="row">
      <button class="btn sec" id="previewBtn">معاينة أول 10 صفوف</button>
      <button class="btn ok" id="importBtn">بدء الاستيراد</button>
    </div>
  </div>

  <div class="card" id="previewCard" style="display:none">
    <h2>المعاينة</h2>
    <div id="preview"></div>
  </div>

  <div class="card" id="progressCard" style="display:none">
    <h2>التقدم</h2>
    <div class="prog"><div class="bar" id="bar"></div></div>
    <div id="log" style="margin-top:10px;white-space:pre-wrap;font-family:ui-monospace,monospace"></div>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, doc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* ==== Firebase ==== */
const firebaseConfig = {
  apiKey: "AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
  authDomain: "pmqrtabuk.firebaseapp.com",
  projectId: "pmqrtabuk",
  storageBucket: "pmqrtabuk.firebasestorage.app",
  messagingSenderId: "305570616285",
  appId: "1:305570616285:web:4f6839fd08b8b5aa131c34"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ==== عناصر ==== */
const $ = s => document.querySelector(s);
const fileInput = $('#file');
const parseBtn  = $('#parseBtn');
const previewBtn= $('#previewBtn');
const importBtn = $('#importBtn');
const mappingEl = $('#mapping');
const mapCard   = $('#mapCard');
const previewCard=$('#previewCard');
const progressCard=$('#progressCard');
const statusEl  = $('#status');
const previewEl = $('#preview');
const bar       = $('#bar');
const logEl     = $('#log');
const colInput  = $('#collection');
const dryEl     = $('#dry');
const tplXlsx   = $('#tplXlsx');
const tplCsv    = $('#tplCsv');

let headers = [];
let rows = [];
let map = {};

/* ==== توليد ملفات النموذج ==== */
function downloadCSV(filename, rows){
  const header = Object.keys(rows[0]).join(',');
  const body = rows.map(r=>Object.values(r).map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([header + '\n' + body], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}
function downloadXLSX(filename, rows){
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Equipment');
  XLSX.writeFile(wb, filename);
}

/* == نموذج محدث لمخطط Equipment == */
const TEMPLATE_HEADERS = [
  "Control","SiteId","SiteName","DeptCode","DeptName","RoomId",
  "ECRICode","ECRIName","Manufacturer","Model","Serial",
  "Warranty","DevClass","Price","Supplier","ContractNo",
  "CommissioningDate","PMPeriodMonths","LastPM","NextPM"
];
const TEMPLATE_SAMPLE = [{
  "Control":"MT/RWDA/001",
  "SiteId":"MT",
  "SiteName":"الفريق المتحرك",
  "DeptCode":"RWDA",
  "DeptName":"الرومضه - تبوك",
  "RoomId":"1",
  "ECRICode":"1000",
  "ECRIName":"Linear Videoscope ( ULTRASOUND )",
  "Manufacturer":"GENERAL ELECTRIC",
  "Model":"V100",
  "Serial":"GE-001",
  "Warranty":"yes",
  "DevClass":"C",
  "Price":"15000",
  "Supplier":"GE Dealer",
  "ContractNo":"",
  "CommissioningDate":"2025-10-25",
  "PMPeriodMonths":"3",
  "LastPM":"2025-10-25",
  "NextPM":""   /* اتركها فاضية ليُحسب تلقائياً = LastPM + PMPeriodMonths */
}];
tplXlsx.onclick = ()=> downloadXLSX('equipment_template.xlsx', TEMPLATE_SAMPLE);
tplCsv.onclick  = ()=> downloadCSV('equipment_template.csv', TEMPLATE_SAMPLE);

/* ==== Helpers ==== */
function norm(s){ return String(s||'').trim().toLowerCase().replace(/ـ/g,''); }
function toISO(d){
  if(d===undefined || d===null || d==='') return null;
  if(typeof d==='number'){ const unix = (d - 25569) * 86400 * 1000; return new Date(unix).toISOString().slice(0,10); }
  const dt = new Date(d); return isNaN(+dt) ? null : dt.toISOString().slice(0,10);
}
function addMonthsISO(dateISO, m=6){ if(!dateISO) return null; const dt = new Date(dateISO); dt.setMonth(dt.getMonth()+Number(m||0)); return dt.toISOString().slice(0,10); }
function safeIdFromControl(control){ return String(control||'').trim().replace(/[\/#?\s]+/g,'-'); }

/* ==== Aliases (تعريف الأعمدة) ==== */
const ALIASES = {
  control:  new Set(['control','control number','رقم التحكم','رقم الجهاز','controlno','controlnumber']),
  siteId:   new Set(['siteid','site id','site code','site_code','site','الموقع','كود الموقع']),
  siteName: new Set(['sitename','site name','اسم الموقع']),
  deptCode: new Set(['deptcode','department code','department','dept','القسم','كود القسم']),
  deptName: new Set(['deptname','department name','اسم القسم']),
  roomId:   new Set(['room','roomid','room id','الغرفة','رقم الغرفة']),
  ecriCode: new Set(['ecricode','ecri code','ecri','code']),
  ecriName: new Set(['ecriname','ecri name','اسم الايكري','ecri n']),
  manufacturer: new Set(['manufacturer','brand','make','الشركة المصنعة','الماركة','الشركة']),
  model:   new Set(['model','موديل','الطراز']),
  serial:  new Set(['serial','serial no','serial number','s/n','sn','الرقم التسلسلي']),
  warranty:new Set(['warranty','ضمان','داخل الضمان','in warranty']),
  devClass:new Set(['devclass','class','الفئة','device class']),
  price:   new Set(['price','cost','amount','السعر']),
  supplier:new Set(['supplier','vendor','المورد']),
  contractNo: new Set(['contract','contract no','contract number','رقم العقد']),
  commissioningDate: new Set(['commissioning','commissioning date','start date','تاريخ التشغيل']),
  pmPeriodMonths: new Set(['pmperiod','pm period','pm months','pmperiodmonths','عدد الشهور']),
  lastPm:  new Set(['lastpm','pm date','last pm','pmdate','تاريخ الصيانة الوقائية']),
  nextPm:  new Set(['nextpm','next pm','next date','الصيانة القادمة'])
};
function guessTarget(h){
  const n = norm(h);
  for(const [t,set] of Object.entries(ALIASES)){ if(set.has(n)) return t; }
  return null;
}

/* ==== قراءة الملفات ==== */
const readCSV = async (buf) => {
  const text = new TextDecoder('utf-8').decode(buf);
  const wb = XLSX.read(text, {type:'string'});
  return wb.Sheets[wb.SheetNames[0]];
};

parseBtn.onclick = async ()=>{
  const file = fileInput.files?.[0];
  if(!file){ statusEl.textContent='اختر ملف أولًا.'; return; }
  statusEl.textContent='جاري القراءة…';
  try{
    const buf = await file.arrayBuffer();
    let ws;
    if(file.name.toLowerCase().endsWith('.csv')){
      ws = await readCSV(buf);
    }else{
      const wb = XLSX.read(buf, {type:'array'});
      ws = wb.Sheets[wb.SheetNames[0]];
    }
    rows = XLSX.utils.sheet_to_json(ws, {defval:''});
    headers = Object.keys(rows[0]||{});
    if(headers.length===0){ statusEl.textContent='لا يوجد أعمدة في الشيت الأول.'; return; }

    // خريطة مبدئية لكل الحقول
    map = {
      control:null, siteId:null, siteName:null, deptCode:null, deptName:null, roomId:null,
      ecriCode:null, ecriName:null, manufacturer:null, model:null, serial:null,
      warranty:null, devClass:null, price:null, supplier:null, contractNo:null,
      commissioningDate:null, pmPeriodMonths:null, lastPm:null, nextPm:null
    };
    headers.forEach(h=>{ const t = guessTarget(h); if(t && !map[t]) map[t]=h; });

    // واجهة المابينج
    mappingEl.innerHTML = '';
    for(const t of Object.keys(map)){
      const div = document.createElement('div');
      div.innerHTML = `
        <label style="display:block;margin-bottom:6px">${t}</label>
        <select data-target="${t}" style="min-width:220px">
          <option value="">— غير مخصص —</option>
          ${headers.map(h=>`<option value="${h}" ${map[t]===h?'selected':''}>${h}</option>`).join('')}
        </select>`;
      mappingEl.appendChild(div);
    }
    mappingEl.querySelectorAll('select').forEach(sel=>{
      sel.onchange = () => map[sel.dataset.target]=sel.value||null;
    });

    mapCard.style.display='block';
    previewCard.style.display='none';
    progressCard.style.display='none';
    statusEl.textContent=`تم التحميل: ${rows.length} صفًا • ${headers.length} عمودًا`;
  }catch(e){ statusEl.textContent='فشل قراءة الملف: '+e.message; }
};

/* ==== المعاينة ==== */
previewBtn.onclick = ()=>{
  const sample = rows.slice(0,10);
  const cols = Object.values(map).filter(Boolean);
  if(cols.length===0){ previewEl.textContent='اختر أعمدة أولًا.'; previewCard.style.display='block'; return; }
  let html = '<table><thead><tr>';
  html += cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
  for(const r of sample){ html += '<tr>' + cols.map(c=>`<td>${r[c]??''}</td>`).join('') + '</tr>'; }
  html += '</tbody></table>';
  previewEl.innerHTML = html;
  previewCard.style.display='block';
};

/* ==== الاستيراد ==== */
importBtn.onclick = async ()=>{
  // إجبار control
  if(!map.control){ alert('العمود الإجباري مفقود: control'); return; }
  const coll = (document.getElementById('collection').value||'Equipment').trim() || 'Equipment';
  const dry  = dryEl.checked;

  progressCard.style.display='block';
  bar.style.width='0%'; logEl.textContent='';
  const total = rows.length; let done=0, ok=0, fail=0;

  const chunkSize = 400;
  for(let i=0;i<rows.length;i+=chunkSize){
    const chunk = rows.slice(i, i+chunkSize);
    const batch = writeBatch(db);

    for(const r of chunk){
      try{
        const control = String(map.control? r[map.control] : '').trim();
        if(!control) throw new Error('Control فارغ');

        const siteId   = map.siteId   ? String(r[map.siteId]).trim()   : null;
        const siteName = map.siteName ? String(r[map.siteName]).trim() : null;
        const deptCode = map.deptCode ? String(r[map.deptCode]).trim() : null;
        const deptName = map.deptName ? String(r[map.deptName]).trim() : null;
        const roomId   = map.roomId   ? String(r[map.roomId]).trim()   : null;

        const ecriCode = map.ecriCode ? String(r[map.ecriCode]).trim() : null;
        const ecriName = map.ecriName ? String(r[map.ecriName]).trim() : null;

        const manufacturer = map.manufacturer ? String(r[map.manufacturer]).trim() : null;
        const model        = map.model ? String(r[map.model]).trim() : null;
        const serial       = map.serial ? String(r[map.serial]).trim() : null;

        const warranty = map.warranty ? String(r[map.warranty]).trim().toLowerCase() : null; // yes/no
        const devClass = map.devClass ? String(r[map.devClass]).trim().toUpperCase() : null; // A/B/C
        const price    = map.price && r[map.price]!=='' ? Number(r[map.price]) : null;
        const supplier = map.supplier ? String(r[map.supplier]).trim() : null;
        const contractNo = map.contractNo ? String(r[map.contractNo]).trim() : null;

        const commissioningDate = toISO(map.commissioningDate ? r[map.commissioningDate] : null);
        const pmPeriodMonths = map.pmPeriodMonths && r[map.pmPeriodMonths]!=='' ? Number(r[map.pmPeriodMonths]) : null;
        const lastPm = toISO(map.lastPm ? r[map.lastPm] : null);
        let nextPm   = toISO(map.nextPm ? r[map.nextPm] : null);

        // حساب NextPM لو مش موجود وكان فيه period + lastPM
        if(!nextPm && lastPm && (pmPeriodMonths || pmPeriodMonths===0)){
          nextPm = addMonthsISO(lastPm, pmPeriodMonths);
        }

        const payload = {
          control,            // يُحفظ كحقل للعرض
          siteId: siteId || null,
          siteName: siteName || null,
          departmentId: deptCode || null,
          deptCode: deptCode || null,
          departmentName: deptName || null,
          roomId: roomId || null,
          ecriCode: ecriCode || null,
          ecriName: ecriName || null,
          manufacturer: manufacturer || null,
          model: model || null,
          serial: serial || null,
          warranty: warranty || null,
          devClass: devClass || null,
          price: price ?? null,
          supplier: supplier || null,
          contractNo: contractNo || null,
          commissioningDate: commissioningDate || '',
          pmPeriodMonths: (pmPeriodMonths===0 || pmPeriodMonths) ? pmPeriodMonths : null,
          lastPm: lastPm || '',
          nextPm: nextPm || '',
          updatedAt: serverTimestamp()
        };

        const refId = safeIdFromControl(control); // مثال: MT-RWDA-001
        if(!dry){
          const ref = doc(collection(db, coll), refId);
          batch.set(ref, payload, { merge: true });
        }
        ok++;
      }catch(e){
        fail++;
        logEl.textContent += `❌ صف ${done+1}: ${e.message}\n`;
      }finally{
        done++;
      }
    }

    if(!dry){ await batch.commit(); }
    bar.style.width = `${Math.round((done/total)*100)}%`;
  }

  logEl.textContent = `✅ ناجحة: ${ok}   ❌ فاشلة: ${fail}\n` + logEl.textContent;
  if(dry) logEl.textContent = 'وضع التجربة مفعّل — لم يتم كتابة أي بيانات.\n' + logEl.textContent;
};
</script>
</body>
</html>
