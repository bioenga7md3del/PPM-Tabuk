<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK ‚Ä¢ Equipment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css"/>
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>
  <style>
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:1rem}
    .field{padding:.6rem .8rem;border:1px solid #cbd5e1;border-radius:.8rem}
    .btn{padding:.5rem .85rem;border-radius:.7rem;border:1px solid #cbd5e1;font-weight:600}
    .btn-brand{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn-brand:hover{background:#1d4ed8}
    .btn-danger{background:#dc2626;color:#fff;border-color:#dc2626}
    .btn-danger:hover{background:#b91c1c}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .hint{font-size:.8rem;color:#64748b}
    .badge{display:inline-flex;align-items:center;padding:.1rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid #e2e8f0;background:#f8fafc}
  </style>
</head>
<body>
<header data-include="/PPM-Tabuk/partials/header.html?v=2"></header>
<main class="w-full max-w-7xl mx-auto p-4 space-y-4">
  <section class="flex flex-wrap items-center justify-between gap-2">
    <h1 class="text-xl font-bold">Equipment</h1>
    <div class="flex gap-2">
      <a href="../assets/add.html" class="btn btn-brand">‚ûï Add Equipment</a>
      <button id="btnDeleteSelected" class="btn btn-danger" disabled>üóëÔ∏è Delete Selected (<span id="selCount">0</span>)</button>
    </div>
  </section>
  <section class="card p-4 space-y-3">
    <h2 class="font-semibold text-slate-800">Filters</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
      <input id="f_ecriCode" class="field mono" placeholder="ECRI Code">
      <input id="f_ecriName" class="field" placeholder="ECRI Name">
      <select id="f_site" class="field"></select>
      <select id="f_dept" class="field" disabled></select>
      <select id="f_warranty" class="field">
        <option value="">Warranty: All</option>
        <option value="yes">Warranty: Yes</option>
        <option value="no">Warranty: No</option>
      </select>
      <input id="f_maker" class="field" placeholder="Manufacturer">
      <input id="f_model" class="field" placeholder="Model">
      <input id="f_serial" class="field mono" placeholder="Serial">
      <select id="f_class" class="field">
        <option value="">Class: All</option>
        <option value="A">Class A</option>
        <option value="B">Class B</option>
        <option value="C">Class C</option>
      </select>
    </div>
    <div class="flex flex-wrap items-center gap-3 pt-2">
      <button id="btnReset" class="btn">‚Ü∫ Reset</button>
      <div class="ml-auto flex items-center gap-2">
        <label class="text-sm text-slate-600">Rows per page</label>
        <select id="pageSize" class="field">
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="1000">1000</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>
  </section>
  <section class="card p-0 overflow-hidden">
    <div class="overflow-auto" dir="ltr">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-900 text-white">
          <tr>
            <th class="p-2 sticky"><input type="checkbox" id="chkAll"></th>
            <th class="p-2 sticky">#</th>
            <th class="p-2 sticky">Control</th>
            <th class="p-2 sticky">ECRI Code</th>
            <th class="p-2 sticky">ECRI Name</th>
            <th class="p-2 sticky">Site</th>
            <th class="p-2 sticky">Department</th>
            <th class="p-2 sticky">Manufacturer</th>
            <th class="p-2 sticky">Model</th>
            <th class="p-2 sticky">Serial</th>
            <th class="p-2 sticky">Warranty</th>
            <th class="p-2 sticky">Class</th>
            <th class="p-2 sticky">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="flex items-center justify-between p-3">
      <div class="text-sm text-slate-600"><span id="pageInfo"></span></div>
      <div class="flex gap-2">
        <button id="btnPrev" class="btn">‚Üê Prev</button>
        <button id="btnNext" class="btn">Next ‚Üí</button>
      </div>
    </div>
  </section>
</main>
<script type="module">
import { auth, db } from "/PPM-Tabuk/js/firebase.js";
import { collection, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const $ = s=>document.querySelector(s);
const tbody=$('#tbody'); const f_site=$('#f_site'); const f_dept=$('#f_dept'); const f_ecriCode=$('#f_ecriCode'); const f_ecriName=$('#f_ecriName'); const f_warranty=$('#f_warranty'); const f_maker=$('#f_maker'); const f_model=$('#f_model'); const f_serial=$('#f_serial'); const f_class=$('#f_class'); const pageInfo=$('#pageInfo'); const btnPrev=$('#btnPrev'); const btnNext=$('#btnNext'); const pageSizeSel=$('#pageSize'); const chkAll=$('#chkAll'); const btnDeleteSelected=$('#btnDeleteSelected'); const selCount=$('#selCount'); const btnReset=$('#btnReset');

let ALL=[],FILTERED=[],DEPT_BY_SITE=new Map(),SELECTED=new Set(); let page=1;

onAuthStateChanged(auth,async(user)=>{
 if(!user){location.replace("../../login.html");return;}
 document.getElementById('userName').textContent=user.email;
 await loadEquipment(); buildFilterOptions(); applyFilters(); bindUI();
});

async function loadEquipment(){
 const qs=await getDocs(query(collection(db,'Equipment'),orderBy('control')));
 ALL=qs.docs.map(d=>({...d.data(),id:d.id}));
 DEPT_BY_SITE.clear();
 ALL.forEach(a=>{const s=a.siteName||'';const d=a.departmentName||'';if(!s)return;if(!DEPT_BY_SITE.has(s))DEPT_BY_SITE.set(s,new Set());if(d)DEPT_BY_SITE.get(s).add(d);});
}

function buildFilterOptions(){
 const sites=[...new Set(ALL.map(a=>a.siteName).filter(Boolean))].sort();
 f_site.innerHTML='<option value="">Site: All</option>'+sites.map(s=>`<option>${s}</option>`).join(''); f_dept.innerHTML='<option value="">Department: All</option>'; f_dept.disabled=true;
}

function fillDepartmentsForSelectedSite(){
 const site=f_site.value.trim(); f_dept.innerHTML='<option value="">Department: All</option>';
 if(!site){f_dept.disabled=true;return;}
 const depts=DEPT_BY_SITE.get(site); if(!depts){f_dept.disabled=true;return;}
 f_dept.innerHTML+=[...depts].sort().map(d=>`<option>${d}</option>`).join(''); f_dept.disabled=false;
}

function applyFilters(){
 const code=f_ecriCode.value.toLowerCase(); const name=f_ecriName.value.toLowerCase(); const site=f_site.value.toLowerCase(); const dept=f_dept.value.toLowerCase(); const war=f_warranty.value; const maker=f_maker.value.toLowerCase(); const model=f_model.value.toLowerCase(); const serial=f_serial.value.toLowerCase(); const cls=f_class.value.toUpperCase();
 FILTERED=ALL.filter(a=>{
   return (!code||(a.ecriCode||'').toLowerCase().includes(code))&&(!name||(a.ecriName||'').toLowerCase().includes(name))&&(!site||(a.siteName||'').toLowerCase()==site)&&(!dept||(a.departmentName||'').toLowerCase()==dept)&&(!war||(a.warranty||'')==war)&&(!maker||(a.manufacturer||'').toLowerCase().includes(maker))&&(!model||(a.model||'').toLowerCase().includes(model))&&(!serial||(a.serial||'').toLowerCase().includes(serial))&&(!cls||(a.devClass||'').toUpperCase()==cls);
 });
 page=1; render();
}

function getPageItems(){
 if(pageSizeSel.value==='all')return FILTERED; const s=parseInt(pageSizeSel.value); const start=(page-1)*s; return FILTERED.slice(start,start+s);
}

function updatePager(){
 const total=FILTERED.length; if(pageSizeSel.value==='all'){pageInfo.textContent=`Showing ${total}`;btnPrev.disabled=true;btnNext.disabled=true;return;} const s=parseInt(pageSizeSel.value); const pages=Math.max(1,Math.ceil(total/s)); if(page>pages)page=pages; const start=(page-1)*s+1; const end=Math.min(total,page*s); pageInfo.textContent=`Showing ${start}-${end} of ${total}`; btnPrev.disabled=page<=1; btnNext.disabled=page>=pages;
}

function render(){
 tbody.innerHTML=''; const items=getPageItems(); if(items.length===0){tbody.innerHTML='<tr><td colspan="13" class="p-4 text-center text-slate-500">No equipment found.</td></tr>'; updatePager(); return;}
 items.forEach((a,i)=>{
  const tr=document.createElement('tr'); tr.className='border-b border-slate-200';
  tr.innerHTML=`<td class='p-2 text-center'><input type='checkbox' data-id='${a.id}' ${SELECTED.has(a.id)?'checked':''}></td>
  <td class='p-2 text-center'>${i+1}</td>
  <td class='p-2 mono'>${a.control||''}</td>
  <td class='p-2 mono'>${a.ecriCode||''}</td>
  <td class='p-2'>${a.ecriName||''}</td>
  <td class='p-2'>${a.siteName||''}</td>
  <td class='p-2'>${a.departmentName||''}</td>
  <td class='p-2'>${a.manufacturer||''}</td>
  <td class='p-2'>${a.model||''}</td>
  <td class='p-2 mono'>${a.serial||''}</td>
  <td class='p-2'>${a.warranty==='yes'?'‚úÖ':'‚ùå'}</td>
  <td class='p-2'>${a.devClass||''}</td>
  <td class='p-2 flex gap-2'>
    <a href='../assets/view.html?id=${a.id}' class='px-2 py-1 text-xs bg-sky-600 hover:bg-sky-700 text-white rounded'>View</a>
    <a href='../assets/edit.html?id=${a.id}' class='px-2 py-1 text-xs bg-amber-500 hover:bg-amber-600 text-white rounded'>Edit</a>
    <button data-del='${a.id}' class='px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded'>Delete</button>
  </td>`;
  tbody.appendChild(tr);
 });
 tbody.querySelectorAll('button[data-del]').forEach(btn=>btn.addEventListener('click',async()=>{if(confirm('Delete this item?')){await deleteDoc(doc(db,'Equipment',btn.dataset.del));ALL=ALL.filter(x=>x.id!==btn.dataset.del);applyFilters();}}));
 updatePager();
}

function bindUI(){
 [f_ecriCode,f_ecriName,f_maker,f_model,f_serial].forEach(i=>i.addEventListener('input',applyFilters)); [f_warranty,f_class].forEach(s=>s.addEventListener('change',applyFilters)); f_site.addEventListener('change',()=>{fillDepartmentsForSelectedSite();applyFilters();}); f_dept.addEventListener('change',applyFilters); btnReset.addEventListener('click',()=>{[f_ecriCode,f_ecriName,f_maker,f_model,f_serial].forEach(i=>i.value=''); [f_warranty,f_class].forEach(s=>s.value=''); f_site.value=''; f_dept.innerHTML='<option value="">Department: All</option>'; f_dept.disabled=true; pageSizeSel.value='20'; page=1; applyFilters();}); pageSizeSel.addEventListener('change',()=>{page=1;render();}); btnPrev.addEventListener('click',()=>{if(page>1){page--;render();}}); btnNext.addEventListener('click',()=>{page++;render();});
}
</script>
</body>
</html>
