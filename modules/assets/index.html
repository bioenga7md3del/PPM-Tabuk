<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • Assets</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- الثيم الموحد -->
  <link rel="stylesheet" href="../../css/theme-light.css">

  <!-- مبدّل الثيم (اختياري) -->
  <script src="../../js/theme.js" defer></script>

  <!-- تحميل الهيدر الموحد -->
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>

  <!-- تمييز اللينك النشط -->
  <style>
    #mainNav a.active {
      position: relative;
      font-weight: 900 !important;
      letter-spacing: 0.3px;
      background: linear-gradient(90deg, #60a5fa, #3b82f6, #60a5fa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s linear infinite;
    }
    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    #mainNav a.active::after {
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: -4px;
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
      border-radius: 2px;
      transform: scaleX(0);
      transition: transform 0.25s ease-in-out;
    }
    #mainNav a.active:hover::after { transform: scaleX(1); }
    #mainNav a:hover {
      color: #bfdbfe !important;
      transition: color 0.2s;
    }
  </style>
</head>

<body>

  <!-- ✅ الهيدر الموحد -->
  <header data-include="/PPM-Tabuk/partials/header.html?v=2"></header>

  <main class="max-w-7xl mx-auto p-3 md:p-6 space-y-6">

    <!-- العنوان + الأزرار -->
    <section class="flex flex-wrap justify-between items-center gap-2">
      <h1 class="text-xl font-bold text-slate-800">Assets Management</h1>
      <div class="flex gap-2">
        <a href="import.html" class="btn btn-ghost">⬆️ Import Devices</a>
        <a href="add.html" class="btn btn-brand">➕ Add New Device</a>
      </div>
    </section>

    <!-- الفلاتر -->
    <section class="card p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
        <input id="f_control" class="field" placeholder="Control Number">
        <input id="f_name" class="field" placeholder="Device Name">
        <select id="f_site" class="field"></select>
        <select id="f_department" class="field"></select>
      </div>
    </section>

    <!-- الجدول -->
    <section class="card p-3">
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800 text-white">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Control</th>
              <th class="p-2">Name</th>
              <th class="p-2">Brand</th>
              <th class="p-2">Model</th>
              <th class="p-2">Serial</th>
              <th class="p-2">Site</th>
              <th class="p-2">Department</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- سكربت -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const cfg = {
      apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
      authDomain:"pmqrtabuk.firebaseapp.com",
      projectId:"pmqrtabuk",
      storageBucket:"pmqrtabuk.firebasestorage.app",
      messagingSenderId:"305570616285",
      appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const tbody = document.getElementById("tbody");

    // بعد تحميل الهيدر
    document.addEventListener("partials:loaded", () => {
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) {
        btnLogout.addEventListener("click", async () => {
          try { await signOut(auth); } finally { location.replace("../../login.html"); }
        });
      }

      // ✅ تمييز اللينك الحالي (Assets)
      const path = location.pathname.toLowerCase();
      document.querySelectorAll("#mainNav a").forEach(a => {
        const href = a.getAttribute("href")?.toLowerCase() || "";
        if (path.endsWith("dashboard/index.html") && href.includes("dashboard")) a.classList.add("active");
        else if (path.endsWith("assets/index.html") && href.includes("assets")) a.classList.add("active");
        else if (path.endsWith("preventive/index.html") && href.includes("preventive")) a.classList.add("active");
        else if (path.endsWith("corrective/index.html") && href.includes("corrective")) a.classList.add("active");
        else if (path.endsWith("sites/index.html") && href.includes("sites")) a.classList.add("active");
        else if (path.endsWith("users/index.html") && href.includes("users")) a.classList.add("active");
      });
    });

    // تحميل المستخدم و الأجهزة
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.replace("../../login.html"); return; }
      const snap = await getDoc(doc(db, "users", user.uid));
      const name = snap.exists() ? (snap.data().name || user.email) : user.email;
      const el = document.getElementById("userName");
      if (el) el.textContent = name;
      await loadAssets();
    });

    async function loadAssets(){
      const qs = await getDocs(query(collection(db,'assets'), orderBy('control')));
      let i = 1;
      tbody.innerHTML = '';
      qs.forEach(d=>{
        const a = d.data();
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-200';
        tr.innerHTML = `
          <td class="p-2 text-center">${i++}</td>
          <td class="p-2">${a.control||'—'}</td>
          <td class="p-2">${a.name||'—'}</td>
          <td class="p-2">${a.brand||'—'}</td>
          <td class="p-2">${a.model||'—'}</td>
          <td class="p-2">${a.serial||'—'}</td>
          <td class="p-2">${a.site||'—'}</td>
          <td class="p-2">${a.department||'—'}</td>
          <td class="p-2 flex gap-2">
            <a href="edit.html?id=${d.id}" class="px-2 py-1 bg-amber-500 hover:bg-amber-600 text-white text-xs rounded">Edit</a>
            <a href="../preventive/sticker.html#view/${encodeURIComponent(a.control||'')}" target="_blank" class="px-2 py-1 bg-sky-600 hover:bg-sky-700 text-white text-xs rounded">Sticker</a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
