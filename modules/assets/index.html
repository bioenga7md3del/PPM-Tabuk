<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • Assets</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>

  <!-- Active nav: Red only (بسيط) -->
  <style>
    #mainNav > a.active,
    #mainNav .dd > a.active { color:#ef4444!important; font-weight:800!important; }
    #mainNav > a.active::after,
    #mainNav .dd > a.active::after { content:none!important; }
    #mainNav > a, #mainNav .dd > a {
      background:none!important; -webkit-text-fill-color:initial!important;
    }
    #mainNav > a:hover, #mainNav .dd > a:hover { color:#fca5a5!important; }

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .btn{padding:.4rem .75rem;border-radius:.75rem;border:1px solid #cbd5e1;font-size:.875rem}
    .btn-ghost{background:transparent}
    .btn-brand{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn-brand:hover{background:#1d4ed8}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:1rem}
    .field{padding:.6rem .8rem;border:1px solid #cbd5e1;border-radius:1rem}
  </style>
</head>
<body>

  <!-- Header include -->
  <header data-include="/PPM-Tabuk/partials/header.html?v=2" class="w-full max-w-none"></header>

  <main class="w-full max-w-none mx-auto p-3 md:p-6 space-y-6">

    <!-- Title + actions -->
    <section class="flex flex-wrap justify-between items-center gap-2">
      <h1 class="text-xl font-bold text-slate-800">Assets Management</h1>
      <div class="flex gap-2">
        <a href="import.html" class="btn btn-ghost">⬆️ Import Devices</a>
        <a href="add.html" class="btn btn-brand">➕ Add New Device</a>
      </div>
    </section>

    <!-- Filters -->
    <section class="card p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
        <input id="f_control" class="field" placeholder="Control number">
        <input id="f_name" class="field" placeholder="Device name">
        <select id="f_site" class="field"></select>
        <select id="f_department" class="field"></select>
      </div>
    </section>

    <!-- Table -->
    <section class="card p-3">
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800 text-white">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Control</th>
              <th class="p-2">Name</th>
              <th class="p-2">Site</th>
              <th class="p-2">Department</th>
              <th class="p-2">Brand</th>
              <th class="p-2">Model</th>
              <th class="p-2">Serial</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from "/PPM-Tabuk/js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Elements
    const tbody    = document.getElementById("tbody");
    const fControl = document.getElementById('f_control');
    const fName    = document.getElementById('f_name');
    const fSite    = document.getElementById('f_site');
    const fDept    = document.getElementById('f_department');

    let ALL = [];
    let FILTERED = [];

    // URL filters (department/room/site)
    let URL_FILTERS = { site:'', deptName:'', deptCode:'', roomName:'', roomCode:'' };

    // بعد تحميل الهيدر: Logout + تفعيل Active للـ Assets
    document.addEventListener("partials:loaded", () => {
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) {
        btnLogout.addEventListener("click", async (e) => {
          e.preventDefault();
          try { await signOut(auth); } finally { location.replace("/PPM-Tabuk/login.html"); }
        });
      }
      markActive("assets");
    });

    function markActive(key){
      const sel = [
        `#mainNav > a[data-to="${key}"]`,
        `#mainNav .dd[data-dd="${key}"] > a[data-to="${key}"]`
      ].join(",");
      const a = document.querySelector(sel);
      if (a) a.classList.add("active");
    }

    // Auth + load
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.replace("/PPM-Tabuk/login.html"); return; }
      const snap = await getDoc(doc(db, "users", user.uid));
      const name = snap.exists() ? (snap.data().name || snap.data().nameEn || user.email) : user.email;
      const el = document.getElementById("userName"); if (el) el.textContent = name;

      await loadAssets();
      await fillFilters();
      readURLFiltersAndPrefill();
      applyFilters();
    });

    async function loadAssets(){
      const qs = await getDocs(query(collection(db,'assets'), orderBy('control')));
      // طَبِّع الحقول لتسهيل الفلترة (site/department/room قد تكون بأسماء مختلفة)
      ALL = qs.docs.map((d, i) => {
        const a = d.data();
        return {
          id: d.id,
          idx: i+1,
          ...a,
          __siteKey: (a.siteCode || a.site || a.siteName || ''),      // قيمة للمقارنة/الفلترة
          __deptCode: (a.departmentCode || ''),                        // كود القسم
          __deptName: (a.department || a.departmentName || ''),        // اسم القسم
          __roomCode: (a.roomCode || ''),                              // كود الغرفة
          __roomName: (a.room || a.roomName || '')                     // اسم الغرفة
        };
      });
    }

    async function fillFilters(){
      // جهّز مجموعات القيم المميّزة
      const siteSet = new Set();
      const deptMap = new Map(); // key: deptCode OR deptName, val: display text

      ALL.forEach(a => {
        const siteKey = (a.__siteKey || '').toString().trim();
        if (siteKey) siteSet.add(siteKey);

        const dCode = (a.__deptCode || '').toString().trim();
        const dName = (a.__deptName || '').toString().trim();
        if (dCode) {
          if (!deptMap.has(dCode)) deptMap.set(dCode, dName || dCode);
        } else if (dName) {
          if (!deptMap.has(dName)) deptMap.set(dName, dName);
        }
      });

      // Site options (value = siteKey)
      fSite.innerHTML = '<option value="">All sites</option>' +
        [...siteSet].sort().map(s => `<option value="${s}">${s}</option>`).join('');

      // Department options (value = deptCode إن وُجد، وإلا الاسم)
      fDept.innerHTML = '<option value="">All departments</option>' +
        [...deptMap.entries()]
          .sort((a,b) => a[1].localeCompare(b[1]))
          .map(([val, label]) => `<option value="${val}">${label}</option>`)
          .join('');
    }

    function readURLFiltersAndPrefill(){
      const usp = new URLSearchParams(location.search);
      const siteParam  = usp.get('site');
      const deptNameParam = usp.get('department');
      const deptCodeParam = usp.get('departmentCode');
      const roomNameParam = usp.get('room');
      const roomCodeParam = usp.get('roomCode');

      URL_FILTERS = {
        site: (siteParam||'').trim(),
        deptName: (deptNameParam||'').trim(),
        deptCode: (deptCodeParam||'').trim(),
        roomName: (roomNameParam||'').trim(),
        roomCode: (roomCodeParam||'').trim()
      };

      // حاول تضبط السيلكتات على قد ما تقدر من URL
      if (URL_FILTERS.site) {
        const opt = [...fSite.options].find(o => (o.value||'').toLowerCase() === URL_FILTERS.site.toLowerCase());
        if (opt) fSite.value = opt.value;
      }
      if (URL_FILTERS.deptCode) {
        const optD = [...fDept.options].find(o => (o.value||'').toLowerCase() === URL_FILTERS.deptCode.toLowerCase());
        if (optD) fDept.value = optD.value;
      } else if (URL_FILTERS.deptName) {
        // طابق بالاسم (label)
        const optD = [...fDept.options].find(o => (o.textContent||'').toLowerCase() === URL_FILTERS.deptName.toLowerCase());
        if (optD) fDept.value = optD.value;
      }
    }

    function applyFilters(){
      const qControl = (fControl.value||'').trim().toLowerCase();
      const qName    = (fName.value||'').trim().toLowerCase();
      const qSiteSel = (fSite.value||'').trim().toLowerCase();       // من السيلكت
      const qDeptSel = (fDept.value||'').trim().toLowerCase();       // من السيلكت

      // URL params (site/department/room)
      const qSiteURL  = (URL_FILTERS.site||'').toLowerCase();
      const qDeptName = (URL_FILTERS.deptName||'').toLowerCase();
      const qDeptCode = (URL_FILTERS.deptCode||'').toLowerCase();
      const qRoomName = (URL_FILTERS.roomName||'').toLowerCase();
      const qRoomCode = (URL_FILTERS.roomCode||'').toLowerCase();

      FILTERED = ALL.filter(a=>{
        const control = (a.control||'').toString().toLowerCase();
        const name    = (a.name||'').toString().toLowerCase();

        const siteKey = (a.__siteKey||'').toString().toLowerCase();

        const deptCodeField = (a.__deptCode||'').toString().toLowerCase();
        const deptNameField = (a.__deptName||'').toString().toLowerCase();

        const roomCodeField = (a.__roomCode||'').toString().toLowerCase();
        const roomNameField = (a.__roomName||'').toString().toLowerCase();

        // فلاتر من الواجهة
        const okC  = !qControl || control.includes(qControl);
        const okN  = !qName    || name.includes(qName);
        const okS1 = !qSiteSel || siteKey === qSiteSel;
        // القسم في الواجهة: القيمة قد تكون كود القسم أو الاسم (حسب المتاح)
        const okD1 = !qDeptSel || deptCodeField === qDeptSel || deptNameField === qDeptSel;

        // فلاتر من URL
        const okS2 = !qSiteURL  || siteKey.includes(qSiteURL);
        const okD2 = !qDeptCode || deptCodeField === qDeptCode;
        const okD3 = !qDeptName || deptNameField === qDeptName || deptNameField.includes(qDeptName);
        const okR1 = !qRoomCode || roomCodeField === qRoomCode;
        const okR2 = !qRoomName || roomNameField === qRoomName || roomNameField.includes(qRoomName);

        return okC && okN && okS1 && okD1 && okS2 && okD2 && okD3 && okR1 && okR2;
      });

      renderTable();
    }

    function renderTable(){
      tbody.innerHTML = '';
      if (FILTERED.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-slate-500">No matching devices.</td></tr>`;
        return;
      }
      FILTERED.forEach((a, i) => {
        const siteDisp = a.site || a.siteName || a.siteCode || '—';
        const deptDisp = a.department || a.departmentName || a.departmentCode || '—';
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-200';
        tr.innerHTML = `
          <td class="p-2 text-center">${i+1}</td>
          <td class="p-2 whitespace-nowrap mono">${a.control||'—'}</td>
          <td class="p-2">${a.name||'—'}</td>
          <td class="p-2">${siteDisp}</td>
          <td class="p-2">${deptDisp}</td>
          <td class="p-2">${a.brand||'—'}</td>
          <td class="p-2">${a.model||'—'}</td>
          <td class="p-2">${a.serial||'—'}</td>
          <td class="p-2 flex gap-2">
            <a href="edit.html?id=${encodeURIComponent(a.id)}" class="px-2 py-1 bg-amber-500 hover:bg-amber-600 text-white text-xs rounded">Edit</a>
            <a href="../preventive/sticker.html#view/${encodeURIComponent(a.control||'')}" target="_blank" class="px-2 py-1 bg-sky-600 hover:bg-sky-700 text-white text-xs rounded">Sticker</a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // UI listeners
    [fControl, fName].forEach(inp => inp.addEventListener('input', ()=>applyFilters()));
    [fSite, fDept].forEach(sel => sel.addEventListener('change', ()=>applyFilters()));
  </script>
</body>
</html>
