<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • View Equipment</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css"/>
  <script src="../../js/theme.js" defer></script>
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>

  <!-- QR & Barcode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <style>
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:1rem}
    .field{padding:.6rem .8rem;border:1px solid #cbd5e1;border-radius:.8rem}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .grid-2{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:.75rem}
    @media (min-width:1024px){.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .row{display:grid;grid-template-columns:180px 1fr;gap:.5rem;align-items:center}
    .badge{display:inline-flex;align-items:center;padding:.1rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid #e2e8f0;background:#f8fafc}
    .label{color:#475569;font-weight:600}
  </style>
</head>
<body>

<header data-include="/PPM-Tabuk/partials/header.html?v=2"></header>

<main class="w-full max-w-6xl mx-auto p-4 space-y-4">
  <section class="flex flex-wrap items-center justify-between">
    <h1 class="text-xl font-bold">Equipment Details</h1>
    <div class="flex gap-2">
      <a id="editLink" class="px-3 py-2 rounded bg-amber-500 hover:bg-amber-600 text-white">✏️ Edit</a>
      <a href="index.html" class="px-3 py-2 rounded border">← Back</a>
    </div>
  </section>

  <!-- Header block: Control + QR + Barcode -->
  <section class="card p-4">
    <div class="flex flex-col lg:flex-row items-start lg:items-center gap-4">
      <div class="flex-1">
        <div class="text-sm text-slate-500">Control Number</div>
        <div id="ctl" class="mono text-2xl font-bold">—</div>
        <div class="text-sm text-slate-500 mt-1">ECRI:
          <span id="ecriCode" class="mono">—</span> — <span id="ecriName">—</span>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <div class="text-center">
          <div class="text-xs text-slate-500 mb-1">QR</div>
          <div id="qr"></div>
        </div>
        <div class="text-center">
          <div class="text-xs text-slate-500 mb-1">Barcode</div>
          <svg id="barcode"></svg>
        </div>
      </div>
    </div>
  </section>

  <section class="grid-2">
    <!-- General -->
    <div class="card p-4 space-y-2">
      <h2 class="font-semibold text-slate-800 mb-2">General</h2>

      <div class="row"><div class="label">Manufacturer</div><div id="manufacturer">—</div></div>
      <div class="row"><div class="label">Model</div><div id="model">—</div></div>
      <div class="row"><div class="label">Serial</div><div id="serial" class="mono">—</div></div>
      <div class="row"><div class="label">Class</div><div id="devClass" class="badge">—</div></div>
      <div class="row"><div class="label">Risk</div><div id="risk" class="badge">—</div></div>
      <div class="row"><div class="label">Price (SAR)</div><div id="price">—</div></div>
      <div class="row"><div class="label">Supplier</div><div id="supplier">—</div></div>

      <!-- ✅ Procurement -->
      <div class="row"><div class="label">PO Number</div><div id="poNumber">—</div></div>
      <div class="row"><div class="label">Invoice Number</div><div id="invoiceNumber">—</div></div>

      <div class="row"><div class="label">Maintenance Contract</div><div id="contractNo">—</div></div>
    </div>

    <!-- Location / Warranty / PM -->
    <div class="card p-4 space-y-2">
      <h2 class="font-semibold text-slate-800 mb-2">Location & PM</h2>

      <div class="row"><div class="label">Site</div><div><span id="siteName">—</span> <span class="mono text-slate-500" id="siteCode"></span></div></div>
      <div class="row"><div class="label">Department</div><div><span id="departmentName">—</span> <span class="mono text-slate-500" id="deptCode"></span></div></div>
      <div class="row"><div class="label">Room</div><div id="roomId">—</div></div>

      <div class="row"><div class="label">Warranty</div><div id="warranty">—</div></div>
      <div class="row"><div class="label">Commissioning</div><div id="commissioningDate">—</div></div>
      <div class="row"><div class="label">PM Period</div><div id="pmPeriodMonths">—</div></div>
      <div class="row"><div class="label">Last PM</div><div id="lastPm">—</div></div>
      <div class="row"><div class="label">Next PM</div><div id="nextPm">—</div></div>
    </div>
  </section>

  <!-- Documents -->
  <section class="card p-4 space-y-2">
    <h2 class="font-semibold text-slate-800 mb-2">Documents</h2>
    <div id="docs" class="space-y-2"></div>
  </section>

  <!-- Photos -->
  <section class="card p-4 space-y-2">
    <h2 class="font-semibold text-slate-800 mb-2">Photos</h2>
    <div id="imgs" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
  </section>

</main>

<script type="module">
  import { auth, db } from "/PPM-Tabuk/js/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const $ = s => document.querySelector(s);
  const params = new URLSearchParams(location.search);
  const id = params.get('id'); // control number as doc id

  // Header actions
  document.addEventListener("partials:loaded", ()=>{
    $('#editLink').setAttribute('href', 'edit.html?id='+encodeURIComponent(id||''));
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.replace("../../login.html"); return; }
    await load();
  });

  function setText(id, val, fallback='—'){
    const el = typeof id==='string' ? document.getElementById(id) : id;
    if(!el) return;
    el.textContent = (val ?? '') !== '' ? String(val) : fallback;
  }

  function fmtPrice(v){
    if(v===null || v===undefined || v==='') return '—';
    const n = Number(v); if(isNaN(n)) return String(v);
    return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  async function load(){
    try{
      if(!id) throw new Error('Missing id.');
      const snap = await getDoc(doc(db,'Equipment', id));
      if(!snap.exists()) throw new Error('Not found.');
      const x = snap.data();

      // Header
      setText('ctl', x.control || id);
      setText('ecriCode', x.ecriCode);
      setText('ecriName', x.ecriName);

      // General
      setText('manufacturer', x.manufacturer);
      setText('model', x.model);
      setText('serial', x.serial);
      setText('devClass', x.devClass);
      setText('risk', x.risk);
      $('#price').textContent = fmtPrice(x.price);
      setText('supplier', x.supplier);

      // ✅ Procurement
      setText('poNumber', x.poNumber);
      setText('invoiceNumber', x.invoiceNumber);

      setText('contractNo', x.contractNo);

      // Location / PM
      setText('siteName', x.siteName);
      setText('siteCode', x.siteCode);
      setText('departmentName', x.departmentName);
      setText('deptCode', x.deptCode);
      setText('roomId', x.roomId);
      setText('warranty', x.warranty==='yes' ? 'Yes' : (x.warranty==='no' ? 'No' : '—'));
      setText('commissioningDate', x.commissioningDate);
      setText('pmPeriodMonths', x.pmPeriodMonths===null||x.pmPeriodMonths===undefined||x.pmPeriodMonths==='' ? '—' :
        (x.pmPeriodMonths===0 ? 'Daily' :
         x.pmPeriodMonths===1 ? 'Monthly' :
         x.pmPeriodMonths===3 ? 'Quarterly' :
         x.pmPeriodMonths===6 ? 'Semiannual' :
         x.pmPeriodMonths===12 ? 'Yearly' : x.pmPeriodMonths+' mo'));
      setText('lastPm', x.lastPm);
      setText('nextPm', x.nextPm);

      // QR & Barcode
      renderCodes(x.control || id);

      // Docs
      renderDocs(x.documents || []);
      // Photos
      renderImgs(x.images || []);
    }catch(e){
      alert('Error: '+(e.message||e));
      console.error(e);
    }
  }

  function renderCodes(ctrl){
    // QR
    const qrWrap = document.getElementById('qr');
    qrWrap.innerHTML = '';
    new QRCode(qrWrap, {
      text: String(ctrl||''),
      width: 96, height: 96
    });
    // Barcode
    JsBarcode("#barcode", String(ctrl||''), {
      format: "code128",
      displayValue: true,
      fontSize: 12,
      height: 48,
      margin: 0
    });
  }

  function renderDocs(list){
    const box = document.getElementById('docs');
    box.innerHTML = '';
    if(!list.length){
      box.innerHTML = '<div class="text-slate-500">No documents.</div>';
      return;
    }
    list.forEach(d=>{
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between border rounded-lg p-2';
      row.innerHTML = `
        <div>
          <div class="font-semibold">${escapeHtml(d.group||'Document')}</div>
          <div class="text-xs text-slate-500 mono">${escapeHtml(d.name||'')}</div>
          <div class="text-xs text-slate-400">${((d.size||0)/1024).toFixed(1)} KB</div>
        </div>
        <a class="px-3 py-1 rounded bg-sky-600 hover:bg-sky-700 text-white" target="_blank" rel="noopener">Open</a>
      `;
      row.querySelector('a').href = d.url || '#';
      box.appendChild(row);
    });
  }

  function renderImgs(list){
    const box = document.getElementById('imgs');
    box.innerHTML = '';
    if(!list.length){
      box.innerHTML = '<div class="text-slate-500">No photos.</div>';
      return;
    }
    list.forEach(img=>{
      const card = document.createElement('a');
      card.href = img.url || '#';
      card.target = '_blank'; card.rel = 'noopener';
      card.className = 'block border rounded-lg overflow-hidden hover:shadow';
      card.innerHTML = `
        <img src="${escapeHtml(img.url||'')}" alt="${escapeHtml(img.title||img.name||'')}" class="w-full h-36 object-cover">
        <div class="p-2 text-sm">${escapeHtml(img.title||img.name||'')}</div>
      `;
      box.appendChild(card);
    });
  }

  function escapeHtml(s){return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));}
</script>
</body>
</html>
