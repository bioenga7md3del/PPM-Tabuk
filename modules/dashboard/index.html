<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK â€¢ Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
</head>
<body>

  <!-- Header -->
  <header class="max-w-7xl mx-auto px-3 md:px-6 mt-3">
    <div class="topbar px-3 md:px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button class="icon-btn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M4 6h16M4 12h16M4 18h16" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <nav class="flex items-center gap-3 text-white/90">
        <a href="../dashboard/index.html" class="font-bold">Dashboard</a>
        <a href="../assets/index.html">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</a>
        <a href="../preventive/index.html">Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©</a>
        <a href="../corrective/index.html">Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</a>
        <a href="../sites/index.html">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</a>
        <a href="../users/index.html" id="navAdmin">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</a>
      </nav>

      <div class="flex items-center gap-2">
        <div class="avatar">ğŸ‘¤</div>
        <span id="userName" class="hidden sm:inline text-sm"></span>
        <button id="btnLogout" class="btn btn-ghost">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 md:p-6 space-y-6">

    <!-- Work Orders / KPIs -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <div class="lg:col-span-5">
        <div class="wo-panel">
          <div class="flex items-start gap-3">
            <div class="wo-side hidden md:block">
              There are many actions to do for your work orders now! â€¢ View All
            </div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div class="wo-title">Work Orders</div>
                <div class="text-2xl font-extrabold"><span class="wo-v" id="wo_total"></span></div>
              </div>
              <div class="wo-grid mt-3">
                <div class="wo-tile"><div class="wo-k">Active</div><div class="wo-v" id="wo_active"></div></div>
                <div class="wo-tile"><div class="wo-k">Closed</div><div class="wo-v" id="wo_closed"></div></div>
                <div class="wo-tile"><div class="wo-k">Assigned</div><div class="wo-v" id="wo_assigned"></div></div>
                <div class="wo-tile"><div class="wo-k">Pending for Spare</div><div class="wo-v" id="wo_pending_spare"></div></div>
                <div class="wo-tile"><div class="wo-k">Signed Off</div><div class="wo-v" id="wo_signed_off"></div></div>
                <div class="wo-tile"><div class="wo-k">Pending for Approval</div><div class="wo-v" id="wo_pending_approval"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPIs right -->
      <div class="lg:col-span-7 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="slim-card">
          <div class="text-sm text-slate-600">Total</div>
          <div class="kpi-v" id="eq_total"></div>
        </div>
        <div class="slim-card">
          <div class="text-sm text-slate-600">Class A</div>
          <div class="kpi-v" id="eq_class_a"></div>
        </div>
        <div class="slim-card">
          <div class="text-sm text-slate-600">Class B</div>
          <div class="kpi-v" id="eq_class_b"></div>
        </div>
        <div class="slim-card">
          <div class="text-sm text-slate-600">Class C</div>
          <div class="kpi-v" id="eq_class_c"></div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 mt-4">
      <div class="lg:col-span-4 card chart-card">
        <div class="text-slate-500 text-sm mb-2">Tickets Status</div>
        <canvas id="ticketsChart" height="170"></canvas>
      </div>
      <div class="lg:col-span-4 card chart-card">
        <div class="text-slate-500 text-sm mb-2">Total Equipment</div>
        <canvas id="totalEqChart" height="170"></canvas>
      </div>
      <div class="lg:col-span-4 card chart-card">
        <div class="text-slate-500 text-sm mb-2">PPM in this year</div>
        <canvas id="ppmYearChart" height="170"></canvas>
      </div>
    </section>

  </main>

  <!-- Scripts -->
  <script type="module">
    /* Firebase + Auth + Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù…Ù† Firestore */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getCountFromServer, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import "../../js/roles.js";
    import "../../js/charts.js";  // ÙŠØ±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£Ùˆ ÙŠØ­Ø· Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯

    const cfg = {
      apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
      authDomain:"pmqrtabuk.firebaseapp.com",
      projectId:"pmqrtabuk",
      storageBucket:"pmqrtabuk.firebasestorage.app",
      messagingSenderId:"305570616285",
      appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const userName = document.getElementById('userName');
    const btnLogout = document.getElementById('btnLogout');

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.replace("../../login.html"); return; }

      // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† users/{uid}.name Ø£Ùˆ displayName
      let name = user.displayName || "";
      try{
        const snap = await getDoc(doc(db,'users', user.uid));
        if (snap.exists() && snap.data().name) name = snap.data().name;
      }catch{}
      userName.textContent = name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";

      // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ØŒ Ø­Ù…Ù‘Ù„ Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© (Ø£Ù…Ø«Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… getCountFromServer)
      await loadKPIs();
    });

    btnLogout.addEventListener('click', async ()=>{
      try { await signOut(auth); } finally { location.replace("../../login.html"); }
    });

    /* ========= KPIs / WO samples (Ø¹Ø¯Ù‘Ø§Ø¯ Ø³Ø±ÙŠØ¹) ========= */
    async function loadKPIs(){
      try{
        // Ø£Ù…Ø«Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ø§Ø³ØªØ¨Ø¯Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙƒÙˆÙ„ÙƒØ´Ù†/Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¨Ù…Ø®Ø·Ø·Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ùˆ Ù…Ø®ØªÙ„Ù
        const woCol  = collection(db, 'workOrders'); // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ
        const eqCol  = collection(db, 'assets');

        // Total Equipment
        const eqTotalSnap = await getCountFromServer(eqCol);
        setTxt('eq_total', eqTotalSnap.data().count || '');

        // Class counts (A/B/C) â€” Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ field: class
        const aSnap = await getCountFromServer(query(eqCol, where('class','==','A')));
        const bSnap = await getCountFromServer(query(eqCol, where('class','==','B')));
        const cSnap = await getCountFromServer(query(eqCol, where('class','==','C')));
        setTxt('eq_class_a', aSnap.data().count || '');
        setTxt('eq_class_b', bSnap.data().count || '');
        setTxt('eq_class_c', cSnap.data().count || '');

        // Work Orders (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ collection workOrders ÙˆÙÙŠÙ„Ø¯ status)
        const totalWO  = woCol ? (await getCountFromServer(woCol)).data().count : 0;
        const activeWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','active')))).data().count : '';
        const closedWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','closed')))).data().count : '';
        const assignedWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','assigned')))).data().count : '';
        const pendingSpareWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','pending_spare')))).data().count : '';
        const signedOffWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','signed_off')))).data().count : '';
        const pendingApprovalWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','pending_approval')))).data().count : '';

        setTxt('wo_total', totalWO || '');
        setTxt('wo_active', activeWO);
        setTxt('wo_closed', closedWO);
        setTxt('wo_assigned', assignedWO);
        setTxt('wo_pending_spare', pendingSpareWO);
        setTxt('wo_signed_off', signedOffWO);
        setTxt('wo_pending_approval', pendingApprovalWO);
      }catch(err){
        console.error('KPIs error:', err);
      }
    }

    function setTxt(id, val){ const el=document.getElementById(id); if(el) el.textContent = val ?? ''; }
  </script>
</body>
</html>
