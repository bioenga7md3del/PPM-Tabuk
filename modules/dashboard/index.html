<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- الثيم الموحد -->
  <link rel="stylesheet" href="../../css/theme-light.css">

  <!-- (اختياري) مبدّل الثيم -->
  <script src="../../js/theme.js" defer></script>

  <!-- Loader للـ partials -->
  <script src="/PPM-Tabuk/js/include.js?v=2" defer></script>




<!-- تنسيق اللينك النشط -->
<style>
  /* تمييز اللينك النشط */
  #mainNav a.active {
    position: relative;
    color: #93c5fd !important;       /* أزرق فاتح */
    font-weight: 900 !important;     /* خط سميك */
    letter-spacing: 0.3px;
    transition: color 0.25s ease-in-out;
  }

  #mainNav a.active::after {
    content: "";
    position: absolute;
    left: 0; right: 0; bottom: -4px;
    height: 2px;
    background-color: #60a5fa;       /* خط أزرق تحته */
    border-radius: 2px;
    transform: scaleX(0);
    transition: transform 0.25s ease-in-out;
  }

  #mainNav a.active:hover::after {
    transform: scaleX(1);
  }

  #mainNav a:hover {
    color: #bfdbfe !important;       /* افتح عند المرور */
  }
</style>

<!-- سكربت تحديد الصفحة وتفعيل اللينك -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // إعداد Firebase
  const cfg = {
    apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
    authDomain:"pmqrtabuk.firebaseapp.com",
    projectId:"pmqrtabuk",
    storageBucket:"pmqrtabuk.firebasestorage.app",
    messagingSenderId:"305570616285",
    appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
  };
  const app = initializeApp(cfg);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // بعد تحميل الهيدر
  document.addEventListener("partials:loaded", () => {
    // زر الخروج
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", async () => {
        try { await signOut(auth); } finally { location.replace("../../login.html"); }
      });
    }

    // ✅ تمييز اللينك الحالي
    const path = location.pathname.toLowerCase();
    document.querySelectorAll("#mainNav a").forEach(a => {
      const href = a.getAttribute("href")?.toLowerCase() || "";
      if (path.endsWith("dashboard/index.html") && href.includes("dashboard")) a.classList.add("active");
      else if (path.endsWith("assets/index.html") && href.includes("assets")) a.classList.add("active");
      else if (path.endsWith("preventive/index.html") && href.includes("preventive")) a.classList.add("active");
      else if (path.endsWith("corrective/index.html") && href.includes("corrective")) a.classList.add("active");
      else if (path.endsWith("sites/index.html") && href.includes("sites")) a.classList.add("active");
      else if (path.endsWith("users/index.html") && href.includes("users")) a.classList.add("active");
    });
  });

  // عرض اسم المستخدم
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.replace("../../login.html"); return; }
    try{
      const snap=await getDoc(doc(db,'users',user.uid));
      const name=(snap.exists() && snap.data().name) ? snap.data().name : (user.displayName||user.email);
      const el=document.getElementById('userName');
      if(el) el.textContent=name||'';
    }catch{}
  });
</script>






  

  
<body>

  <!-- ✅ الهيدر الموحد من الـ partial -->
  <header data-include="/PPM-Tabuk/partials/header.html?v=2" class="w-full max-w-none" ></header>

  <main class="w-full max-w-none mx-auto p-3 md:p-6 space-y-6">   

    <!-- Work Orders / KPIs -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <div class="lg:col-span-5">
        <div class="wo-panel">
          <div class="flex items-start gap-3">
            <div class="wo-side hidden md:block">
              There are many actions to do for your work orders now! • View All
            </div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div class="wo-title">Work Orders</div>
                <div class="text-2xl font-extrabold"><span class="wo-v" id="wo_total"></span></div>
              </div>
              <div class="wo-grid mt-3">
                <div class="wo-tile"><div class="wo-k">Active</div><div class="wo-v" id="wo_active"></div></div>
                <div class="wo-tile"><div class="wo-k">Closed</div><div class="wo-v" id="wo_closed"></div></div>
                <div class="wo-tile"><div class="wo-k">Assigned</div><div class="wo-v" id="wo_assigned"></div></div>
                <div class="wo-tile"><div class="wo-k">Pending for Spare</div><div class="wo-v" id="wo_pending_spare"></div></div>
                <div class="wo-tile"><div class="wo-k">Signed Off</div><div class="wo-v" id="wo_signed_off"></div></div>
                <div class="wo-tile"><div class="wo-k">Pending for Approval</div><div class="wo-v" id="wo_pending_approval"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPIs right -->
      <div class="lg:col-span-7 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="slim-card">
          <div class="text-sm text-slate-600">Total</div>
          <div class="kpi-v" id="eq_total"></div>
        </div>
        <div class="slim-card">
          <div class="text-sm text-slate-600">Class A</div>
          <div class="kpi-v" id="eq_class_a"></div>
        </div>
        <div class="slim-card">
          <div class="text-sm text-slate-600">Class B</div>
          <div class="kpi-v" id="eq_class_b"></div>
        </div>
        <div class="slim-card">
          <div class="text-sm text-slate-600">Class C</div>
          <div class="kpi-v" id="eq_class_c"></div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 mt-4">
      <div class="lg:col-span-4 card chart-card">
        <div class="text-slate-500 text-sm mb-2">Tickets Status</div>
        <canvas id="ticketsChart" height="170"></canvas>
      </div>
      <div class="lg:col-span-4 card chart-card">
        <div class="text-slate-500 text-sm mb-2">Total Equipment</div>
        <canvas id="totalEqChart" height="170"></canvas>
      </div>
      <div class="lg:col-span-4 card chart-card">
        <div class="text-slate-500 text-sm mb-2">PPM in this year</div>
        <canvas id="ppmYearChart" height="170"></canvas>
      </div>
    </section>

  </main>

  <!-- ===== Scripts ===== -->
  <script type="module">
    /* Firebase + Auth + اسم المستخدم + مؤشرات */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getCountFromServer, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import "../../js/roles.js";
    import "../../js/charts.js";  // يرسم الرسوم البيانية (كما عندك)

    const cfg = {
      apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
      authDomain:"pmqrtabuk.firebaseapp.com",
      projectId:"pmqrtabuk",
      storageBucket:"pmqrtabuk.firebasestorage.app",
      messagingSenderId:"305570616285",
      appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // بعد تحميل الهيدر
    document.addEventListener("partials:loaded", () => {
      // زر الخروج
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) {
        btnLogout.addEventListener("click", async () => {
          try { await signOut(auth); } finally { location.replace("../../login.html"); }
        });
      }

      // ✅ تمييز اللينك الحالي (Dashboard)
      const path = location.pathname.toLowerCase();
      document.querySelectorAll("#mainNav a").forEach(a => {
        const href = a.getAttribute("href")?.toLowerCase() || "";
        if (path.endsWith("dashboard/index.html") && href.includes("dashboard")) a.classList.add("active");
        else if (path.endsWith("assets/index.html") && href.includes("assets")) a.classList.add("active");
        else if (path.endsWith("preventive/index.html") && href.includes("preventive")) a.classList.add("active");
        else if (path.endsWith("corrective/index.html") && href.includes("corrective")) a.classList.add("active");
        else if (path.endsWith("sites/index.html") && href.includes("sites")) a.classList.add("active");
        else if (path.endsWith("users/index.html") && href.includes("users")) a.classList.add("active");
      });
    });

    // اسم المستخدم + تحميل KPIs
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.replace("../../login.html"); return; }

      // اسم المستخدم من users/{uid}.name أو displayName
      try{
        const snap = await getDoc(doc(db,'users', user.uid));
        const name = (snap.exists() && snap.data().name) ? snap.data().name : (user.displayName || user.email);
        const el = document.getElementById('userName');
        if (el) el.textContent = name || "";
      }catch{}

      // KPIs
      await loadKPIs();
    });

    async function loadKPIs(){
      try{
        const eqCol  = collection(db, 'assets');
        const woCol  = collection(db, 'workOrders'); // لو موجود

        // Total Equipment
        const eqTotalSnap = await getCountFromServer(eqCol);
        setTxt('eq_total', eqTotalSnap.data().count || '');

        // Class counts (A/B/C) — لو عندك field: class
        const aSnap = await getCountFromServer(query(eqCol, where('class','==','A')));
        const bSnap = await getCountFromServer(query(eqCol, where('class','==','B')));
        const cSnap = await getCountFromServer(query(eqCol, where('class','==','C')));
        setTxt('eq_class_a', aSnap.data().count || '');
        setTxt('eq_class_b', bSnap.data().count || '');
        setTxt('eq_class_c', cSnap.data().count || '');

        // Work Orders (لو عندك collection workOrders وفيلد status)
        const totalWO  = woCol ? (await getCountFromServer(woCol)).data().count : 0;
        const activeWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','active')))).data().count : '';
        const closedWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','closed')))).data().count : '';
        const assignedWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','assigned')))).data().count : '';
        const pendingSpareWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','pending_spare')))).data().count : '';
        const signedOffWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','signed_off')))).data().count : '';
        const pendingApprovalWO = woCol ? (await getCountFromServer(query(woCol, where('status','==','pending_approval')))).data().count : '';

        setTxt('wo_total', totalWO || '');
        setTxt('wo_active', activeWO);
        setTxt('wo_closed', closedWO);
        setTxt('wo_assigned', assignedWO);
        setTxt('wo_pending_spare', pendingSpareWO);
        setTxt('wo_signed_off', signedOffWO);
        setTxt('wo_pending_approval', pendingApprovalWO);
      }catch(err){
        console.error('KPIs error:', err);
      }
    }

    function setTxt(id, val){ const el=document.getElementById(id); if(el) el.textContent = val ?? ''; }
  </script>
</body>
</html>
