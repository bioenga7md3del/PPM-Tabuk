<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • الصيانة الوقائية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
</head>
<body>

  <!-- Header -->
  <header class="max-w-7xl mx-auto px-3 md:px-6 mt-3">
    <div class="topbar px-3 md:px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button class="icon-btn" title="القائمة">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M4 6h16M4 12h16M4 18h16" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <nav class="flex items-center gap-3 text-white/90">
        <a href="../dashboard/index.html">Dashboard</a>
        <a href="../assets/index.html">الأجهزة</a>
        <a href="../preventive/index.html" class="font-bold">الصيانة الوقائية</a>
        <a href="../corrective/index.html">الصيانة التصحيحية</a>
        <a href="../sites/index.html">المواقع</a>
        <a href="../users/index.html" id="navAdmin">المستخدمون</a>
      </nav>

      <div class="flex items-center gap-2">
        <div class="avatar">👤</div>
        <span id="userName" class="hidden sm:inline text-sm"></span>
        <button id="btnLogout" class="btn btn-ghost">تسجيل الخروج</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 md:p-6 space-y-6">
    
    <!-- فلاتر -->
    <section class="card p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
        <input id="f_control" class="field" placeholder="رقم التحكم"/>
        <input id="f_name" class="field" placeholder="اسم الجهاز"/>
        <input id="f_site" class="field" placeholder="الموقع"/>
        <input id="f_department" class="field" placeholder="القسم"/>
      </div>
    </section>

    <!-- جدول الأجهزة -->
    <section class="card p-3">
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800 text-slate-200">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Control</th>
              <th class="p-2">Name</th>
              <th class="p-2">Site</th>
              <th class="p-2">Department</th>
              <th class="p-2">Last PM</th>
              <th class="p-2">Next PM</th>
              <th class="p-2">QR / Sticker</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="pager" class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between p-2">
        <div id="pageStats" class="text-xs text-slate-400"></div>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-400">عدد الصفوف:</label>
          <select id="pageSize" class="px-2 py-1 rounded bg-slate-900 border border-slate-700 text-sm">
            <option>20</option><option selected>50</option><option>100</option><option>1000</option><option value="all">الكل</option>
          </select>
          <button id="prevPage" class="px-2 py-1 rounded bg-slate-700 text-slate-100 text-sm">السابق</button>
          <span id="pageInfo" class="text-xs text-slate-400 min-w-[4rem] text-center">1/1</span>
          <button id="nextPage" class="px-2 py-1 rounded bg-slate-700 text-slate-100 text-sm">التالي</button>
        </div>
      </div>
    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const cfg = {
      apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
      authDomain:"pmqrtabuk.firebaseapp.com",
      projectId:"pmqrtabuk",
      storageBucket:"pmqrtabuk.firebasestorage.app",
      messagingSenderId:"305570616285",
      appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const userNameEl = document.getElementById('userName');
    const btnLogout  = document.getElementById('btnLogout');
    const tbody      = document.getElementById('tbody');

    let ALL = [];
    let VIEW = [];
    let page = 1;

    const pageSizeEl = document.getElementById('pageSize');
    const pageInfoEl = document.getElementById('pageInfo');
    const pageStats  = document.getElementById('pageStats');
    const prevBtn    = document.getElementById('prevPage');
    const nextBtn    = document.getElementById('nextPage');

    const filters = {
      control: document.getElementById('f_control'),
      name: document.getElementById('f_name'),
      site: document.getElementById('f_site'),
      department: document.getElementById('f_department')
    };

    // --- تسجيل الدخول واسم المستخدم ---
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.replace("../../login.html"); return; }
      let name = user.displayName || "";
      try{
        const s = await getDoc(doc(db,'users', user.uid));
        if (s.exists() && s.data().name) name = s.data().name;
      }catch{}
      userNameEl.textContent = name || "بدون اسم";
      await loadPreventiveAssets();
    });

    btnLogout.addEventListener('click', async ()=>{
      try { await signOut(auth); } finally { location.replace("../../login.html"); }
    });

    // --- تحميل الأجهزة من Firestore ---
    async function loadPreventiveAssets(){
      const qs = await getDocs(query(collection(db,'assets'), orderBy('control')));
      ALL = qs.docs.map(d=> ({ id:d.id, ...d.data() }));
      applyFiltersAndRender();
      Object.values(filters).forEach(el=> el.addEventListener('input', ()=>{ page=1; applyFiltersAndRender(); }));
      pageSizeEl.addEventListener('change', ()=>{ page=1; renderTable(); });
      prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); }});
      nextBtn.addEventListener('click', ()=>{ const total=getTotalPages(); if(page<total){ page++; renderTable(); }});
    }

    // --- الفلاتر ---
    function normalize(v){ return String(v||'').toLowerCase().trim(); }
    function applyFiltersAndRender(){
      const q = {
        control: normalize(filters.control.value),
        name: normalize(filters.name.value),
        site: normalize(filters.site.value),
        department: normalize(filters.department.value),
      };
      VIEW = ALL.filter(x=>{
        const c = normalize(x.control || x.controlNumber || '');
        const n = normalize(x.name || x.deviceName || '');
        const s = normalize(x.site || '');
        const d = normalize(x.department || '');
        if(q.control && !c.includes(q.control)) return false;
        if(q.name && !n.includes(q.name)) return false;
        if(q.site && !s.includes(q.site)) return false;
        if(q.department && !d.includes(q.department)) return false;
        return true;
      });
      renderTable();
    }

    // --- الترقيم ---
    function getPageSize(){
      const v = pageSizeEl.value;
      if(v==='all') return VIEW.length || 1;
      return parseInt(v,10) || 50;
    }
    function getTotalPages(){
      const ps = getPageSize();
      return Math.max(1, Math.ceil((VIEW.length||0)/ps));
    }

    // --- عرض الجدول ---
    function renderTable(){
      const ps = getPageSize();
      const totalPages = getTotalPages();
      page = Math.min(page, totalPages);

      const start = (page-1)*ps;
      const chunk = VIEW.slice(start, start+ps);

      tbody.innerHTML = '';
      let i = start + 1;
      for(const a of chunk){
        const control = a.control || a.controlNumber || '';
        const name    = a.name || '';
        const site    = a.site || '';
        const dept    = a.department || '';
        const lastPM  = a.lastPM || a.pm || '';
        const nextPM  = a.nextPM || a.next || '';
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-200';
        tr.innerHTML = `
          <td class="p-2 text-center text-slate-500">${i++}</td>
          <td class="p-2">${escapeHtml(control)}</td>
          <td class="p-2">${escapeHtml(name)}</td>
          <td class="p-2">${escapeHtml(site)}</td>
          <td class="p-2">${escapeHtml(dept)}</td>
          <td class="p-2">${escapeHtml(lastPM)}</td>
          <td class="p-2">${escapeHtml(nextPM)}</td>
          <td class="p-2 text-center">
            <a href="qr.html?control=${encodeURIComponent(control)}" target="_blank" class="px-2 py-1 rounded bg-slate-700 text-white text-xs">QR</a>
            <a href="sticker.html#view/${encodeURIComponent(control)}" target="_blank" class="px-2 py-1 rounded bg-sky-600 text-white text-xs">Sticker</a>
          </td>
        `;
        tbody.appendChild(tr);
      }

      pageInfoEl.textContent = `${page}/${totalPages}`;
      const from = VIEW.length? (start+1) : 0;
      const to   = Math.min(start+chunk.length, VIEW.length);
      pageStats.textContent = `عرض ${from}–${to} من ${VIEW.length} جهاز`;
      prevBtn.disabled = (page<=1);
      nextBtn.disabled = (page>=totalPages);
    }

    function escapeHtml(s){
      return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
  </script>
</body>
</html>
