<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • Preventive Maintenance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
</head>

<body class="bg-slate-50 text-slate-800">

  <!-- HEADER -->
  <header class="max-w-7xl mx-auto px-3 md:px-6 mt-3">
    <div class="topbar px-3 md:px-4 py-2 flex items-center justify-between bg-slate-900 rounded-xl shadow">
      <nav class="flex items-center gap-3 text-white text-sm">
        <a href="../dashboard/index.html">Dashboard</a>
        <a href="../assets/index.html">Assets</a>
        <a href="../preventive/index.html" class="font-bold text-sky-400">Preventive</a>
        <a href="../corrective/index.html">Corrective</a>
        <a href="../sites/index.html">Sites</a>
        <a href="../users/index.html" id="navAdmin">Users</a>
      </nav>

      <div class="flex items-center gap-3">
        <div class="text-white text-sm flex items-center gap-2">
          <span id="userName" class="font-semibold"></span>
          <span class="text-slate-400">|</span>
          <button id="btnLogout" class="px-3 py-1 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 md:p-6 space-y-6">

    <!-- CREATE BUTTON -->
    <section class="flex flex-wrap justify-between items-center">
      <h1 class="text-xl font-bold text-slate-800">Preventive Maintenance</h1>
      <a href="PPMPlan" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-lg shadow">
        ➕ Create PPM Plan
      </a>
    </section>

    <!-- FILTERS -->
    <section class="card p-4 bg-white border rounded-xl shadow-sm">
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
        <input id="f_control" class="field" placeholder="Control Number"/>
        <input id="f_name" class="field" placeholder="Device Name"/>
        <select id="f_site" class="field"></select>
        <select id="f_department" class="field"></select>

        <!-- فلتر الشهر الحالي من Next PM -->
        <select id="f_due" class="field">
          <option value="">All</option>
          <option value="this_month">This Month (Next PM)</option>
          <option value="overdue_30">Overdue 30+ (Next PM)</option>
        </select>
      </div>
    </section>

    <!-- TABLE -->
    <section class="card p-3 bg-white border rounded-xl shadow-sm">
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800 text-white">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Control</th>
              <th class="p-2">Name</th>
              <th class="p-2">Site</th>
              <th class="p-2">Department</th>
              <th class="p-2">Last PM</th>
              <th class="p-2">Next PM</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div id="pager" class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between p-2">
        <div id="pageStats" class="text-xs text-slate-500"></div>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500">Rows per page:</label>
          <select id="pageSize" class="px-2 py-1 rounded bg-slate-100 border text-sm">
            <option>20</option><option selected>50</option><option>100</option><option>1000</option><option value="all">All</option>
          </select>
          <button id="prevPage" class="px-2 py-1 rounded bg-slate-700 text-white text-sm">Prev</button>
          <span id="pageInfo" class="text-xs text-slate-500 min-w-[4rem] text-center">1/1</span>
          <button id="nextPage" class="px-2 py-1 rounded bg-slate-700 text-white text-sm">Next</button>
        </div>
      </div>
    </section>
  </main>

  <!-- EDIT MODAL -->
  <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-5 w-full max-w-md text-slate-800">
      <h3 class="text-lg font-bold mb-4">Edit Preventive Data</h3>
      <input id="edit_id" type="hidden">
      <div class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Last PM Date</label>
          <input id="edit_last" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Next PM Date (auto +6 months)</label>
          <input id="edit_next" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-2 bg-slate-50" readonly>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="closeEdit" class="px-3 py-1 rounded bg-slate-300 hover:bg-slate-400">Cancel</button>
        <button id="saveEdit" class="px-3 py-1 rounded bg-sky-600 text-white hover:bg-sky-700">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, query, orderBy, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const cfg = {
      apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
      authDomain:"pmqrtabuk.firebaseapp.com",
      projectId:"pmqrtabuk",
      storageBucket:"pmqrtabuk.firebasestorage.app",
      messagingSenderId:"305570616285",
      appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const userName = document.getElementById('userName');
    const btnLogout = document.getElementById('btnLogout');
    const tbody = document.getElementById('tbody');

    const modal = document.getElementById('editModal');
    const editId = document.getElementById('edit_id');
    const editLast = document.getElementById('edit_last');
    const editNext = document.getElementById('edit_next');
    const closeEdit = document.getElementById('closeEdit');
    const saveEdit = document.getElementById('saveEdit');

    let ALL=[], VIEW=[], userSites=[], userDepts=[], page=1;

    const filters={
      control:document.getElementById('f_control'),
      name:document.getElementById('f_name'),
      site:document.getElementById('f_site'),
      department:document.getElementById('f_department'),
      due:document.getElementById('f_due')
    };

    const pageSizeEl=document.getElementById('pageSize');
    const pageInfoEl=document.getElementById('pageInfo');
    const pageStats=document.getElementById('pageStats');
    const prevBtn=document.getElementById('prevPage');
    const nextBtn=document.getElementById('nextPage');

    // === Helpers (تواريخ) ===
    const toISO = d => d ? new Date(d).toISOString().slice(0,10) : '';
    const parseDate = (v) => {
      if(!v) return null;
      // لو أصلاً YYYY-MM-DD
      if(/^\d{4}-\d{2}-\d{2}$/.test(String(v))) return new Date(String(v)+'T00:00:00');
      const t = new Date(v); return isNaN(t)? null : t;
    };
    const addMonths = (date, months=6) => {
      if(!date) return null;
      const d = new Date(date.getTime());
      const day = d.getDate();
      d.setMonth(d.getMonth()+months);
      // تلافي نهاية الشهور
      if(d.getDate() < day) d.setDate(0);
      d.setHours(0,0,0,0);
      return d;
    };
    const isInThisMonth = (v) => {
      const d = parseDate(v); if(!d) return false;
      const now = new Date(); return (d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth());
    };
    const isOverdue30 = (v) => {
      const d = parseDate(v); if(!d) return false;
      const now = new Date(); now.setHours(0,0,0,0);
      // متأخر أكثر من 30 يوم
      return (now - d) >= (31*24*60*60*1000);
    };

    // Auth Guard
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.replace("../../login.html"); return; }
      const snap = await getDoc(doc(db,'users',user.uid));
      let name=user.email;
      if(snap.exists()){
        const data=snap.data();
        name=data.name||user.email;
        userSites=data.sites||[];
        userDepts=data.departments||[];
      }
      userName.textContent=name;
      await fillFilters();
      await loadAssets();
    });

    btnLogout.addEventListener('click', async()=>{ try{await signOut(auth);}finally{location.replace("../../login.html");} });

    // Fill Site/Department filters
    async function fillFilters(){
      const qs = await getDocs(collection(db,'assets'));
      const sites = new Set(), depts = new Set();
      qs.forEach(d=>{
        const a=d.data();
        if(a.site) sites.add(a.site);
        if(a.department) depts.add(a.department);
      });
      const siteSel = filters.site;
      const deptSel = filters.department;
      siteSel.innerHTML='<option value="">All Sites</option>';
      deptSel.innerHTML='<option value="">All Departments</option>';
      [...sites].sort().forEach(s=>{
        if(userSites.length==0 || userSites.includes(s))
          siteSel.innerHTML += `<option value="${s}">${s}</option>`;
      });
      [...depts].sort().forEach(d=>{
        if(userDepts.length==0 || userDepts.includes(d))
          deptSel.innerHTML += `<option value="${d}">${d}</option>`;
      });
    }

    async function loadAssets(){
      const qs = await getDocs(query(collection(db,'assets'), orderBy('control')));
      ALL = qs.docs.map(d=>({id:d.id,...d.data()}));
      applyFiltersAndRender();

      // listeners
      const onChange = ()=>{ page=1; applyFiltersAndRender(); };
      filters.control.addEventListener('input', onChange);
      filters.name.addEventListener('input', onChange);
      filters.site.addEventListener('change', onChange);
      filters.department.addEventListener('change', onChange);
      filters.due.addEventListener('change', onChange);

      pageSizeEl.addEventListener('change', ()=>{page=1; renderTable();});
      prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); }});
      nextBtn.addEventListener('click', ()=>{ const total=getTotalPages(); if(page<total){ page++; renderTable(); }});
    }

    function normalize(v){ return String(v||'').toLowerCase().trim(); }

    function applyFiltersAndRender(){
      const q = {
        control: normalize(filters.control.value),
        name: normalize(filters.name.value),
        site: normalize(filters.site.value),
        department: normalize(filters.department.value),
        due: filters.due.value||''
      };
      VIEW = ALL.filter(x=>{
        const c=normalize(x.control||x.controlNumber||'');
        const n=normalize(x.name||x.deviceName||'');
        const s=normalize(x.site||'');
        const d=normalize(x.department||'');

        // تواريخ بمسميات مختلفة
        const last = x.pm_date || x.lastPM || x.pmDate || x.pm || '';
        const next = x.next_date || x.nextPM || x.nextPmDate || x.next || '';

        if(q.control && !c.includes(q.control)) return false;
        if(q.name && !n.includes(q.name)) return false;
        if(q.site && s!==q.site) return false;
        if(q.department && d!==q.department) return false;
        if(userSites.length && !userSites.includes(x.site)) return false;
        if(userDepts.length && !userDepts.includes(x.department)) return false;

        if(q.due==='this_month' && !isInThisMonth(next)) return false;
        if(q.due==='overdue_30' && !isOverdue30(next)) return false;

        return true;
      });
      renderTable();
    }

    function getPageSize(){
      const v=pageSizeEl.value;
      if(v==='all') return VIEW.length||1;
      return parseInt(v,10)||50;
    }
    function getTotalPages(){
      const ps=getPageSize();
      return Math.max(1,Math.ceil((VIEW.length||0)/ps));
    }

    function renderTable(){
      const ps=getPageSize();
      const total=getTotalPages();
      page=Math.min(page,total);
      const start=(page-1)*ps;
      const chunk=VIEW.slice(start,start+ps);
      tbody.innerHTML='';
      let i=start+1;
      for(const a of chunk){
        const control=a.control||a.controlNumber||'';
        const name=a.name||'';
        const site=a.site||'';
        const dept=a.department||'';

        // ✅ اقرأ آخر/الجاية من الحقول الصحيحة أولاً
        const last=a.pm_date||a.lastPM||a.pmDate||a.pm||'';
        const next=a.next_date||a.nextPM||a.nextPmDate||a.next||'';

        const tr=document.createElement('tr');
        tr.className='border-b border-slate-200';
        tr.innerHTML=`
          <td class="p-2 text-center">${i++}</td>
          <td class="p-2">${control||'—'}</td>
          <td class="p-2">${name||'—'}</td>
          <td class="p-2">${site||'—'}</td>
          <td class="p-2">${dept||'—'}</td>
          <td class="p-2">${last||'—'}</td>
          <td class="p-2">${next||'—'}</td>
          <td class="p-2 flex gap-2">
            <button data-edit="${a.id}" class="px-2 py-1 bg-amber-500 text-white text-xs rounded">Edit</button>
            <a href="qr.html?control=${encodeURIComponent(control)}" target="_blank" class="px-2 py-1 bg-slate-700 text-white text-xs rounded">QR</a>
            <a href="sticker.html#view/${encodeURIComponent(control)}" target="_blank" class="px-2 py-1 bg-sky-600 text-white text-xs rounded">Sticker</a>
          </td>
        `;
        tbody.appendChild(tr);
      }
      pageInfoEl.textContent=`${page}/${total}`;
      const from=VIEW.length?(start+1):0;
      const to=Math.min(start+chunk.length,VIEW.length);
      pageStats.textContent=`Showing ${from}–${to} of ${VIEW.length} devices`;
      prevBtn.disabled=(page<=1);
      nextBtn.disabled=(page>=total);
    }

    // === Edit modal ===
    document.addEventListener('click',(e)=>{
      const b=e.target.closest('button[data-edit]');
      if(!b) return;
      const id=b.dataset.edit;
      const dev=ALL.find(x=>x.id===id);
      if(!dev) return;
      editId.value=id;

      // حمّل Last من كل المسميات – والأولوية pm_date
      const lastRaw = dev.pm_date || dev.lastPM || dev.pmDate || dev.pm || '';
      const lastDate = parseDate(lastRaw);
      editLast.value = lastDate ? toISO(lastDate) : '';

      // احسب Next تلقائيًا +6 شهور
      const nextDate = addMonths(lastDate,6);
      editNext.value = nextDate ? toISO(nextDate) : '';

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    // كل ما Last يتغيّر — احسب Next +6
    editLast.addEventListener('input', ()=>{
      const d = parseDate(editLast.value);
      const n = addMonths(d,6);
      editNext.value = n ? toISO(n) : '';
    });

    closeEdit.onclick=()=>{modal.classList.add('hidden');modal.classList.remove('flex');};

    saveEdit.onclick=async()=>{
      const id=editId.value;
      const last=editLast.value||'';
      const next=editNext.value||'';
      try{
        // نكتب كل المسميات لضمان التوافق مع الصفحات الأخرى
        await updateDoc(doc(db,'assets',id),{
          pm_date:last,           // ✅ الأساسي
          next_date:next,         // ✅ الأساسي
          lastPM:last,            // دعم قديم
          nextPM:next,            // دعم قديم
          pmDate:last,            // دعم قديم
          nextPmDate:next,        // دعم قديم
          pm:last,                // دعم قديم
          next:next,              // دعم قديم
          updatedAt:serverTimestamp()
        });
        modal.classList.add('hidden');
        await loadAssets();
        alert('✅ Preventive data updated successfully');
      }catch(err){
        alert('❌ Update failed: '+err.message);
      }
    };
  </script>
</body>
</html>
