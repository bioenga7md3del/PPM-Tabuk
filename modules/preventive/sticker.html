<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PPM Tabuk – Sticker</title>
<style>
  :root{
    --card-w: 110mm;
    --card-h: 70mm;
    --pad: 6mm;
    --head-h: 22mm;
    --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --ok:#16a34a; --late:#ef4444;
    --fs: 11px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#f3f4f6;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .card{
    width:var(--card-w); height:var(--card-h);
    background:#fff;border:2px solid var(--line);border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.12);
    display:grid;grid-template-rows:var(--head-h) 1fr;
    padding:0 var(--pad) var(--pad);
    position:relative; overflow:hidden;
  }
  .card.ok{border-color:var(--ok)}
  .card.late{border-color:var(--late)}

  .head{display:grid;grid-template-rows:1fr auto;gap:3mm;padding-top:3mm}
  .logos{display:flex;align-items:center;justify-content:space-between;gap:10mm;padding:0 2mm}
  .logo{max-height:9mm;max-width:36mm;object-fit:contain;display:block}
  .title-ar{font-weight:900;font-size:20px;text-align:center;letter-spacing:.2px}

  .body{
    margin-top:2mm;
    display:grid; grid-template-columns:30% 70%;
    column-gap:4mm; row-gap:1mm; font-size:var(--fs); line-height:1.28;
    text-align:left; direction:ltr;
  }
  .k{color:var(--muted)}
  .v{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .watermark{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:34px; color:rgba(239,68,68,.18); font-weight:900; transform:rotate(-18deg);
    pointer-events:none; z-index:0;
  }

  .toolbar{position:fixed;left:0;right:0;bottom:12px;display:flex;gap:10px;justify-content:center}
  .btn{padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:10px;font-weight:700;cursor:pointer}

  @media print{
    @page{size:landscape;margin:8mm}
    body{background:#fff}
    .toolbar{display:none}
    .stage{position:relative;inset:auto}
    .card{box-shadow:none;margin:0 auto}
  }
</style>
  <link rel="stylesheet" href="../../css/theme-light.css">
</head>

<body>
  <div class="stage" id="stage">
    <div class="card" id="card">
      <div class="head">
        <div class="logos">
          <img class="logo" id="logoCompany" alt="FGC"/>
          <img class="logo" id="logoCluster" alt="Tabuk"/>
        </div>
        <div class="title-ar">الصيانة الوقائية</div>
      </div>

      <div class="body">
        <div class="k">Control</div>     <div class="v" id="v_control">—</div>
        <div class="k">Name</div>        <div class="v" id="v_name">—</div>
        <div class="k">Brand</div>       <div class="v" id="v_brand">—</div>
        <div class="k">Serial</div>      <div class="v" id="v_serial">—</div>
        <div class="k">PM Date</div>     <div class="v" id="v_pm">—</div>
        <div class="k">Next PM</div>     <div class="v" id="v_next">—</div>
        <div class="k">Technician</div>  <div class="v" id="v_tech">—</div>
        <div class="k">Site</div>        <div class="v" id="v_site">—</div>
        <div class="k">Department</div>  <div class="v" id="v_dept">—</div>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn" id="pdfBtn">Download PDF</button>
  </div>

  <!-- PDF libraries -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    /* ==== CONFIG ==== */
    const COMPANY_LOGO_URL = "../../assets/FGC.jpeg";
    const CLUSTER_LOGO_URL = "../../assets/TabukCluster.jpeg";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } 
      from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
      authDomain:"pmqrtabuk.firebaseapp.com",
      projectId:"pmqrtabuk",
      storageBucket:"pmqrtabuk.firebasestorage.app",
      messagingSenderId:"305570616285",
      appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const $ = s=>document.querySelector(s);

    function fmt(v){return v?v:'—';}
    function statusOf(pm,next){
      if(!next) return 'ok';
      const now=new Date(), n=new Date(next);
      return (n<now)?'overdue':'ok';
    }

    async function main(){
      const hash=location.hash.replace('#view/','').trim();
      if(!hash) return;
      const q=query(collection(db,'assets'), where('control','==',hash));
      const snap=await getDocs(q);
      if(snap.empty) return alert('Device not found');
      const d=snap.docs[0].data();

      $("#v_control").textContent=d.control||'—';
      $("#v_name").textContent=d.name||'—';
      $("#v_brand").textContent=d.brand||'—';
      $("#v_serial").textContent=d.serial||'—';
      $("#v_pm").textContent=fmt(d.pm_date||d.pm||d.lastPM);
      $("#v_next").textContent=fmt(d.next_date||d.next||d.nextPM);
      $("#v_tech").textContent=d.tech||'—';
      $("#v_site").textContent=d.site||'—';
      $("#v_dept").textContent=d.department||'—';

      // حالة الكارت
      const card=$("#card");
      if(statusOf(d.pm_date||d.pm,d.next_date||d.next)==='overdue'){
        card.classList.add('late');
        const wm=document.createElement('div');
        wm.className='watermark'; wm.textContent='Expired';
        card.appendChild(wm);
      }else{card.classList.add('ok');}

      // تحميل الشعارات
      $("#logoCompany").src=COMPANY_LOGO_URL;
      $("#logoCluster").src=CLUSTER_LOGO_URL;
    }

    main();

    document.getElementById('pdfBtn').addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf;
      const node=document.getElementById('card');
      const canvas=await html2canvas(node);
      const img=canvas.toDataURL('image/png');
      const pdf=new jsPDF({orientation:'landscape',unit:'mm',format:'a5'});
      pdf.addImage(img,'PNG',5,5,200,130);
      pdf.save('PPM-Sticker.pdf');
    });
  </script>
</body>
</html>
