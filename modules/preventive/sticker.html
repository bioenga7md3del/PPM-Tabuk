<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PPM Tabuk – Sticker</title>
<style>
  :root{
    --card-w: 110mm;   /* عرض الكارت */
    --card-h: 70mm;    /* ارتفاع الكارت */
    --pad: 6mm;
    --head-h: 22mm;    /* الهيدر بقى أعلى (شعارات + عنوان عربي) */
    --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --ok:#16a34a; --late:#ef4444;
    --fs: 11px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#f3f4f6;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .card{
    width:var(--card-w); height:var(--card-h);
    background:#fff;border:2px solid var(--line);border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.12);
    display:grid;grid-template-rows:var(--head-h) 1fr;
    padding:0 var(--pad) var(--pad);
    position:relative; overflow:hidden;   /* يمنع خروج أي عنصر خارج الإطار */
  }
  .card.ok{border-color:var(--ok)}
  .card.late{border-color:var(--late)}

  /* الهيدر: صف شعارات + عنوان عربي أسفله */
  .head{display:grid;grid-template-rows:1fr auto;gap:3mm;padding-top:3mm}
  .logos{display:flex;align-items:center;justify-content:space-between;gap:10mm;padding:0 2mm}
  .logo{max-height:9mm;max-width:36mm;object-fit:contain;display:block}
  .title-ar{font-weight:900;font-size:20px;text-align:center;letter-spacing:.2px}

  /* جسم البيانات */
  .body{
    margin-top:2mm;
    display:grid; grid-template-columns:30% 70%;
    column-gap:4mm; row-gap:1mm; font-size:var(--fs); line-height:1.28;
    text-align:left; direction:ltr;      /* إنجليزي من الشمال */
  }
  .k{color:var(--muted)}
  .v{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* وسم “منتهي” */
  .watermark{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:34px; color:rgba(239,68,68,.18); font-weight:900; transform:rotate(-18deg);
    pointer-events:none; z-index:0;
  }

  .toolbar{position:fixed;left:0;right:0;bottom:12px;display:flex;gap:10px;justify-content:center}
  .btn{padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:10px;font-weight:700;cursor:pointer}

  /* طباعة */
  @media print{
    @page{size:landscape;margin:8mm}
    body{background:#fff}
    .toolbar{display:none}
    .stage{position:relative;inset:auto}
    .card{box-shadow:none;margin:0 auto}
  }
</style>
  <link rel="stylesheet" href="../css/theme-light.css">
</head>
<body>
  <div class="stage" id="stage">
    <div class="card" id="card">
      <div class="head">
        <div class="logos">
          <img class="logo" id="logoCompany" alt="FGC"/>
          <img class="logo" id="logoCluster" alt="Tabuk"/>
        </div>
        <div class="title-ar">الصيانة الوقائية</div>
      </div>

      <div class="body">
        <div class="k">Control</div>     <div class="v" id="v_control">—</div>
        <div class="k">Name</div>        <div class="v" id="v_name">—</div>
        <div class="k">Brand</div>       <div class="v" id="v_brand">—</div>
        <div class="k">Serial</div>      <div class="v" id="v_serial">—</div>
        <div class="k">PM Date</div>     <div class="v" id="v_pm">—</div>
        <div class="k">Next PM</div>     <div class="v" id="v_next">—</div>
        <div class="k">Technician</div>  <div class="v" id="v_tech">—</div>
        <div class="k">Site</div>        <div class="v" id="v_site">—</div>
        <div class="k">Department</div>  <div class="v" id="v_dept">—</div>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn" id="pdfBtn">Download PDF</button>
  </div>

  <!-- توليد PDF من الكارت -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
  /* روابط الشعارات داخل الريبو (تقدر تغيّرها لو حاططهم بمكان مختلف) */
  const COMPANY_LOGO_URL = "assets/FGC.jpeg";
  const CLUSTER_LOGO_URL = "assets/TabukCluster.jpeg";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
    authDomain:"pmqrtabuk.firebaseapp.com",
    projectId:"pmqrtabuk",
    storageBucket:"pmqrtabuk.firebasestorage.app",
    messagingSenderId:"305570616285",
    appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const $ = s=>document.querySelector(s);
  const safeId = s => (s||"").trim().replace(/[\/#?\s]/g,"-");
  const fmt = d => d ? new Date(d).toISOString().slice(0,10) : "—";

  function statusOf(pm, next){
    if(!next) return 'active';
    const t=new Date(); t.setHours(0,0,0,0);
    const n=new Date(next); n.setHours(0,0,0,0);
    const grace=new Date(n); grace.setDate(grace.getDate()+30); // شهر سماح بعد Next PM
    return (t>grace)?'overdue':'active';
  }

  async function setImg(el, url){
    try{
      await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(); i.onerror=rej; i.src=url; });
      el.src=url;
    }catch{ el.style.display='none'; }
  }

  // ملاءمة أبعاد الكارت مع الشاشة (وتدوير تلقائي)
  function mmToPx(mm){ return parseFloat(mm)*3.7795; }
  function layout(){
    const card=$('#card');
    const cw=mmToPx(getComputedStyle(card).getPropertyValue('--card-w'));
    const ch=mmToPx(getComputedStyle(card).getPropertyValue('--card-h'));
    const vw=innerWidth, vh=innerHeight;

    if(vh>vw){ // Portrait → لفّ
      const scale=Math.min(vw/ch, vh/cw)*0.98;
      card.style.transformOrigin='center center';
      card.style.transform=`rotate(90deg) scale(${scale})`;
    }else{
      const scale=Math.min(vw/cw, vh/ch)*0.98;
      card.style.transformOrigin='center center';
      card.style.transform=`scale(${scale})`;
    }
  }

  async function loadSticker(){
    // شعارات
    setImg($('#logoCompany'), COMPANY_LOGO_URL);
    setImg($('#logoCluster'), CLUSTER_LOGO_URL);

    // رقم الجهاز من الـhash
    const h = (location.hash||"").split('/')[1];
    const controlRaw = h ? decodeURIComponent(h) : "";
    if(!controlRaw) return;

    // جلب البيانات
    let snap = await getDoc(doc(db,'assets', safeId(controlRaw)));
    if(!snap.exists()){
      const qs = await getDocs(query(collection(db,'assets'), where('control','==', controlRaw)));
      snap = qs.docs[0];
    }
    if(!snap||!snap.exists()) return;
    const d=snap.data();

    // ملء الحقول
    $('#v_control').textContent = d.control || controlRaw;
    $('#v_name').textContent    = d.name   || "—";
    $('#v_brand').textContent   = d.brand  || "—";
    $('#v_serial').textContent  = d.serial || "—";
    $('#v_pm').textContent      = fmt(d.pm_date);
    $('#v_next').textContent    = fmt(d.next_date);
    $('#v_tech').textContent    = d.tech   || "—";
    $('#v_site').textContent    = d.site   || "—";
    $('#v_dept').textContent    = d.department || "—";

    // حالة ساري/منتهي
    const card=$('#card');
    card.classList.remove('ok','late');
    [...card.querySelectorAll('.watermark')].forEach(x=>x.remove());
    if(statusOf(d.pm_date,d.next_date)==='overdue'){
      card.classList.add('late');
      const wm=document.createElement('div'); wm.className='watermark'; wm.textContent='Expired'; card.appendChild(wm);
    }else{ card.classList.add('ok'); }
  }

  // PDF
  document.getElementById('pdfBtn').addEventListener('click', async ()=>{
    const { jsPDF } = window.jspdf;
    const node=document.getElementById('card');
    const prev=node.style.transform;
    node.style.transform='none';
    await new Promise(r=>setTimeout(r,50));
    const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'});
    const img=canvas.toDataURL('image/png');
    const wmm=parseFloat(getComputedStyle(node).getPropertyValue('--card-w'));
    const hmm=parseFloat(getComputedStyle(node).getPropertyValue('--card-h'));
    const pdf=new jsPDF({orientation:'landscape',unit:'mm',format:[wmm,hmm]});
    pdf.addImage(img,'PNG',0,0,wmm,hmm);
    pdf.save((document.getElementById('v_control').textContent||'sticker')+'.pdf');
    node.style.transform=prev; layout();
  });

  window.addEventListener('resize', layout);
  window.addEventListener('orientationchange', layout);
  window.addEventListener('load', async()=>{ await loadSticker(); layout(); });
  window.addEventListener('hashchange', async()=>{ await loadSticker(); layout(); });
  </script>
</body>
</html>
