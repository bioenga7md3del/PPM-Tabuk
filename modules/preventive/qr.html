<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø·Ø¨Ø§Ø¹Ø© Ø£ÙƒÙˆØ§Ø¯ QR â€” A4 (Single / Dept / Custom)</title>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  :root{ --ink:#0f172a; --line:#e5e7eb; }
  body{ background:#f8fafc; color:var(--ink); }
  .card{ background:#fff; border:1px solid var(--line); border-radius:12px; }
  .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }

  .sheet{ margin:16px auto; box-shadow:0 10px 30px rgba(0,0,0,.08); background:#fff; }
  .page{ position:relative; background:#fff; overflow:hidden; page-break-after:always; }
  .grid{ display:grid; page-break-inside:avoid; }

  .label{
    border:1px dashed rgba(15,23,42,.15);
    border-radius:4px;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    page-break-inside:avoid;
  }
  .l-ctrl{ font-weight:900; line-height:1.1; text-align:center; }
  .l-title{ font-weight:800; text-align:center; }

  /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø§Ø®ÙÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (#.no-print) ÙˆØ§Ø·Ø¨Ø¹ Ø§Ù„Ø´Ø¨ÙƒØ© ÙÙ‚Ø· */
  @media print{
    @page{ size:A4; margin:0 }
    body{ background:#fff; margin:0; padding:0 }
    .no-print{ display:none !important; }
    .sheet{ margin:0 !important; box-shadow:none !important; }
    .page{ page-break-after:always; }
    .label{ border:0; }
  }
</style>
  <link rel="stylesheet" href="../css/theme-light.css">
</head>
<body>
<header class="no-print sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="font-extrabold text-lg">Ø·Ø¨Ø§Ø¹Ø© Ø£ÙƒÙˆØ§Ø¯ QR â€” A4</h1>
    <div class="flex items-center gap-2">
      <button id="btnBuild" class="px-3 py-2 rounded bg-emerald-600 text-white font-bold">âš™ï¸ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙØ­Ø§Øª</button>
      <button id="btnPrint" class="px-3 py-2 rounded bg-sky-600 text-white font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¶Ø¹ -->
  <section class="card p-4 mb-4 no-print">
    <div class="grid md:grid-cols-3 gap-3">
      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„ÙˆØ¶Ø¹</label>
        <select id="mode" class="w-full px-3 py-2 border rounded">
          <option value="single" selected>Ù…ÙØ±Ø¯ (Control ÙˆØ§Ø­Ø¯)</option>
          <option value="dept">Ù‚Ø³Ù… ÙƒØ§Ù…Ù„ (Ù…Ù† Firestore)</option>
          <option value="custom">Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØµØµØ©</option>
        </select>
      </div>

      <!-- Ù…ÙØ±Ø¯ -->
      <div id="singleBox" class="grid grid-cols-2 md:col-span-2 gap-3">
        <div class="col-span-2">
          <label class="block text-sm text-slate-600 mb-1">Control Number</label>
          <input id="singleControl" class="w-full px-3 py-2 border rounded mono" placeholder="Ù…Ø«Ø§Ù„: AS-0001"/>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø£Ø¹Ù„Ù‰</label>
          <input id="titleSingle" class="w-full px-3 py-2 border rounded" value="Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Ø­Ø¬Ù… QR (Ù…Ù…)</label>
          <input id="qrSingle" type="number" class="w-full px-3 py-2 border rounded" value="60">
        </div>
      </div>

      <!-- Ù‚Ø³Ù… -->
      <div id="deptBox" class="hidden md:col-span-2 grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Site</label>
          <select id="siteSel" class="w-full px-3 py-2 border rounded"><option value="">â€” Ø§Ø®ØªÙŠØ§Ø± â€”</option></select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Department</label>
          <select id="deptSel" class="w-full px-3 py-2 border rounded"><option value="">â€” Ø§Ø®ØªÙŠØ§Ø± â€”</option></select>
        </div>
      </div>

      <!-- Ù…Ø®ØµØµ -->
      <div id="customBox" class="hidden md:col-span-2">
        <label class="block text-sm text-slate-600 mb-1">Ù‚Ø§Ø¦Ù…Ø© Control (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)</label>
        <textarea id="controls" class="w-full h-40 px-3 py-2 border rounded mono" placeholder="AS-0001&#10;AS-0002"></textarea>
      </div>
    </div>
  </section>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© -->
  <section class="card p-4 mb-6 no-print">
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label>
        <select id="orientation" class="w-full px-3 py-2 border rounded">
          <option value="portrait" selected>A4 Ø·ÙˆÙ„ÙŠ (210Ã—297)</option>
          <option value="landscape">A4 Ø¹Ø±Ø¶ÙŠ (297Ã—210)</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-slate-600 mb-1">Ù‡Ø§Ù…Ø´ Ø§Ù„ØµÙØ­Ø© (Ù…Ù…)</label>
        <input id="marginMM" type="number" class="w-full px-3 py-2 border rounded" value="10">
      </div>
      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø£Ø¹Ù„Ù‰ ÙƒÙ„ Ù„Ø§Ø¨Ù„</label>
        <input id="title" class="w-full px-3 py-2 border rounded" value="Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©">
      </div>

      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¨Ù„ (Ù…Ù…)</label>
        <input id="lw" type="number" class="w-full px-3 py-2 border rounded" value="50">
      </div>
      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù„Ø§Ø¨Ù„ (Ù…Ù…)</label>
        <input id="lh" type="number" class="w-full px-3 py-2 border rounded" value="25">
      </div>
      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø­Ø´Ùˆ Ø¯Ø§Ø®Ù„ÙŠ (Ù…Ù…)</label>
        <input id="padMM" type="number" class="w-full px-3 py-2 border rounded" value="2">
      </div>

      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø­Ø¬Ù… Ø§Ù„Ù€QR (Ù…Ù…)</label>
        <input id="qrMM" type="number" class="w-full px-3 py-2 border rounded" value="22">
      </div>
      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø­Ø¬Ù… Ø§Ù„Ù†Øµ (pt)</label>
        <input id="fontPt" type="number" class="w-full px-3 py-2 border rounded" value="10">
      </div>

      <div class="flex items-center gap-2">
        <input id="showTitle" type="checkbox" class="w-4 h-4" checked>
        <label for="showTitle" class="text-sm text-slate-700">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
      </div>
      <div class="flex items-center gap-2">
        <input id="showCtrl" type="checkbox" class="w-4 h-4" checked>
        <label for="showCtrl" class="text-sm text-slate-700">Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù€Control</label>
      </div>
    </div>

    <div class="flex gap-2 flex-wrap mt-3">
      <button id="preset_5x2_5" class="px-2 py-1 rounded border">Preset: 50Ã—25 Ù…Ù…</button>
      <button id="preset_38x19" class="px-2 py-1 rounded border">Preset: 38Ã—19 Ù…Ù…</button>
      <button id="preset_60x40" class="px-2 py-1 rounded border">Preset: 60Ã—40 Ù…Ù…</button>
    </div>
  </section>

  <!-- ØµÙØ­Ø§Øª A4 Ø§Ù„Ù†Ø§ØªØ¬Ø© (Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªØªØ·Ø¨Ø¹) -->
  <section id="sheets" class="sheet"></section>
</main>

<!-- Firestore Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø³Ù… -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // Firebase config (Ù…Ø´Ø±ÙˆØ¹Ùƒ)
  const firebaseConfig = {
    apiKey: "AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
    authDomain: "pmqrtabuk.firebaseapp.com",
    projectId: "pmqrtabuk",
    storageBucket: "pmqrtabuk.firebasestorage.app",
    messagingSenderId: "305570616285",
    appId: "1:305570616285:web:4f6839fd08b8b5aa131c34"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const mm = v => `${v}mm`;
  const pt = v => `${v}pt`;
  const mmToPx = v => Math.round(v * 11.8);

  const buildQRPayload = (control)=>{
    const stickerAbs = new URL('sticker.html', location.href).toString();
    return `${stickerAbs}#view/${encodeURIComponent(control)}`;
  };
  async function toQR(text, sizePx){
    try{ return await QRCode.toDataURL(text,{ width:sizePx, margin:0, errorCorrectionLevel:'M' }); }
    catch{ return 'https://chart.googleapis.com/chart?cht=qr&chs='+sizePx+'x'+sizePx+'&chl='+encodeURIComponent(text); }
  }

  function switchMode(m){
    $('#singleBox').classList.toggle('hidden', m!=='single');
    $('#deptBox').classList.toggle('hidden',   m!=='dept');
    $('#customBox').classList.toggle('hidden', m!=='custom');
  }
  $('#mode').addEventListener('change', e=> switchMode(e.target.value));

  async function loadSitesDepts(){
    const qs = await getDocs(query(collection(db,'assets'), orderBy('site')));
    const arr = qs.docs.map(d=> d.data());
    const sites = [...new Set(arr.map(x=>x.site).filter(Boolean))].sort();
    const depts = [...new Set(arr.map(x=>x.department).filter(Boolean))].sort();
    $('#siteSel').innerHTML = '<option value="">â€” Ø£ÙŠ Ù…ÙˆÙ‚Ø¹ â€”</option>' + sites.map(s=>`<option>${s}</option>`).join('');
    $('#deptSel').innerHTML = '<option value="">â€” Ø£ÙŠ Ù‚Ø³Ù… â€”</option>' + depts.map(s=>`<option>${s}</option>`).join('');
  }

  // ØµÙØ­Ø© Grid
  async function buildPage(controls, pageW, pageH, margin, gapX, gapY, labelW, labelH, padMM, qrMM, fontPt, titleText, showTitle, showCtrl){
    const cols = Math.max(1, Math.floor((pageW - 2*margin + gapX) / (labelW + gapX)));
    const rows = Math.max(1, Math.floor((pageH - 2*margin + gapY) / (labelH + gapY)));
    const perPage = cols * rows;

    const page = document.createElement('div');
    page.className = 'page';
    page.style.width  = mm(pageW);
    page.style.height = mm(pageH);

    const grid = document.createElement('div');
    grid.className = 'grid';
    grid.style.position = 'absolute';
    grid.style.left   = mm(margin);
    grid.style.top    = mm(margin);
    grid.style.right  = mm(margin);
    grid.style.bottom = mm(margin);
    grid.style.gridTemplateColumns = `repeat(${cols}, ${mm(labelW)})`;
    grid.style.gridAutoRows        = mm(labelH);
    grid.style.columnGap = mm(gapX);
    grid.style.rowGap    = mm(gapY);

    const need = Math.min(perPage, controls.length);
    const qrPx = Math.max(300, mmToPx(qrMM) * 2);
    const pending = [];

    for(let i=0;i<need;i++){
      const control = controls[i];

      const label = document.createElement('div');
      label.className = 'label';
      label.style.width  = mm(labelW);
      label.style.height = mm(labelH);
      label.style.padding = mm(padMM);

      if(showTitle){
        const title = document.createElement('div');
        title.className = 'l-title';
        title.textContent = titleText || '';
        title.style.fontSize = pt(Math.max(7, Math.round(fontPt*0.9)));
        title.style.marginBottom = mm(1);
        label.appendChild(title);
      }

      const img = document.createElement('img');
      img.alt = 'QR';
      img.style.display = 'block';
      img.style.width   = mm(qrMM);
      img.style.height  = mm(qrMM);
      img.style.objectFit='contain';
      img.style.margin  = '0 auto';
      label.appendChild(img);

      if(showCtrl){
        const ctrl = document.createElement('div');
        ctrl.className = 'l-ctrl mono';
        ctrl.textContent = control;
        ctrl.style.fontSize = pt(fontPt);
        ctrl.style.marginTop = mm(1.2);
        label.appendChild(ctrl);
      }

      grid.appendChild(label);

      const payload = buildQRPayload(control);
      pending.push( toQR(payload, qrPx).then(url => { img.src = url; }) );
    }

    page.appendChild(grid);
    return { page, perPage, pending };
  }

  // Ù…ÙØ±Ø¯: ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø¨Ù‡Ø§Ù…Ø´
  async function buildSingle(control, titleText, qrMM, showTitle, showCtrl){
    const orient = $('#orientation').value;
    const pageW = orient==='portrait' ? 210 : 297;
    const pageH = orient==='portrait' ? 297 : 210;
    const pageMargin = parseFloat($('#marginMM').value || '10');

    const page = document.createElement('div');
    page.className = 'page';
    page.style.width  = mm(pageW);
    page.style.height = mm(pageH);

    const wrap = document.createElement('div');
    wrap.style.position='absolute';
    wrap.style.inset='0';
    wrap.style.display='flex';
    wrap.style.alignItems='flex-start';
    wrap.style.justifyContent='flex-start';
    wrap.style.padding = mm(pageMargin);

    const label = document.createElement('div');
    label.className = 'label';
    const padMM = 3;
    label.style.width  = mm(Math.min(120, pageW - pageMargin*2));
    label.style.height = mm(Math.min(80,  pageH - pageMargin*2));
    label.style.padding= mm(padMM);

    if(showTitle){
      const title = document.createElement('div');
      title.className = 'l-title';
      title.textContent = titleText || '';
      title.style.fontSize = pt(14);
      title.style.marginBottom = mm(2);
      label.appendChild(title);
    }

    const img = document.createElement('img');
    img.alt = 'QR';
    img.style.display='block';
    img.style.width = mm(qrMM);
    img.style.height= mm(qrMM);
    img.style.objectFit='contain';
    img.style.margin='0 auto';
    label.appendChild(img);

    if(showCtrl){
      const ctrl = document.createElement('div');
      ctrl.className = 'l-ctrl mono';
      ctrl.textContent = control;
      ctrl.style.fontSize = pt(14);
      ctrl.style.marginTop = mm(2);
      label.appendChild(ctrl);
    }

    wrap.appendChild(label);
    page.appendChild(wrap);

    const qrPx = Math.max(300, mmToPx(qrMM) * 2);
    const payload = buildQRPayload(control);
    await toQR(payload, qrPx).then(url => { img.src = url; });

    return page;
  }

  // Ø¨Ù†Ø§Ø¡ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
  async function buildSheets(){
    const orient = $('#orientation').value;
    const pageW = orient==='portrait' ? 210 : 297;
    const pageH = orient==='portrait' ? 297 : 210;

    const sheets = $('#sheets');
    sheets.innerHTML = '';
    sheets.style.width  = mm(pageW);
    sheets.style.minHeight = mm(pageH);

    const mode = $('#mode').value;
    const showTitle = $('#showTitle').checked;
    const showCtrl  = $('#showCtrl').checked;

    if(mode==='single'){
      const control = ($('#singleControl').value || '').trim();
      if(!control){ alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù€Control'); return; }
      const page = await buildSingle(control, ($('#titleSingle').value||'').trim() || $('#title').value, parseFloat($('#qrSingle').value||'60'), showTitle, showCtrl);
      sheets.appendChild(page);
      return;
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
    const margin = parseFloat($('#marginMM').value || '10');
    const gapX   = 4, gapY = 6;
    const labelW = parseFloat($('#lw').value || '50');
    const labelH = parseFloat($('#lh').value || '25');
    const padMM  = parseFloat($('#padMM').value || '2');
    const qrMM   = parseFloat($('#qrMM').value || '22');
    const fontPt = Math.max(7, parseInt($('#fontPt').value || '10',10));
    const titleText = ($('#title').value || '').trim();

    let controls = [];

    if(mode==='custom'){
      controls = ($('#controls').value || '').split('\n').map(s=>s.trim()).filter(Boolean);
      if(!controls.length){ alert('Ø§ÙƒØªØ¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€Control'); return; }
    } else if(mode==='dept'){
      const all = (await getDocs(query(collection(db,'assets'), orderBy('control')))).docs.map(d=> d.data());
      controls = all.filter(x=>{
        const sOK = !$('#siteSel').value || x.site=== $('#siteSel').value;
        const dOK = !$('#deptSel').value || x.department=== $('#deptSel').value;
        return sOK && dOK;
      }).map(x=> x.control).filter(Boolean);
      if(!controls.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±'); return; }
    }

    // ØªÙ‚Ø³ÙŠÙ… Ø¹Ù„Ù‰ ØµÙØ­Ø§Øª
    let rest = controls.slice();
    while(rest.length){
      const { page, perPage, pending } = await buildPage(rest, pageW, pageH, margin, gapX, gapY, labelW, labelH, padMM, qrMM, fontPt, titleText, showTitle, showCtrl);
      sheets.appendChild(page);
      if(pending?.length) await Promise.all(pending);
      rest = rest.slice(perPage);
    }
  }

  // Ø£Ø²Ø±Ø§Ø±
  document.getElementById('btnBuild').addEventListener('click', buildSheets);
  document.getElementById('btnPrint').addEventListener('click', async ()=>{
    if(!document.getElementById('sheets').children.length) await buildSheets();
    const imgs = Array.from(document.querySelectorAll('#sheets img'));
    await Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(r => { img.onload=r; img.onerror=r; })));
    window.print();
  });

  // Presets
  document.getElementById('preset_5x2_5').addEventListener('click', ()=>{
    $('#lw').value=50; $('#lh').value=25; $('#qrMM').value=22; $('#padMM').value=2; $('#fontPt').value=10;
  });
  document.getElementById('preset_38x19').addEventListener('click', ()=>{
    $('#lw').value=38; $('#lh').value=19; $('#qrMM').value=16; $('#padMM').value=2; $('#fontPt').value=9;
  });
  document.getElementById('preset_60x40').addEventListener('click', ()=>{
    $('#lw').value=60; $('#lh').value=40; $('#qrMM').value=30; $('#padMM').value=3; $('#fontPt').value=12;
  });

  // Ù…Ù„Ø¡ Site/Dept
  loadSitesDepts().catch(()=>{});

  // Deep-link: Ù…ÙØ±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø§ ØªÙŠØ¬ÙŠ Ù…Ù† index
  (async function initFromQS(){
    const p = new URLSearchParams(location.search);
    const controlQS = p.get('control');
    const autoprint = p.get('autoprint');

    if(controlQS){
      $('#mode').value = 'single';
      switchMode('single');
      $('#singleControl').value = decodeURIComponent(controlQS);
      await buildSheets();
      if(autoprint==='1'){
        const imgs = Array.from(document.querySelectorAll('#sheets img'));
        await Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(r => { img.onload=r; img.onerror=r; })));
        window.print();
      }
    }else{
      switchMode('single'); // Ø§ÙØªØ±Ø§Ø¶ÙŠ
    }

    // Ù…Ø«Ø§Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ custom
    document.getElementById('controls').value = ['AS-0001','AS-0002','AS-0003','AS-0004','AS-0005','AS-0006'].join('\n');
  })();
</script>
</body>
</html>
