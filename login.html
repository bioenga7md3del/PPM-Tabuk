<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • تسجيل الدخول</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/PPM-Tabuk/assets/favicon.ico"/>
  <style>
    /* لوحة يسار مستوحاة من المرجع */
    .hero-bg{
      background:#5ea2ff; /* أزرق قريب من الصورة */
      background-image:
        radial-gradient(1100px 600px at 120% -20%, rgba(255,255,255,.25) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(800px 500px at -10% 110%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 55%);
    }
    .glass{
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border:1px solid rgba(255,255,255,.45);
      border-radius: 18px;
      box-shadow:0 12px 30px rgba(2,6,23,.10);
    }
    .inp{border:1px solid #e5e7eb;border-radius:12px;padding:.9rem 1rem;width:100%;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:12px;padding:.9rem 1rem;font-weight:800}
    .btn-primary{background:#1d4ed8;color:#fff}
    .btn-soft{background:#eef2f7}
    .muted{color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:999px;font-size:.75rem}
    .badge-ok{background:rgba(16,185,129,.12);color:#047857}
    .badge-warn{background:rgba(234,179,8,.15);color:#a16207}
    .logo-ring{box-shadow:0 10px 28px rgba(2,6,23,.25);border:3px solid rgba(255,255,255,.85)}
    .tick{width:36px;height:36px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(2,6,23,.18)}
  </style>
</head>
<body class="text-slate-800 bg-slate-50">
  <main class="min-h-screen grid grid-cols-1 lg:grid-cols-2">
    <!-- يسار: هوية + عناصر إيضاحية -->
    <section class="hero-bg relative overflow-hidden p-8 lg:p-12 flex items-center">
      <div class="max-w-xl mx-auto text-white">
        <div class="flex items-center gap-4">
          <img src="/PPM-Tabuk/assets/TabukCluster.jpeg" alt="Tabuk Cluster" class="w-20 h-20 rounded-2xl object-cover logo-ring bg-white">
          <div>
            <h1 class="text-2xl font-black tracking-tight">PPM TABUK</h1>
            <p class="text-sm text-blue-50/90">Planned Preventive Maintenance Platform</p>
          </div>
        </div>

        <h2 class="mt-8 text-3xl lg:text-4xl font-black leading-snug">
          Securely manage your assets<br/>with PPM TABUK
        </h2>

        <div class="mt-6 glass p-4">
          <p class="text-base font-extrabold">Biomedical Department</p>
          <p class="text-base font-extrabold -mt-1">Tabuk Cluster</p>
          <p class="mt-2 text-sm text-blue-50/90">Use your <b>Username + Password</b> to sign in. Email is for notifications only.</p>
          <div class="mt-3 flex items-center gap-3">
            <div class="tick">✓</div>
            <span class="text-sm">Fast — Secure — Role-based access</span>
          </div>
        </div>

        <div class="absolute bottom-6 left-8 right-8 flex items-center gap-3 text-xs">
          <span id="connBadge" class="badge badge-warn">⏳ فحص الاتصال...</span>
          <span id="connInfo" class="text-blue-50/90"></span>
        </div>
      </div>
    </section>

    <!-- يمين: فورم الدخول -->
    <section class="flex items-center justify-center p-6 lg:p-10">
      <div class="w-full max-w-md">
        <div class="mb-6">
          <h3 class="text-2xl font-black tracking-tight">Welcome to PPM TABUK</h3>
          <p class="text-sm muted mt-1">سجّل الدخول باستخدام <b>اسم المستخدم + كلمة المرور</b>.</p>
        </div>

        <div class="glass p-6">
          <form id="loginForm" class="space-y-4">
            <div>
              <label class="block text-sm mb-1">اسم المستخدم</label>
              <input id="username" class="inp" placeholder="مثال: owner" autocomplete="username" required>
            </div>
            <div>
              <label class="block text-sm mb-1">كلمة المرور</label>
              <div class="relative">
                <input id="password" type="password" class="inp pr-12" placeholder="••••••••" autocomplete="current-password" required>
                <button type="button" id="togglePwd" class="absolute left-3 top-1/2 -translate-y-1/2 text-sm muted">إظهار</button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="remember" type="checkbox" class="rounded">
                تذكّرني
              </label>
              <a href="#" id="forgot" class="text-sm text-slate-500 hover:underline">نسيت كلمة المرور؟</a>
            </div>

            <button id="submitBtn" class="btn btn-primary w-full" type="submit">تسجيل الدخول</button>
            <div id="msg" class="text-sm"></div>
          </form>

          <div id="ownerAlert" class="hidden mt-4">
            <a href="/PPM-Tabuk/modules/users/bootstrap.html" class="btn btn-soft w-full">👑 إنشاء مالك النظام</a>
          </div>
        </div>

        <p class="mt-6 text-center text-xs text-slate-400">© <span id="year"></span> PPM TABUK</p>
      </div>
    </section>
  </main>

  <!-- منطق الصفحة -->
  <script type="module">
    // مسارات مطلقة
    import { auth, db } from "/PPM-Tabuk/js/firebase.js";
    import { signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const rxUser=/^[a-z0-9_-]{4,24}$/;
    const normalize = u=>(u||"").trim().toLowerCase();
    const synthEmail = u=> `${normalize(u)}@ppm.local`;
    $("year").textContent = new Date().getFullYear();

    // تحويل بعد الدخول
    const DEFAULT_REDIRECT = "/PPM-Tabuk/modules/dashboard/index.html";
    const ROLE_REDIRECTS = {
      "SystemOwner": DEFAULT_REDIRECT,
      "Admin": DEFAULT_REDIRECT,
      "Supervisor": DEFAULT_REDIRECT,
      "DepartmentHead": DEFAULT_REDIRECT,
      "Technician": DEFAULT_REDIRECT,
      "Staff": DEFAULT_REDIRECT,
      "MaintenanceDeptSupervisor": DEFAULT_REDIRECT,
      "WarehouseGuard": DEFAULT_REDIRECT,
      "SystemMonitor": DEFAULT_REDIRECT
    };

    // timeout آمن
    function withTimeout(p, ms=4000){
      return new Promise((res, rej)=>{
        const t=setTimeout(()=>rej(new Error("timeout")), ms);
        p.then(v=>{clearTimeout(t);res(v)}).catch(e=>{clearTimeout(t);rej(e)});
      });
    }

    // فحص الاتصال
    async function checkConnection(){
      const badge=$("connBadge"), info=$("connInfo");
      info.textContent = `projectId: ${auth?.app?.options?.projectId || "?"}`;
      try{
        await withTimeout(getDocs(query(collection(db,"users"), limit(1))), 4000);
        badge.textContent="✅ متصل بـ Firebase";
        badge.classList.remove("badge-warn"); badge.classList.add("badge-ok");
      }catch(e){
        const reason = String(e?.message||"").includes("timeout") ? "انتهت المهلة" : "ممنوع حسب القواعد";
        badge.textContent=`⚠️ SDK متصل، لكن فشل فحص Firestore (${reason})`;
        badge.classList.remove("badge-ok"); badge.classList.add("badge-warn");
        console.warn("Connection probe:",e);
      }
    }
    checkConnection();

    // محاولة رصد وجود SystemOwner (لو القواعد تسمح)
    async function ensureOwnerExists(){
      try{
        const snap=await withTimeout(getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1))), 4000);
        if(snap.size===0) $("ownerAlert").classList.remove("hidden");
      }catch(e){ /* ignore */ }
    }
    ensureOwnerExists();

    // UI
    $("togglePwd").addEventListener("click", ()=>{
      const inp=$("password"); const isPwd=inp.type==="password";
      inp.type=isPwd?"text":"password"; $("togglePwd").textContent=isPwd?"إخفاء":"إظهار";
    });
    const lastU=localStorage.getItem("ppm:lastUsername");
    if(lastU){ $("username").value=lastU; $("remember").checked=true; }
    const setSubmitting=v=>{ const b=$("submitBtn"); b.disabled=v; b.textContent=v?"جاري الدخول...":"تسجيل الدخول"; }

    // دخول
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg=$("msg"); msg.textContent="";
      const username=normalize($("username").value);
      const password=$("password").value;
      const remember=$("remember").checked;

      if(!rxUser.test(username)){ msg.innerHTML='<span class="text-red-600">اسم المستخدم غير صالح.</span>'; return; }
      if(!password){ msg.innerHTML='<span class="text-red-600">أدخل كلمة المرور.</span>'; return; }
      if(remember) localStorage.setItem("ppm:lastUsername", username); else localStorage.removeItem("ppm:lastUsername");

      setSubmitting(true);
      try{
        const cred=await signInWithEmailAndPassword(auth, synthEmail(username), password);
        const uid=cred.user.uid;

        const sref=doc(db,"users",uid);
        const snap=await getDoc(sref);
        if(!snap.exists()){
          msg.innerHTML='<span class="text-red-600">لا توجد وثيقة مستخدم لهذا الحساب.</span>';
          await signOut(auth); setSubmitting(false); return;
        }
        const user=snap.data();

        const status=(user.account&&user.account.status)||(user.isActive?"active":"disabled");
        if(status==="disabled" || user.isActive===false){
          msg.innerHTML='<span class="text-red-600">الحساب معطّل. تواصل مع المسؤول.</span>';
          await signOut(auth); setSubmitting(false); return;
        }

        if(user.account?.forcePwdChange===true){
          sessionStorage.setItem("ppm:pendingUid", uid);
          location.href="/PPM-Tabuk/modules/auth/change-password.html"; return;
        }

        try{
          await updateDoc(sref,{ "account.lastLoginAt": serverTimestamp(), updatedAt: serverTimestamp() });
        }catch(_){}

        const role=String(user.role||"").trim();
        const next=new URLSearchParams(location.search).get("next");
        const dest= next || ROLE_REDIRECTS[role] || DEFAULT_REDIRECT;
        location.href=dest;
      }catch(err){
        console.error(err);
        const code=String(err?.code||"");
        let text="تعذّر تسجيل الدخول.";
        if(code.includes("auth/invalid-credential")||code.includes("auth/wrong-password")) text="اسم المستخدم أو كلمة المرور غير صحيحة.";
        if(code.includes("auth/user-not-found")) text="لا يوجد مستخدم بهذا الاسم.";
        if(code.includes("auth/too-many-requests")) text="محاولات كثيرة. حاول لاحقًا.";
        msg.innerHTML='<span class="text-red-600">'+text+'</span>';
        setSubmitting(false);
      }
    });

    $("forgot").addEventListener("click",(e)=>{
      e.preventDefault();
      alert("لإعادة تعيين كلمة المرور: تواصل مع المسؤول ليولّد كلمة مرور مؤقتة ويجبر تغييرها عند أول دخول.");
    });
  </script>
</body>
</html>
