<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • تسجيل الدخول</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/PPM-Tabuk/assets/favicon.ico"/>
  <style>
    :root{
      --glass-bg: rgba(255,255,255,.75);
      --glass-brd: rgba(255,255,255,.35);
    }
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 100% -10%, #dee9ff 0%, transparent 60%),
        radial-gradient(1000px 700px at -10% 100%, #e7f6ff 0%, transparent 60%),
        linear-gradient(135deg,#eef2ff 0%, #f8fafc 40%, #ecfeff 100%);
    }
    .glass{
      background:var(--glass-bg);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border:1px solid var(--glass-brd);
      border-radius: 20px;
      box-shadow:
        0 10px 30px rgba(2,6,23,.08),
        inset 0 1px 0 rgba(255,255,255,.5);
    }
    .inp{border:1px solid #e5e7eb;border-radius:12px;padding:.85rem 1rem;width:100%;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:12px;padding:.85rem 1rem;font-weight:800}
    .btn-primary{background:#1d4ed8;color:#fff}
    .btn-soft{background:#f1f5f9}
    .muted{color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:999px;font-size:.75rem}
    .badge-ok{background:rgba(16,185,129,.12);color:#047857}
    .badge-warn{background:rgba(234,179,8,.15);color:#a16207}
    .logo-ring{
      box-shadow: 0 8px 24px rgba(2,6,23,.12);
      border:3px solid rgba(255,255,255,.7);
    }
  </style>
</head>
<body class="text-slate-800">
  <!-- زخرفة خلفية -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-24 -right-24 w-[36rem] h-[36rem] rounded-full bg-gradient-to-br from-blue-200/60 to-cyan-100/40 blur-3xl"></div>
    <div class="absolute -bottom-24 -left-24 w-[32rem] h-[32rem] rounded-full bg-gradient-to-tr from-sky-200/60 to-indigo-100/40 blur-3xl"></div>
  </div>

  <main class="min-h-screen">
    <div class="mx-auto max-w-6xl px-4 py-10 grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">

      <!-- Panel: الهوية -->
      <section class="glass p-8 lg:p-10 relative overflow-hidden">
        <div class="absolute -left-16 -bottom-20 w-72 h-72 rounded-full bg-blue-100/40 blur-2xl"></div>
        <div class="relative">
          <div class="flex items-center gap-4">
            <img src="/PPM-Tabuk/assets/TabukCluster.jpeg" alt="Tabuk Cluster"
                 class="w-20 h-20 rounded-2xl object-cover logo-ring bg-white">
            <div>
              <h1 class="text-2xl font-black tracking-tight">PPM TABUK</h1>
              <p class="text-sm muted">Planned Preventive Maintenance Platform</p>
            </div>
          </div>

          <div class="mt-6 leading-6">
            <p class="text-lg font-extrabold">Biomedical Department</p>
            <p class="text-lg font-extrabold -mt-1">Tabuk Cluster</p>
            <p class="mt-3 text-sm text-slate-500">مرحبًا بك. سجّل الدخول باستخدام <b>اسم المستخدم + كلمة المرور</b>. لا نستخدم البريد للدخول.</p>
          </div>

          <div class="mt-6 flex items-center gap-2 text-xs">
            <span id="connBadge" class="badge badge-warn">⏳ فحص الاتصال...</span>
            <span id="connInfo" class="muted"></span>
          </div>

          <div id="ownerAlert" class="hidden mt-4">
            <a href="/PPM-Tabuk/modules/users/bootstrap.html" class="btn btn-soft">👑 إنشاء مالك النظام</a>
          </div>
        </div>
      </section>

      <!-- Panel: فورم الدخول -->
      <section class="glass p-6 lg:p-8">
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">اسم المستخدم</label>
            <input id="username" class="inp" placeholder="مثال: owner" autocomplete="username" required>
          </div>
          <div>
            <label class="block text-sm mb-1">كلمة المرور</label>
            <div class="relative">
              <input id="password" type="password" class="inp pr-12" placeholder="••••••••" autocomplete="current-password" required>
              <button type="button" id="togglePwd" class="absolute left-2 top-1/2 -translate-y-1/2 text-sm muted">إظهار</button>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="remember" type="checkbox" class="rounded">
              تذكّرني
            </label>
            <a href="#" id="forgot" class="text-sm text-slate-500 hover:underline">نسيت كلمة المرور؟</a>
          </div>

          <button id="submitBtn" class="btn btn-primary w-full" type="submit">تسجيل الدخول</button>
          <div id="msg" class="text-sm"></div>
        </form>

        <p class="mt-6 text-center text-xs text-slate-400">© <span id="year"></span> PPM TABUK</p>
      </section>
    </div>
  </main>

  <!-- منطق الصفحة -->
  <script type="module">
    // استخدام مسارات مطلقة
    import { auth, db } from "/PPM-Tabuk/js/firebase.js";
    import { signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== Helpers
    const $ = (id)=>document.getElementById(id);
    const rxUser = /^[a-z0-9_-]{4,24}$/;
    const normalize = (u)=>(u||"").trim().toLowerCase();
    const synthEmail = (u)=> `${normalize(u)}@ppm.local`;
    $("year").textContent = new Date().getFullYear();

    // تحويل بعد الدخول — المطلوب
    const DEFAULT_REDIRECT = "/PPM-Tabuk/modules/dashboard/index.html";

    const ROLE_REDIRECTS = {
      "SystemOwner": DEFAULT_REDIRECT,
      "Admin": DEFAULT_REDIRECT,
      "Supervisor": DEFAULT_REDIRECT,
      "DepartmentHead": DEFAULT_REDIRECT,
      "Technician": DEFAULT_REDIRECT,
      "Staff": DEFAULT_REDIRECT,
      "MaintenanceDeptSupervisor": DEFAULT_REDIRECT,
      "WarehouseGuard": DEFAULT_REDIRECT,
      "SystemMonitor": DEFAULT_REDIRECT
    };

    // timeout آمن لفحص الاتصال
    function withTimeout(promise, ms=4000){
      return new Promise((resolve, reject)=>{
        const t = setTimeout(()=> reject(new Error("timeout")), ms);
        promise.then(v=>{ clearTimeout(t); resolve(v); })
               .catch(e=>{ clearTimeout(t); reject(e); });
      });
    }

    // فحص الاتصال — لا يعلّق
    async function checkConnection(){
      const badge = $("connBadge");
      const info  = $("connInfo");
      const pid = auth?.app?.options?.projectId || "?";
      info.textContent = `projectId: ${pid}`;

      try{
        await withTimeout(getDocs(query(collection(db,"users"), limit(1))), 4000);
        badge.textContent = "✅ متصل بـ Firebase";
        badge.classList.remove("badge-warn");
        badge.classList.add("badge-ok");
      }catch(e){
        const reason = (String(e?.message||"").includes("timeout")) ? "انتهت المهلة" : "ممنوع حسب القواعد";
        badge.textContent = `⚠️ SDK متصل، لكن فشل فحص Firestore (${reason})`;
        badge.classList.remove("badge-ok");
        badge.classList.add("badge-warn");
        console.warn("Connection probe:", e);
      }
    }
    checkConnection();

    // محاولة رصد وجود SystemOwner (إن سمحت القواعد)
    async function ensureOwnerExists(){
      try{
        const snap = await withTimeout(getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1))), 4000);
        if (snap.size === 0) $("ownerAlert").classList.remove("hidden");
      }catch(e){ /* ignore */ }
    }
    ensureOwnerExists();

    // UI: إظهار/إخفاء كلمة المرور + تذكّرني
    $("togglePwd").addEventListener("click", ()=>{
      const inp = $("password");
      const isPwd = inp.type === "password";
      inp.type = isPwd ? "text" : "password";
      $("togglePwd").textContent = isPwd ? "إخفاء" : "إظهار";
    });

    const lastU = localStorage.getItem("ppm:lastUsername");
    if (lastU) { $("username").value = lastU; $("remember").checked = true; }

    function setSubmitting(v){
      const btn = $("submitBtn");
      btn.disabled = v;
      btn.textContent = v ? "جاري الدخول..." : "تسجيل الدخول";
    }

    // الدخول
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = $("msg"); msg.textContent = "";

      const username = normalize($("username").value);
      const password = $("password").value;
      const remember = $("remember").checked;

      if(!rxUser.test(username)){
        msg.innerHTML = '<span class="text-red-600">اسم المستخدم غير صالح (حروف/أرقام/شرطة/شرطة سفلية، 4-24).</span>';
        return;
      }
      if(!password){
        msg.innerHTML = '<span class="text-red-600">أدخل كلمة المرور.</span>';
        return;
      }

      if (remember) localStorage.setItem("ppm:lastUsername", username);
      else localStorage.removeItem("ppm:lastUsername");

      setSubmitting(true);
      try{
        const email = synthEmail(username);
        const cred  = await signInWithEmailAndPassword(auth, email, password);
        const uid   = cred.user.uid;

        const sref = doc(db,"users", uid);
        const snap = await getDoc(sref);
        if(!snap.exists()){
          msg.innerHTML = '<span class="text-red-600">لا توجد وثيقة مستخدم لهذا الحساب. تواصل مع المسؤول.</span>';
          await signOut(auth);
          setSubmitting(false);
          return;
        }
        const user = snap.data();

        const status = (user.account && user.account.status) || (user.isActive ? "active" : "disabled");
        if (status === "disabled" || user.isActive === false){
          msg.innerHTML = '<span class="text-red-600">الحساب معطّل. تواصل مع المسؤول.</span>';
          await signOut(auth);
          setSubmitting(false);
          return;
        }

        if (user.account?.forcePwdChange === true){
          sessionStorage.setItem("ppm:pendingUid", uid);
          location.href = "/PPM-Tabuk/modules/auth/change-password.html";
          return;
        }

        try{
          await updateDoc(sref, { "account.lastLoginAt": serverTimestamp(), updatedAt: serverTimestamp() });
        }catch(_e){ /* ignore if rules block */ }

        const role = String(user.role || "").trim();
        const urlNext = new URLSearchParams(location.search).get("next");
        const dest = urlNext || ROLE_REDIRECTS[role] || DEFAULT_REDIRECT;
        location.href = dest;
      }catch(err){
        console.error(err);
        const code = String(err?.code || "");
        let text = "تعذّر تسجيل الدخول.";
        if (code.includes("auth/invalid-credential") || code.includes("auth/wrong-password")) text = "اسم المستخدم أو كلمة المرور غير صحيحة.";
        if (code.includes("auth/user-not-found")) text = "لا يوجد مستخدم بهذا الاسم.";
        if (code.includes("auth/too-many-requests")) text = "محاولات كثيرة. حاول لاحقًا.";
        $("msg").innerHTML = '<span class="text-red-600">'+text+'</span>';
        setSubmitting(false);
      }
    });

    // نسيت كلمة المرور؟
    $("forgot").addEventListener("click", (e)=>{
      e.preventDefault();
      alert("لإعادة تعيين كلمة المرور: تواصل مع المسؤول ليولّد لك كلمة مرور مؤقتة ويجبر تغييرها عند أول دخول.");
    });
  </script>
</body>
</html>
