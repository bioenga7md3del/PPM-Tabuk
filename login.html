<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK • تسجيل الدخول</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <link rel="icon" href="assets/favicon.ico"/>

  <style>
    :root{
      --bg:#f6f9ff;  --ink:#0f172a;  --muted:#64748b;
      --line:#e2e8f0; --panel:#ffffff;
      --accA:#3b82f6; --accB:#22d3ee;
    }
    html,body{height:100%}
    body{font-family:"Tajawal",ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--ink)}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:0 24px 64px rgba(15,23,42,.10)}
    .inp{width:100%;padding:14px 16px;border-radius:14px;background:#fff;border:1px solid var(--line);color:var(--ink);transition:border-color .15s,box-shadow .15s}
    .inp::placeholder{color:#94a3b8}
    .inp:focus{outline:none;border-color:#bfdbfe;box-shadow:0 0 0 4px rgba(59,130,246,.16)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;border-radius:14px;padding:14px 18px;font-weight:800}
    .btn-primary{background:linear-gradient(90deg,var(--accA),var(--accB));color:#001018}
    .btn-primary:hover{filter:brightness(.98)}

    /* إطار الشعار فوق الكارت */
    .logo-frame{width:96px;height:96px;border-radius:24px;background:#fff;border:1px solid var(--line);
                display:grid;place-items:center;box-shadow:0 16px 40px rgba(15,23,42,.12)}
    .logo-img{width:78px;height:78px;object-fit:contain}
  </style>
</head>
<body>

  <!-- محتوى الصفحة: الشعار ثم النص ثم الكارت في المنتصف -->
  <main class="min-h-screen flex items-center justify-center px-6 py-12">
    <div class="w-full max-w-md">
      <div class="text-center mb-5">
        <div class="logo-frame mx-auto">
          <img src="assets/TabukCluster.jpeg" alt="Tabuk Health Cluster" class="logo-img">
        </div>
        <h1 class="mt-3 text-base text-slate-700">الصيانة الطبية بتجمع تبوك الصحي</h1>
      </div>

      <div class="card p-6">
        <form id="loginForm" class="space-y-5" novalidate>
          <div>
            <label class="block text-sm mb-1 text-slate-700">اسم المستخدم</label>
            <input id="username" class="inp" placeholder="مثال: owner" autocomplete="username" required>
          </div>

          <div>
            <label class="block text-sm mb-1 text-slate-700">كلمة المرور</label>
            <div class="relative">
              <input id="password" type="password" class="inp pe-28" placeholder="••••••••" autocomplete="current-password" required>
              <button type="button" id="togglePwd"
                      class="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-slate-500 hover:text-slate-700">إظهار</button>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input id="remember" type="checkbox" class="rounded"> تذكّرني
            </label>
            <a href="#" id="forgot" class="text-sm text-slate-500 hover:underline">نسيت كلمة المرور؟</a>
          </div>

          <button id="submitBtn" class="btn btn-primary w-full" type="submit">تسجيل الدخول</button>
          <div id="msg" class="text-sm mt-1 text-red-600"></div>
        </form>

        <!-- يظهر فقط لو مفيش SystemOwner -->
        <div id="ownerAlert" class="hidden mt-4">
          <a href="modules/users/bootstrap.html" class="btn w-full" style="background:#eef2f7;color:#0f172a">👑 إنشاء مالك النظام</a>
        </div>
      </div>

      <p class="mt-6 text-center text-xs text-slate-500">© <span id="year"></span> PPM TABUK</p>
    </div>
  </main>

  <!-- منطق الدخول (Firebase) -->
  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const rxUser=/^[a-z0-9_-]{4,24}$/;
    const normalize = u=>(u||"").trim().toLowerCase();
    const synthEmail = u=> `${normalize(u)}@ppm.local`;
    $("year").textContent = new Date().getFullYear();

    const DEFAULT_REDIRECT = "modules/dashboard/index.html";
    const ROLE_REDIRECTS = {
      "SystemOwner": DEFAULT_REDIRECT, "Admin": DEFAULT_REDIRECT, "Supervisor": DEFAULT_REDIRECT,
      "DepartmentHead": DEFAULT_REDIRECT, "Technician": DEFAULT_REDIRECT, "Staff": DEFAULT_REDIRECT,
      "MaintenanceDeptSupervisor": DEFAULT_REDIRECT, "WarehouseGuard": DEFAULT_REDIRECT, "SystemMonitor": DEFAULT_REDIRECT
    };

    function withTimeout(p, ms=4000){
      return new Promise((res, rej)=>{
        const t=setTimeout(()=>rej(new Error("timeout")), ms);
        p.then(v=>{clearTimeout(t);res(v)}).catch(e=>{clearTimeout(t);rej(e)});
      });
    }
    async function ensureOwnerExists(){
      try{
        const snap=await withTimeout(getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1))), 4000);
        if(snap.size===0) $("ownerAlert").classList.remove("hidden");
      }catch(e){}
    }
    ensureOwnerExists();

    // UI
    $("togglePwd").addEventListener("click", ()=>{
      const inp=$("password"); const isPwd=inp.type==="password";
      inp.type=isPwd?"text":"password"; $("togglePwd").textContent=isPwd?"إخفاء":"إظهار";
    });
    const lastU=localStorage.getItem("ppm:lastUsername");
    if(lastU){ $("username").value=lastU; $("remember").checked=true; }
    const setSubmitting=v=>{ const b=$("submitBtn"); b.disabled=v; b.textContent=v?"جاري الدخول...":"تسجيل الدخول"; }

    // دخول
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg=$("msg"); msg.textContent="";
      const username=normalize($("username").value);
      const password=$("password").value;
      const remember=$("remember").checked;

      if(!rxUser.test(username)){ msg.textContent='اسم المستخدم غير صالح.'; return; }
      if(!password){ msg.textContent='أدخل كلمة المرور.'; return; }
      if(remember) localStorage.setItem("ppm:lastUsername", username); else localStorage.removeItem("ppm:lastUsername");

      setSubmitting(true);
      try{
        const cred=await signInWithEmailAndPassword(auth, synthEmail(username), password);
        const uid=cred.user.uid;

        const sref=doc(db,"users",uid);
        const snap=await getDoc(sref);
        if(!snap.exists()){
          msg.textContent='لا توجد وثيقة مستخدم لهذا الحساب.'; await signOut(auth); setSubmitting(false); return;
        }
        const user=snap.data();

        const status=(user.account&&user.account.status)||(user.isActive?"active":"disabled");
        if(status==="disabled" || user.isActive===false){
          msg.textContent='الحساب معطّل. تواصل مع المسؤول.'; await signOut(auth); setSubmitting(false); return;
        }

        if(user.account?.forcePwdChange===true){
          sessionStorage.setItem("ppm:pendingUid", uid);
          location.href=DEFAULT_REDIRECT; return;
        }

        try{ await updateDoc(sref,{ "account.lastLoginAt": serverTimestamp(), updatedAt: serverTimestamp() }); }catch(_){}

        const role=String(user.role||"").trim();
        const next=new URLSearchParams(location.search).get("next");
        const dest= next || ROLE_REDIRECTS[role] || DEFAULT_REDIRECT;
        location.href=dest;
      }catch(err){
        const code=String(err?.code||"");
        let text="تعذّر تسجيل الدخول.";
        if(code.includes("auth/invalid-credential")||code.includes("auth/wrong-password")) text="اسم المستخدم أو كلمة المرور غير صحيحة.";
        if(code.includes("auth/user-not-found")) text="لا يوجد مستخدم بهذا الاسم.";
        if(code.includes("auth/too-many-requests")) text="محاولات كثيرة. حاول لاحقًا.";
        msg.textContent=text; setSubmitting(false);
      }
    });

    document.getElementById("forgot").addEventListener("click",(e)=>{
      e.preventDefault();
      alert("لإعادة تعيين كلمة المرور: تواصل مع المسؤول ليولّد كلمة مرور مؤقتة ويجبر تغييرها عند أول دخول.");
    });
  </script>
</body>
</html>
