<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login • PPM TABUK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#0b1220}
    .card{background:#ffffff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .leftClip{clip-path: inset(0 0 0 0 round 18px 0 0 18px)}
    .brand-img{filter: drop-shadow(0 6px 16px rgba(0,0,0,.15))}
    .notice{position:sticky;top:0;text-align:center;font-weight:800}
    .n-ok{background:#e8fff4;color:#065f46}
    .n-err{background:#ffe8e8;color:#7f1d1d}
    .n-info{background:#e8f1ff;color:#1e3a8a}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 py-8">

  <!-- إشعار -->
  <div id="notice" class="notice n-info w-full max-w-5xl mx-auto mb-4 rounded-lg py-2 hidden"></div>

  <main class="card w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 overflow-hidden">
    <!-- يسار -->
    <aside class="leftClip hidden lg:flex flex-col items-center justify-center gap-8 bg-white P-10 text-black">
      <div class="text-center leading-relaxed">
        <div class="text-2xl font-extrabold tracking-wide">Welcome to PPM TABUK</div>
        <div class="mt-2 text-base opacity-90 font-semibold">إدارة الصيانة — قسم الأجهزة الطبية</div>
      </div>
      <div class="flex flex-col items-center gap-6">
        <img src="assets/TabukCluster.jpeg" alt="Tabuk Health Cluster" class="brand-img h-20 object-contain"/>
        <img src="assets/FGC.jpeg" alt="First Gulf Company" class="brand-img h-16 object-contain"/>
      </div>
    </aside>

    <!-- يمين -->
    <section class="p-8 md:p-12">
      <div class="max-w-md mx-auto">
        <!-- Tabs -->
        <div class="flex gap-2 mb-6">
          <button id="tabLogin"  class="px-4 py-2 rounded-lg font-bold bg-sky-500 text-white">تسجيل الدخول</button>
          <button id="tabSignup" class="px-4 py-2 rounded-lg font-bold bg-slate-200 text-slate-800">إضافة مستخدم جديد</button>
        </div>

        <!-- Login -->
        <div id="loginPane">
          <label class="block text-slate-700 font-semibold mb-2" for="email">Email</label>
          <input id="email" type="email" placeholder="example@domain.com"
                 class="w-full mb-4 px-4 py-3 rounded-lg border border-slate-300 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-sky-500"/>

          <div class="flex items-center justify-between">
            <label class="block text-slate-700 font-semibold mb-2" for="password">Password</label>
            <button id="btnReset" class="text-sky-600 hover:underline text-sm">Forgot Password ?</button>
          </div>
          <input id="password" type="password" placeholder="••••••••"
                 class="w-full mb-6 px-4 py-3 rounded-lg border border-slate-300 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-sky-500"/>

          <button id="btnLogin"
                  class="w-full py-3 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-bold transition">
            Login
          </button>
        </div>

        <!-- Signup -->
        <div id="signupPane" class="hidden">
          <label class="block text-slate-700 font-semibold mb-2" for="s_name">الاسم</label>
          <input id="s_name" type="text" placeholder="الاسم الكامل"
                 class="w-full mb-4 px-4 py-3 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-sky-500"/>

          <label class="block text-slate-700 font-semibold mb-2" for="s_email">Email</label>
          <input id="s_email" type="email" placeholder="user@domain.com"
                 class="w-full mb-4 px-4 py-3 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-sky-500"/>

          <label class="block text-slate-700 font-semibold mb-2" for="s_password">Password</label>
          <input id="s_password" type="password" placeholder="••••••••"
                 class="w-full mb-6 px-4 py-3 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-sky-500"/>

          <button id="btnSignup"
                  class="w-full py-3 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-bold transition">
            إنشاء حساب جديد
          </button>

          <p class="mt-3 text-sm text-slate-500">
            * يتم إنشاؤه كـ <strong>viewer</strong> ويمكن ترقيته من "إدارة المستخدمين".
          </p>
        </div>

        <div class="mt-8 text-center text-slate-500 text-sm">
          © <span id="year"></span> PPM TABUK
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail,
             onAuthStateChanged, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, setDoc, doc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
      authDomain: "pmqrtabuk.firebaseapp.com",
      projectId: "pmqrtabuk",
      storageBucket: "pmqrtabuk.firebasestorage.app",
      messagingSenderId: "305570616285",
      appId: "1:305570616285:web:4f6839fd08b8b5aa131c34"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = s => document.querySelector(s);
    const notice = (msg, type='info')=>{
      const n = $('#notice');
      n.textContent = msg;
      n.className = 'notice ' + (type==='ok'?'n-ok':type==='error'?'n-err':'n-info');
      n.classList.remove('hidden');
    };

    // تبويب
    $('#tabLogin').onclick = ()=>{
      $('#loginPane').classList.remove('hidden');
      $('#signupPane').classList.add('hidden');
    };
    $('#tabSignup').onclick = ()=>{
      $('#signupPane').classList.remove('hidden');
      $('#loginPane').classList.add('hidden');
    };

    $('#year').textContent = new Date().getFullYear();

    // لو مسجل دخول بالفعل
    onAuthStateChanged(auth, (u)=>{ if(u) window.location.href='index.html'; });

    // Login
    $('#btnLogin').addEventListener('click', async ()=>{
      const email = $('#email').value.trim();
      const pass  = $('#password').value;
      if(!email || !pass){ notice('من فضلك أدخل البريد وكلمة المرور','error'); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        notice('تم تسجيل الدخول ✅','ok');
        window.location.href = 'index.html';
      }catch(e){ notice('فشل: '+e.message,'error'); }
    });

    // Reset
    $('#btnReset').addEventListener('click', async ()=>{
      const email = $('#email').value.trim();
      if(!email){ notice('أدخل البريد','error'); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        notice('تم إرسال رابط الاستعادة ✅','ok');
      }catch(e){ notice('خطأ: '+e.message,'error'); }
    });

    // Signup
    $('#btnSignup').addEventListener('click', async ()=>{
      const name  = $('#s_name').value.trim();
      const email = $('#s_email').value.trim();
      const pass  = $('#s_password').value;
      if(!name || !email || !pass){ notice('أكمل البيانات','error'); return; }

      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });

        await setDoc(doc(db,'users', cred.user.uid), {
          name, email, role:'viewer', sites:[], departments:[], createdAt: serverTimestamp()
        });

        const snap = await getDoc(doc(db,'users', cred.user.uid));
        if(snap.exists()){
          notice('تم إنشاء الحساب ✅','ok');
          window.location.href='index.html';
        }else{
          notice('تم إنشاء الحساب في Authentication لكن لم يضاف في Firestore ❌','error');
        }
      }catch(e){ notice('فشل التسجيل: '+e.message,'error'); }
    });
  </script>
</body>
</html>
