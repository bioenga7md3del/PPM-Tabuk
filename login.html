<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK â€¢ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../css/theme-light.css">
  <script src="../../js/theme.js" defer></script>
  <link rel="icon" href="/PPM-Tabuk/assets/favicon.ico"/>
  <style>
    body{background:#f8fafc;color:#0f172a}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 28px rgba(2,6,23,.06)}
    .inp{border:1px solid #e5e7eb;border-radius:12px;padding:.75rem 1rem;width:100%}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:12px;padding:.75rem 1rem;font-weight:700}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-soft{background:#eef2f7}
    .muted{color:#64748b}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .6rem;border-radius:999px;font-size:.75rem}
    .badge-ok{background:rgba(16,185,129,.12);color:#047857}
    .badge-err{background:rgba(239,68,68,.12);color:#b91c1c}
  </style>
</head>
<body>
  <main class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <!-- Ø´Ø¹Ø§Ø±/Ù‡ÙŠØ¯Ø± Ø¨Ø³ÙŠØ· -->
      <div class="text-center mb-6">
        <img src="/PPM-Tabuk/assets/logo.svg" alt="PPM TABUK" class="inline-block h-12 mb-2" onerror="this.style.display='none'">
        <h1 class="text-xl font-extrabold tracking-tight">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p class="text-sm muted">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ <b>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</b>. (Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„)</p>
      </div>

      <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
      <div class="card p-3 mb-4">
        <div id="connBadge" class="badge">â³ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        <div id="connInfo" class="text-xs mt-2 muted"></div>
      </div>

      <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
      <div id="ownerAlert" class="card p-3 mb-4 hidden">
        <div class="text-sm">
          Ù„Ø§ ÙŠÙˆØ¬Ø¯ <b>System Owner</b> Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹.
        </div>
        <a href="/PPM-Tabuk/modules/users/bootstrap.html" class="btn btn-soft mt-2 w-full">ğŸ‘‘ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
      </div>

      <!-- ÙÙˆØ±Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div class="card p-5">
        <form id="loginForm" class="space-y-3">
          <div>
            <label class="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input id="username" class="inp" placeholder="Ù…Ø«Ø§Ù„: owner" autocomplete="username" required>
          </div>
          <div>
            <label class="block text-sm mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="relative">
              <input id="password" type="password" class="inp pr-12" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" required>
              <button type="button" id="togglePwd" class="absolute left-2 top-1/2 -translate-y-1/2 text-sm muted">Ø¥Ø¸Ù‡Ø§Ø±</button>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="remember" type="checkbox" class="rounded">
              ØªØ°ÙƒÙ‘Ø±Ù†ÙŠ
            </label>
            <a href="#" id="forgot" class="text-sm text-slate-500 hover:underline">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
          </div>
          <button class="btn btn-primary w-full" id="submitBtn" type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <div id="msg" class="text-sm mt-2"></div>
        </form>
      </div>

      <!-- ÙÙˆØªØ± Ø¨Ø³ÙŠØ· -->
      <p class="mt-4 text-center text-xs text-slate-400">Â© <span id="year"></span> PPM TABUK</p>
    </div>
  </main>

  <script type="module">
    import { auth, db } from "../../js/firebase.js";
    import { signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== Helpers
    const $ = (id)=>document.getElementById(id);
    const rxUser = /^[a-z0-9_-]{4,24}$/;
    const normalize = (u)=>(u||"").trim().toLowerCase();
    const synthEmail = (u)=> `${normalize(u)}@ppm.local`;
    $("year").textContent = new Date().getFullYear();

    const ROLE_REDIRECTS = {
      "SystemOwner": "/PPM-Tabuk/index.html",
      "Admin": "/PPM-Tabuk/index.html",
      "Supervisor": "/PPM-Tabuk/index.html",
      "DepartmentHead": "/PPM-Tabuk/index.html",
      "Technician": "/PPM-Tabuk/index.html",
      "Staff": "/PPM-Tabuk/index.html",
      "MaintenanceDeptSupervisor": "/PPM-Tabuk/index.html",
      "WarehouseGuard": "/PPM-Tabuk/index.html",
      "SystemMonitor": "/PPM-Tabuk/index.html"
    };

    // ===== util: timeout wrapper ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    function withTimeout(promise, ms=4000){
      return new Promise((resolve, reject)=>{
        const t = setTimeout(()=> reject(new Error("timeout")), ms);
        promise.then(v=>{ clearTimeout(t); resolve(v); })
               .catch(e=>{ clearTimeout(t); reject(e); });
      });
    }

    // ===== Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ø§ ØªØ¹Ù„Ù‚ Ø£Ø¨Ø¯Ø§Ù‹)
    async function checkConnection(){
      const badge = $("connBadge");
      const info  = $("connInfo");

      // Ù„Ùˆ Ø§Ù„Ù€ SDK Ù…Ø­Ù…Ù‘Ù„ Ø£ØµÙ„Ø§Ù‹ØŒ Ù†Ø¹Ø±Ø¶ projectId ÙÙˆØ±Ù‹Ø§
      const pid = auth?.app?.options?.projectId || "?";
      info.textContent = `projectId: ${pid}`;

      try{
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø±ÙŠØ¹Ø© ØªÙ‚Ø±Ø£ Ø£ÙˆÙ„ Ù…Ø³ØªÙ†Ø¯ (Ù‚Ø¯ ØªÙÙ…Ù†Ø¹ Ø¨Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯)
        await withTimeout(getDocs(query(collection(db,"users"), limit(1))), 4000);
        badge.classList.remove("badge-err"); badge.classList.add("badge-ok");
        badge.textContent = "âœ… Ù…ØªØµÙ„ Ø¨Ù€ Firebase";
      }catch(e){
        // Ø¥Ù…Ø§ timeout Ø£Ùˆ PERMISSION_DENIED â†’ Ø¯Ù‡ Ø·Ø¨ÙŠØ¹ÙŠ Ù„ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ†
        badge.classList.remove("badge-ok"); badge.classList.add("badge-err");
        const reason = (String(e?.message||"").includes("timeout")) ? "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©" : "Ù…Ù…Ù†ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯";
        badge.textContent = `âš ï¸ SDK Ù…ØªØµÙ„ØŒ Ù„ÙƒÙ† ÙØ´Ù„ ÙØ­Øµ Firestore (${reason})`;
        // Ù†ÙƒÙ…Ù‘Ù„ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ø¯ÙŠ â€” Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø´ Ù‡ØªÙ‚Ù
        console.warn("Connection check warning:", e);
      }
    }
    checkConnection();

    // ===== ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùˆ Ù…ÙÙŠØ´ SystemOwner (Ù†Ø­Ø§ÙˆÙ„ Ø¨Ù‡Ø¯ÙˆØ¡ØŒ ÙˆÙ†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£ Ù„Ùˆ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªÙ…Ù†Ø¹)
    async function ensureOwnerExists(){
      try{
        const snap = await withTimeout(getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1))), 4000);
        if (snap.size === 0) $("ownerAlert").classList.remove("hidden");
      }catch(e){
        // Ù„Ùˆ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¯ÙˆÙ† Auth Ø£Ùˆ timeout â€” Ù†Ø³ÙŠØ¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø®ÙÙŠ
        console.info("Owner probe skipped:", e?.code || e?.message || e);
      }
    }
    ensureOwnerExists();

    // ===== UI: Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± + ØªØ°ÙƒÙ‘Ø±Ù†ÙŠ
    $("togglePwd").addEventListener("click", ()=>{
      const inp = $("password");
      const isPwd = inp.type === "password";
      inp.type = isPwd ? "text" : "password";
      $("togglePwd").textContent = isPwd ? "Ø¥Ø®ÙØ§Ø¡" : "Ø¥Ø¸Ù‡Ø§Ø±";
    });

    // Restore last username
    const lastU = localStorage.getItem("ppm:lastUsername");
    if (lastU) { $("username").value = lastU; $("remember").checked = true; }

    function setSubmitting(v){
      const btn = $("submitBtn");
      btn.disabled = v;
      btn.textContent = v ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„..." : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
    }

    // ===== Ø§Ù„Ø¯Ø®ÙˆÙ„
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = $("msg"); msg.textContent = "";

      const username = normalize($("username").value);
      const password = $("password").value;
      const remember = $("remember").checked;

      if(!rxUser.test(username)){
        msg.innerHTML = '<span class="text-red-600">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­ (Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù…/Ø´Ø±Ø·Ø©/Ø´Ø±Ø·Ø© Ø³ÙÙ„ÙŠØ©ØŒ 4-24).</span>';
        return;
      }
      if(!password){
        msg.innerHTML = '<span class="text-red-600">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</span>';
        return;
      }

      if (remember) localStorage.setItem("ppm:lastUsername", username);
      else localStorage.removeItem("ppm:lastUsername");

      setSubmitting(true);
      try{
        // 1) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ
        const email = synthEmail(username);
        const cred  = await signInWithEmailAndPassword(auth, email, password);
        const uid   = cred.user.uid;

        // 2) Ù‚Ø±Ø§Ø¡Ø© ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const sref = doc(db,"users", uid);
        const snap = await getDoc(sref);
        if(!snap.exists()){
          msg.innerHTML = '<span class="text-red-600">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ«ÙŠÙ‚Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</span>';
          await signOut(auth);
          setSubmitting(false);
          return;
        }
        const user = snap.data();

        // 3) ØªØ­Ù‚Ù‘Ù‚ Ø§Ù„Ø­Ø§Ù„Ø©
        const status = (user.account && user.account.status) || (user.isActive ? "active" : "disabled");
        if (status === "disabled" || user.isActive === false){
          msg.innerHTML = '<span class="text-red-600">Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù‘Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</span>';
          await signOut(auth);
          setSubmitting(false);
          return;
        }

        // 4) Ø¥Ø¬Ø¨Ø§Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        if (user.account?.forcePwdChange === true){
          sessionStorage.setItem("ppm:pendingUid", uid);
          location.href = "/PPM-Tabuk/modules/auth/change-password.html";
          return;
        }

        // 5) ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        try{
          await updateDoc(sref, { "account.lastLoginAt": serverTimestamp(), updatedAt: serverTimestamp() });
        }catch(_e){ /* ØªØ¬Ø§Ù‡Ù„ Ù„Ùˆ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªÙ…Ù†Ø¹ */ }

        // 6) ØªÙˆØ¬ÙŠÙ‡
        const role = String(user.role || "").trim();
        const dest = ROLE_REDIRECTS[role] || "/PPM-Tabuk/index.html";
        location.href = dest;
      }catch(err){
        console.error(err);
        const code = String(err?.code || "");
        let text = "ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        if (code.includes("auth/invalid-credential") || code.includes("auth/wrong-password")) text = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        if (code.includes("auth/user-not-found")) text = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….";
        if (code.includes("auth/too-many-requests")) text = "Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.";
        $("msg").innerHTML = '<span class="text-red-600">'+text+'</span>';
        setSubmitting(false);
      }
    });

    // ===== Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ
    $("forgot").addEventListener("click", (e)=>{
      e.preventDefault();
      alert("Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„ÙŠÙˆÙ„Ù‘Ø¯ Ù„Ùƒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© ÙˆÙŠØ¬Ø¨Ø± ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„.");
    });
  </script>
</body>
</html>
