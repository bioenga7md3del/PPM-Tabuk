<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PPM TABUK â€¢ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ø¶Ø­ -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <!-- ÙØ§ÙÙŠÙƒÙˆÙ† (Ù†Ø³Ø¨ÙŠ) -->
  <link rel="icon" href="assets/favicon.ico"/>

  <style>
    :root{
      --ink:#0f172a;            /* Ù†Øµ Ø¯Ø§ÙƒÙ† */
      --muted:#475569;          /* Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ */
      --panel:#ffffff;          /* Ø¨Ø§Ù†Ù„Ø² ÙØ§ØªØ­Ø© */
      --line:#e2e8f0;           /* Ø­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ© */
      --bglight:#f5f9ff;        /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© */
      --grad1:#eaf2ff;          /* Ø¬Ø±Ø§Ø¯ÙŠØ§Ù†Øª Ø®Ù„ÙÙŠØ© */
      --grad2:#f8fbff;
      --blueA:#3b82f6;          /* Ø£Ø²Ø±Ù‚ Ø±Ø¦ÙŠØ³ÙŠ */
      --blueB:#22d3ee;          /* Ø³Ù…Ø§ÙˆÙŠ Ù„Ù„ØªØ¯Ø±Ù‘Ø¬ */
    }
    html,body{height:100%}
    body{
      font-family:"Tajawal", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 10% -10%, rgba(59,130,246,.10), transparent 60%),
                  radial-gradient(900px 600px at 110% 120%, rgba(34,211,238,.10), transparent 60%),
                  linear-gradient(180deg, var(--grad1), var(--grad2));
      overflow-x:hidden;
    }

    /* ÙˆÙˆØªØ±Ù…Ø§Ø±Ùƒ Ù†Ø§Ø¹Ù…Ø© Ø¬Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„ÙÙˆØ±Ù… */
    .wm{
      position:fixed; inset:0; pointer-events:none; z-index:-1;
    }
    .wm::after{
      content:""; position:absolute; right:5vw; top:20vh;
      width:min(60vmin,620px); height:min(60vmin,620px);
      background:url("assets/TabukCluster.jpeg") center/contain no-repeat;
      opacity:.04; filter:grayscale(100%) contrast(110%);
    }

    /* ÙƒØ§Ø±Ø¯ Ø²Ø¬Ø§Ø¬ÙŠ Ø®ÙÙŠÙŠÙ â€“ ÙØ§ØªØ­ */
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,.08);
    }

    .inp{
      width:100%; padding:14px 16px; border-radius:14px;
      background:#fff; border:1px solid var(--line); color:var(--ink);
    }
    .inp::placeholder{color:#94a3b8}
    .inp:focus{outline:none; border-color:#bfdbfe; box-shadow:0 0 0 4px rgba(59,130,246,.16)}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.6rem; border-radius:14px;
         padding:14px 18px; font-weight:800}
    .btn-primary{background:linear-gradient(90deg, var(--blueA), var(--blueB)); color:#001018}
    .btn-primary:hover{filter:brightness(.98)}
    .muted{color:var(--muted)}

    /* Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
    .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .7rem;border-radius:999px;font-size:.78rem}
    .ok{background:rgba(16,185,129,.12); color:#047857; border:1px solid #bbf7d0}
    .warn{background:rgba(234,179,8,.12);  color:#92400e; border:1px solid #fde68a}

    /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡ÙŠØ±Ùˆ */
    .logo-frame{
      width:92px;height:92px;border-radius:22px;
      background:#ffffff; border:1px solid var(--line); display:grid; place-items:center;
      box-shadow:0 14px 36px rgba(15,23,42,.12);
    }
    .feat{display:flex; align-items:center; gap:.6rem}
    .tick{width:18px;height:18px;border-radius:999px;background:#10b981; color:#fff; display:grid; place-items:center; font-size:12px}
  </style>
</head>
<body>

  <!-- ÙˆÙˆØªØ±Ù…Ø§Ø±Ùƒ -->
  <div class="wm" aria-hidden="true"></div>

  <main class="min-h-screen grid grid-cols-1 lg:grid-cols-2">
    <!-- ÙŠØ³Ø§Ø±: Hero ÙØ§ØªØ­ ÙˆÙ…Ø­ØªØ±Ù -->
    <section class="order-2 lg:order-1 px-8 lg:px-14 py-12 flex items-center">
      <div class="max-w-2xl">
        <div class="flex items-center gap-5">
          <div class="logo-frame">
            <img src="assets/TabukCluster.jpeg" alt="Tabuk Cluster" style="width:72px;height:72px;object-fit:contain"/>
          </div>
          <div>
            <h1 class="text-3xl font-extrabold tracking-tight">PPM TABUK Cluster</h1>
            <p class="text-sm muted -mt-1">Medical Maintenance Platform</p>
          </div>
        </div>

        <h2 class="mt-8 text-4xl xl:text-5xl font-black leading-[1.15] text-slate-800">
          Securely manage your assets<br>
          with <span class="underline decoration-slate-300">PPM TABUK</span>
        </h2>

        <!-- ÙƒØ§Ø±Ø¯ ØªØ¹Ø±ÙŠÙÙŠ Ø®ÙÙŠÙ + Ù…Ø²Ø§ÙŠØ§ -->
        <div class="mt-8 grid gap-4">
          <div class="card p-5">
            <p class="text-lg font-extrabold text-slate-800">Biomedical Department</p>
            <p class="text-lg font-extrabold -mt-1 text-slate-800">Tabuk Cluster</p>
            <p class="mt-2 text-sm muted">Use your <b>Username + Password</b> to sign in. Email is for notifications only.</p>
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
              <div class="feat"><span class="tick">âœ“</span><span>Role-based access</span></div>
              <div class="feat"><span class="tick">âœ“</span><span>Secure</span></div>
              <div class="feat"><span class="tick">âœ“</span><span>Fast</span></div>
            </div>
          </div>

          <div class="flex items-center gap-3 text-xs">
            <span id="connBadge" class="badge warn">â³ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
            <span id="connInfo" class="muted"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- ÙŠÙ…ÙŠÙ†: ÙÙˆØ±Ù… Ø£Ø®Ù ÙˆØ£ÙˆØ¶Ø­ -->
    <section class="order-1 lg:order-2 flex items-center justify-center px-6 lg:px-10 py-12">
      <div class="w-full max-w-md">
        <div class="mb-6 text-center lg:text-right">
          <h3 class="text-2xl font-black tracking-tight text-slate-800">Welcome to PPM TABUK</h3>
          <p class="text-sm muted mt-1">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… <b>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</b>.</p>
        </div>

        <div class="card p-6">
          <form id="loginForm" class="space-y-5">
            <div>
              <label class="block text-sm mb-1 text-slate-700">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
              <input id="username" class="inp" placeholder="Ù…Ø«Ø§Ù„: owner" autocomplete="username" required>
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <div class="relative">
                <input id="password" type="password" class="inp pe-28" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" required>
                <button type="button" id="togglePwd"
                        class="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-slate-500 hover:text-slate-700">Ø¥Ø¸Ù‡Ø§Ø±</button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                <input id="remember" type="checkbox" class="rounded"> ØªØ°ÙƒÙ‘Ø±Ù†ÙŠ
              </label>
              <a href="#" id="forgot" class="text-sm text-slate-500 hover:underline">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
            </div>

            <button id="submitBtn" class="btn btn-primary w-full" type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div id="msg" class="text-sm mt-1 text-red-600"></div>
          </form>

          <div id="ownerAlert" class="hidden mt-4">
            <a href="modules/users/bootstrap.html" class="btn w-full" style="background:#eef2f7; color:#0f172a">ğŸ‘‘ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
          </div>
        </div>

        <p class="mt-6 text-center text-xs text-slate-500">Â© <span id="year"></span> PPM TABUK</p>
      </div>
    </section>
  </main>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø©: Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ù†Ø³Ø¨ÙŠØ© -->
  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const rxUser=/^[a-z0-9_-]{4,24}$/;
    const normalize = u=>(u||"").trim().toLowerCase();
    const synthEmail = u=> `${normalize(u)}@ppm.local`;
    $("year").textContent = new Date().getFullYear();

    const DEFAULT_REDIRECT = "modules/dashboard/index.html";
    const ROLE_REDIRECTS = {
      "SystemOwner": DEFAULT_REDIRECT, "Admin": DEFAULT_REDIRECT, "Supervisor": DEFAULT_REDIRECT,
      "DepartmentHead": DEFAULT_REDIRECT, "Technician": DEFAULT_REDIRECT, "Staff": DEFAULT_REDIRECT,
      "MaintenanceDeptSupervisor": DEFAULT_REDIRECT, "WarehouseGuard": DEFAULT_REDIRECT, "SystemMonitor": DEFAULT_REDIRECT
    };

    function withTimeout(p, ms=4000){
      return new Promise((res, rej)=>{
        const t=setTimeout(()=>rej(new Error("timeout")), ms);
        p.then(v=>{clearTimeout(t);res(v)}).catch(e=>{clearTimeout(t);rej(e)});
      });
    }

    async function checkConnection(){
      const badge=$("connBadge"), info=$("connInfo");
      info.textContent = `projectId: ${auth?.app?.options?.projectId || "?"}`;
      try{
        await withTimeout(getDocs(query(collection(db,"users"), limit(1))), 4000);
        badge.textContent="Ù…ØªØµÙ„ Ø¨Ù€ Firebase âœ“";
        badge.classList.remove("warn"); badge.classList.add("ok");
      }catch(e){
        const reason = String(e?.message||"").includes("timeout") ? "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©" : "Ù…Ù…Ù†ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯";
        badge.textContent=`SDK Ù…ØªØµÙ„ØŒ Ù„ÙƒÙ† ÙØ´Ù„ ÙØ­Øµ Firestore (${reason})`;
        badge.classList.remove("ok"); badge.classList.add("warn");
      }
    }
    checkConnection();

    async function ensureOwnerExists(){
      try{
        const snap=await withTimeout(getDocs(query(collection(db,"users"), where("role","==","SystemOwner"), limit(1))), 4000);
        if(snap.size===0) $("ownerAlert").classList.remove("hidden");
      }catch(e){}
    }
    ensureOwnerExists();

    // UI
    $("togglePwd").addEventListener("click", ()=>{
      const inp=$("password"); const isPwd=inp.type==="password";
      inp.type=isPwd?"text":"password"; $("togglePwd").textContent=isPwd?"Ø¥Ø®ÙØ§Ø¡":"Ø¥Ø¸Ù‡Ø§Ø±";
    });
    const lastU=localStorage.getItem("ppm:lastUsername");
    if(lastU){ $("username").value=lastU; $("remember").checked=true; }
    const setSubmitting=v=>{ const b=$("submitBtn"); b.disabled=v; b.textContent=v?"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...":"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"; }

    // Ø¯Ø®ÙˆÙ„
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg=$("msg"); msg.textContent="";
      const username=normalize($("username").value);
      const password=$("password").value;
      const remember=$("remember").checked;

      if(!rxUser.test(username)){ msg.textContent='Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­.'; return; }
      if(!password){ msg.textContent='Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.'; return; }
      if(remember) localStorage.setItem("ppm:lastUsername", username); else localStorage.removeItem("ppm:lastUsername");

      setSubmitting(true);
      try{
        const cred=await signInWithEmailAndPassword(auth, synthEmail(username), password);
        const uid=cred.user.uid;

        const sref=doc(db,"users",uid);
        const snap=await getDoc(sref);
        if(!snap.exists()){
          msg.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ«ÙŠÙ‚Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨.'; await signOut(auth); setSubmitting(false); return;
        }
        const user=snap.data();

        const status=(user.account&&user.account.status)||(user.isActive?"active":"disabled");
        if(status==="disabled" || user.isActive===false){
          msg.textContent='Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù‘Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.'; await signOut(auth); setSubmitting(false); return;
        }

        if(user.account?.forcePwdChange===true){
          sessionStorage.setItem("ppm:pendingUid", uid);
          location.href=DEFAULT_REDIRECT; return;
        }

        try{ await updateDoc(sref,{ "account.lastLoginAt": serverTimestamp(), updatedAt: serverTimestamp() }); }catch(_){}

        const role=String(user.role||"").trim();
        const next=new URLSearchParams(location.search).get("next");
        const dest= next || ROLE_REDIRECTS[role] || DEFAULT_REDIRECT;
        location.href=dest;
      }catch(err){
        const code=String(err?.code||"");
        let text="ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        if(code.includes("auth/invalid-credential")||code.includes("auth/wrong-password")) text="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        if(code.includes("auth/user-not-found")) text="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….";
        if(code.includes("auth/too-many-requests")) text="Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.";
        msg.textContent=text; setSubmitting(false);
      }
    });

    document.getElementById("forgot").addEventListener("click",(e)=>{
      e.preventDefault();
      alert("Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„ÙŠÙˆÙ„Ù‘Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© ÙˆÙŠØ¬Ø¨Ø± ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„.");
    });
  </script>
</body>
</html>
